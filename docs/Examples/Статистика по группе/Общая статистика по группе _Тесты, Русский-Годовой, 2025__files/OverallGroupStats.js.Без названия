class OverallGroupStatsUi {

    constructor() {
        const that = this;
        $(() => {
            that.initialise();
        })
    }

    initialise() {
        $(".workout-cont").click(this.toggleFold.bind(this))
        $(".workout-cont .collapse-btn").click(this.fold.bind(this));
    }

    toggleFold(e) {
        let $el = $(e.target);
        if (!$el.hasClass('workout-cont')) {
            $el = $el.closest('.workout-cont');
        }
        if (!$el.hasClass("unfolded")) {
            this.unfold($el);
        }
    }

    fold(e) {
        e.stopPropagation();
        let $el = $(e.target).closest('.workout-cont');
        this.foldEl($el);
        return true;
    }

    foldEl($el) {
        let parent = $el.parent()[0];
        let rect = parent.getBoundingClientRect();
        let rootRect = $el.closest('.workouts-grid')[0].getBoundingClientRect();
        $el.css({
            left: rect.left - rootRect.left,
            top: rect.top - rootRect.top,
            'max-width': rect.width,
            'max-height': rect.height,
            'box-shadow': 'unset',
            'z-index': 0,
        });


        $el.one('transitionend', function () {
            $el.css('transition', 'unset');
            $el.removeClass('unfolded');
            $el.find('.workout-content-long').addClass('hidden');
            $el.css({
                left: '',
                top: '',
                'max-width': '',
                'max-height': '',
                'box-shadow': '',
                'z-index': '',
            });
        });
    }

    foldAll() {
        $(".workout-cont.unfolded").each((idx, el) => {
            this.foldEl($(el));
        });

    }

    async unfold($el) {
        let $extraContents = $el.find('.workout-content-long');
        if ($extraContents.length < 1)
            return;

        this.foldAll();

        let rect = $el[0].getBoundingClientRect();

        let rootRect = $el.closest('.workouts-grid')[0].getBoundingClientRect();
        let rect2 = this.measure($el, rootRect)
        $el.addClass('unfolded');
        $extraContents.removeClass('hidden');
        $el.css('transition', 'unset');
        $el.css({
            left: rect.left - rootRect.left,
            top: rect.top - rootRect.top,
            'max-width': rect.width,
            'max-height': rect.height,
        })
        $el.css('transition', '');

        await bUtil.awaitAnimationFrame();

        let newLeft = (rootRect.width - rect2.width) / 2;
        newLeft = Math.max(0, newLeft);
        $el.css({
            left: newLeft,
            top: 0,
            'max-width': rootRect.width,
            'max-height': rect2.height,
        })
    }

    measure($el, rootRect) {
        let $parent = $el.parent();
        $el = $el.clone();
        $el.css('transition', 'unset');
        $el.css({
            position: 'absolute',
            'max-width': rootRect.width,
            left: 0,
            top: 0,
            visibility: 'hidden'
        });
        $el.find('.workout-content-long').removeClass('hidden');
        $parent.append($el);
        let result = $el[0].getBoundingClientRect();
        $el.remove();
        return result;
    }
}
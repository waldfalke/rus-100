class GroupUser {}

class GroupUsersReply extends ApiReply {}

class UserListDTO {
    constructor() {
        this.users = [];
    }
    addUser(userId = undefined, memberId = undefined) {
        if (userId || memberId) {
            this.users.push({
                userId: userId,
                memberId: memberId
            });
        }
    }
    reset() {
        this.users = [];
    }
}

class ToggleUserActiveDTO extends UserListDTO {
    constructor(activate) {
        super();
        this.active = activate;
    }
}

class ToggleUserActiveUseCase extends JsonApiUseCase {
    constructor(activate) {
        super("put", "/api/teacher/toggleStudentActive/", new ToggleUserActiveDTO(activate));
    }
    addUser(userId = undefined, memberId = undefined) {
        this.dto.addUser(userId, memberId);
        return this;
    }
}

class GroupUsersController extends ItemListControllerBase {
    constructor(groupId, templateEl, $container) {
        super([ user => user.id, user => user.memberId, user => user.email ], templateEl, $container);
        this.$container = $container;
        this.groupId = groupId;
    }
    runNamedAction(action, $elements) {
        if (!$elements || $elements.length === 0) {
            $elements = this.getSelectedRows();
        }
        switch (action) {
          case "deactivate":
            this.runUseCaseForElements($elements, new ToggleUserActiveUseCase(false));
            break;

          case "activate":
            this.runUseCaseForElements($elements, new ToggleUserActiveUseCase(true));
            break;

          case "move":
            this.moveUsers($elements);
            break;

          case "resetProgress":
            this.runCleanupResultsUseCase($elements);
            break;

          case "delete":
            this.deleteUsersUseCase($elements);
            break;

          case "select-all":
            this.$container.find(".item-select").prop("checked", true);
            break;

          case "deselect-all":
            $elements.find(".item-select").prop("checked", false);
            break;

          case "setName":
            this.showSetUserName($elements);
            break;
        }
    }
    showSetUserName($el) {
        let data = this.getItemData($el[0]);
        if (!data) return;
        new SetStudentNameUseCase({
            name: data.name,
            memberId: data.memberId,
            testUserId: data.id,
            onDoneCallback: function(dto) {
                data.name = dto.name;
                this.updateEl($el[0], data, true);
            }.bind(this)
        }).showDialog();
    }
    async processPromiseUpdateUserData(promise) {
        try {
            let result = await promise;
            for (const user of result.data) {
                let element = this.getItemElement(user);
                if (user.groupId !== this.groupId && element) {
                    this.remove(user, element);
                } else if (element) {
                    this.updateEl(element, user, true);
                } else {
                    this.add(user);
                }
            }
        } catch (e) {
            console.error(e);
            alert("Ошибка: " + JSON.stringify(e));
        }
    }
    activateSelectedUsers() {
        let $elements = this.getSelectedRows().filter(".status-inactive");
        this.runUseCaseForElements($elements, new ToggleUserActiveUseCase(true));
    }
    deactivateSelectedUsers() {
        let $elements = this.getSelectedRows().filter(".status-active");
        this.runUseCaseForElements($elements, new ToggleUserActiveUseCase(false));
    }
    runUseCaseForElements($elements, useCase) {
        for (let el of $elements) {
            let user = this.getItemData(el);
            if (user) {
                useCase.addUser(undefined, user.memberId);
            }
        }
        if (useCase.dto.users.length > 0) {
            this.processPromiseUpdateUserData(useCase.exec());
        }
    }
    moveUsers($userElements) {
        if (!$userElements) {
            $userElements = this.getSelectedRows();
        }
        if (!this.moveToAnotherGroupUseCase) {
            this.moveToAnotherGroupUseCase = new MoveToAnotherGroupUseCase(CURRENT_GROUP_ID, (useCase => {
                this.processPromiseUpdateUserData(useCase.exec());
            }));
        }
        this.moveToAnotherGroupUseCase.reset();
        for (let el of $userElements) {
            let user = this.getItemData(el);
            if (user) {
                this.moveToAnotherGroupUseCase.addUser(undefined, user.memberId);
            }
        }
        this.moveToAnotherGroupUseCase.show();
    }
    runCleanupResultsUseCase($elements) {
        let memberIds = [];
        for (let el of $elements) {
            let user = this.getItemData(el);
            if (user) {
                memberIds.push(user.memberId);
            }
        }
        if (memberIds.length > 0) {
            new ResultsCleanupUseCase(memberIds).showDialog();
        }
    }
    deleteUsersUseCase($elements) {
        let groupUsers = [];
        for (let el of $elements) {
            let user = this.getItemData(el);
            if (user) {
                groupUsers.push(user);
            }
        }
        if (groupUsers.length > 0) {
            new DeleteUsersUseCase(groupUsers, this.groupId, this.unUsersDeleted.bind(this)).showDialog();
        }
    }
    unUsersDeleted(users) {
        for (const user of users) {
            this.remove(user);
        }
    }
}

const ExistingUserAction = Object.freeze({
    Skip: "Skip",
    Move: "Move",
    RegisterAndDisableExisting: "RegisterAndDisableExisting"
});

const UserRegistrationStatus = Object.freeze({
    Registered: "Registered",
    Moved: "Moved",
    RegisteredDisabledExisting: "RegisteredDisabledExisting",
    Skipped: "Skipped",
    NoAccessToExistingUser: "NoAccessToExistingUser",
    NotValidEmail: "NotValidEmail",
    AlreadyMember: "AlreadyMember"
});

class AddUsersDTO extends UserListDTO {
    constructor(groupId) {
        super();
        this.groupId = groupId;
        this.emails = [];
        this.existingUserAction = ExistingUserAction.Skip;
    }
}

class RegistrationUserResultDTO {}

class RegisterUsersReply extends ApiReply {}

class RegisterUsersUseCase extends JsonApiUseCase {
    constructor(groupId, usersPresenter) {
        super("post", "/api/teacher/registerStudent", new AddUsersDTO(groupId));
        this.groupId = groupId;
        this.usersPresenter = usersPresenter;
        this.$cont = $("#add-users-cont");
        this.$cont.find(".do-add-users-button").click(this.doAddUsers.bind(this));
        this.$cont.find(".add-users-close-button").click(this.doClose.bind(this));
    }
    show() {
        this.$cont.removeClass("hidden");
        this.$cont.find(".add-users-input").empty();
        this.$cont.find(".add-users-results").empty().addClass("hidden");
        this.$cont[0].scrollIntoView({
            behavior: "smooth",
            block: "start",
            inline: "center"
        });
    }
    async doAddUsers() {
        let emailsText = this.$cont.find(".add-users-input").val();
        let emailList = emailsText.split(/[,;\s]+/gm).filter((s => s.length > 0));
        if (emailList.length < 1) {
            this.$cont.find(".add-users-results").empty().text("Не введён ни один email").removeClass("hidden");
            return;
        }
        this.dto.emails = emailList;
        this.dto.existingUserAction = this.$cont.find("#existing-user-select option:selected").val();
        let result;
        try {
            result = await this.exec();
        } catch (error) {
            console.log(error);
            alert("Ошибка: " + JSON.stringify(error));
            return;
        }
        let addedUsers = result.data.filter((userStatus => userStatus.user)).map((userStatus => userStatus.user));
        let notAddedUsers = result.data.filter((userStatus => !userStatus.user));
        let $results = this.$cont.find(".add-users-results").empty();
        if (addedUsers.length > 0) {
            this.usersPresenter.addItems(addedUsers);
            this.showResultsHintMessage($results);
        }
        if (notAddedUsers.length > 0) {
            let notAddedEmails = notAddedUsers.map((userStatus => userStatus.email)).join(", ");
            this.$cont.find(".add-users-input").val(notAddedEmails);
        }
        for (const status of result.data) {
            $results.append(`<span class='processed-email status-${status.status}'>${status.email}</span>`);
        }
        $results.removeClass("hidden");
    }
    async showResultsHintMessage($results) {
        let url = window.location.origin;
        if (!url) url = "https://test.russkij100.ru/"; else if (!url.endsWith("/")) url += "/";
        $results.append(`<p>Отмеченные галочкой ученики успешно добавлены в группу.<br/> Отправьте им ссылку для авторизации:\n <a class="largeLink color" href="${url}">https://test.russkij100.ru/</a>\n <span class="copy-button image-tint-button copy-url-control"></span>\n </p>`);
        $results.find(".copy-button").on("click", (function(e) {
            navigator.clipboard.writeText(url);
            showToastBelow(e.target, "Ссылка скопирована в буфер обмена.", 2e3);
        }));
        await bUtil.asyncTimeout(200);
        bUtil.scrollIntoViewIfNeeded($results, {
            $container: $("html")
        });
    }
    doClose() {
        this.$cont.addClass("hidden");
    }
}

class MoveUsersToAnotherGroupDTO extends UserListDTO {
    constructor(groupId) {
        super();
        this.targetGroupId = groupId;
    }
    reset() {
        super.reset();
        this.targetGroupId = 0;
    }
}

class MoveToAnotherGroupUseCase extends JsonApiUseCase {
    constructor(currentGroupId, onTargetSelectedCallback) {
        super("put", "/api/teacher/moveStudentToAnotherGroup", new MoveUsersToAnotherGroupDTO(0));
        this.currentGroupId = currentGroupId;
        this.onTargetSelectedCallback = onTargetSelectedCallback;
        this.$dialog = $("#select-group-dialog").clone().removeClass("hidden").dialog({
            title: "Выберите группу, в которую перенести пользователей",
            autoOpen: false,
            closeOnEscape: true,
            modal: true,
            resizable: true,
            width: "auto",
            buttons: {
                Ok: this.doMoveUsers.bind(this),
                "Отмена": function() {
                    $(this).dialog("close");
                }
            }
        });
    }
    show() {
        let $select = this.$dialog.find("#select-group-dialog-select").empty();
        for (let group of GROUPS) {
            let selected = this.currentGroupId === group.id ? "selected" : "";
            $select.append(`<option value="${group.id}" ${selected}>${group.name}</option>`);
        }
        this.$dialog.dialog("open");
    }
    reset() {
        this.dto.reset();
    }
    addUser(userId = undefined, memberId = undefined) {
        this.dto.addUser(userId, memberId);
        return this;
    }
    doMoveUsers() {
        let selectedId = this.$dialog.find("#select-group-dialog-select").find("option:selected").val();
        selectedId = Number.parseInt(selectedId);
        if (selectedId && selectedId !== this.currentGroupId) {
            this.dto.targetGroupId = selectedId;
            this.onTargetSelectedCallback.call(null, this);
        }
    }
    async exec() {
        let result = await super.exec();
        this.$dialog.dialog("close");
        return result;
    }
}

class GroupUI {
    constructor(groupId, users, groups, $userTemplate) {
        this.groupId = groupId;
        this.users = users;
        this.groups = groups;
        this.usersController = new GroupUsersController(groupId, $userTemplate[0], $(".items-cont"));
        this.usersController.addItems(users);
        $(".item-list-menu .accentButton").click(this.onMenuItemClick.bind(this));
    }
    onMenuItemClick(e) {
        let $el = $(e.target);
        if (!$el.is(".accentButton")) {
            $el = $el.closest(".accentButton");
        }
        let action = $el.data("action");
        switch (action) {
          case "register-users":
            this.onRegisterUsersClick();
            break;

          case "activate":
            this.usersController.activateSelectedUsers();
            break;

          case "deactivate":
            this.usersController.deactivateSelectedUsers();
            break;

          case "move":
            this.usersController.moveUsers();
            break;

          case "select-all":
          case "deselect-all":
          case "resetProgress":
            this.usersController.runNamedAction(action);
            break;

          case "setName":
            this.usersController.runNamedAction(action, $el);
            break;
        }
    }
    onRegisterUsersClick() {
        if (!this.registerUseCase) {
            this.registerUseCase = new RegisterUsersUseCase(this.groupId, this.usersController);
        }
        this.registerUseCase.show();
    }
}

class CleanupResultsRequestDTO {
    constructor(memberIds = undefined, groupId = 0) {
        this.memberIds = memberIds;
        this.groupId = groupId;
    }
}

class CleanupResultsReplyDTO {}

class CleanupResultsApiReply {}

class ResultsCleanupUseCase extends JsonApiUseCaseWithDialog {
    constructor(memberIds = undefined, groupId = 0) {
        super("DELETE", "/api/teacher/testResults", new CleanupResultsRequestDTO(memberIds, groupId));
        this.initDialog("#select-cleanup-interval-dialog", "Удаление результатов пользователя. Выберите интервал.");
    }
    async onOkClick() {
        let startInterval = this.$dialog.find("#interval-start").val();
        let intervalEnd = this.$dialog.find("#interval-start").val();
        this.dto.intervalStart = startInterval ? new Date(startInterval) : undefined;
        this.dto.intervalEnd = intervalEnd ? new Date(intervalEnd) : undefined;
        let result;
        try {
            result = await this.exec();
        } catch (error) {
            console.log(error);
            alert("Ошибка: " + JSON.stringify(error));
            return;
        }
        let resultStr = `Удалено:\n    результатов: ${result.data.deletedResults},\n    слепков результатов: ${result.data.deletedStats},\n    слепков правил результатов: ${result.data.deletedPreceptCounters}.`;
        alert(resultStr);
        this.onClose();
    }
    showDialog() {
        this.$dialog.find("#interval-start, #interval-end").val("");
        super.showDialog();
    }
}

class DeleteUsersRequestDTO {
    constructor(memberIds = undefined, groupId = 0) {
        this.memberIds = memberIds;
        this.groupId = groupId;
    }
}

class DeleteUsersReplyDTO {}

class DeleteUsersApiReply {}

class DeleteUsersUseCase extends JsonApiUseCaseWithDialog {
    constructor(groupUsers, groupId, onDeletedCallback) {
        super("DELETE", "/api/teacher/testUsers", new CleanupResultsRequestDTO(groupUsers.map((groupUsers => groupUsers.memberId)), groupId));
        this.groupUsers = groupUsers;
        this.onDeletedCallback = onDeletedCallback;
        this.initDialog("#ask-delete-users-dialog", "Удаление пользователей.");
    }
    async onOkClick() {
        let result;
        try {
            result = await this.exec();
        } catch (error) {
            console.log(error);
            alert("Ошибка: " + JSON.stringify(error));
            return;
        }
        let resultStr = `Удалено учеников: ${result.data.deletedMembers}.`;
        alert(resultStr);
        this.onClose();
        if (this.onDeletedCallback) {
            this.onDeletedCallback.call(undefined, this.groupUsers);
        }
    }
    showDialog() {
        let userList = this.groupUsers.map((gu => gu.email)).join(",");
        this.$dialog.find(".delete-candidates").append(userList + ".");
        super.showDialog();
    }
}

class SetStudentNameUseCase extends JsonApiUseCaseWithDialog {
    constructor(params) {
        super("POST", "/api/teacher/setStudentName", params);
        this.memberId = params.memberId;
        this.testUserId = params.testUserId;
        this.oldDane = params.name || "";
        this.onDoneCallback = params.onDoneCallback;
        this.basicTemplate = `<div>\n    <div class="dialog-body">\n      <div class="form-row text-input-layout" id="student-name-row">\n        <label for="student-name">Имя ученика</label>\n        <input class="validate" id="student-name" name="student-name" placeholder=" " required type="text" value="${this.oldDane}">\n      </div>\n    </div>\n  </div>`;
        let $dlg = this.initDefaultDialog("Установить имя ученика");
        this.nameInputLayout = new MaterialTextInput($dlg.find("#student-name-row")[0]);
        this.nameInputLayout.setOnEnterCallback(this.onOkClick.bind(this));
    }
    async onOkClick() {
        let result;
        this.dto.name = this.$dialog.find("#student-name").val();
        try {
            result = await this.exec();
        } catch (error) {
            console.log(error);
            alert("Ошибка: " + JSON.stringify(error));
            return;
        }
        this.close();
        if (this.onDoneCallback) {
            this.onDoneCallback.call(undefined, this.dto);
        }
    }
}
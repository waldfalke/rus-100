# TD-MS-001: Системный мастер-контракт внедрения дизайн-токенов

## 0. Мета-данные и навигация

**Версия**: 1.0  
**Дата**: 2023-05-30  
**Статус**: Draft  
**Приоритет**: P0  
**Классификация**: Системный мастер-контракт  
**Scope**: Централизованная система управления дизайн-токенами на базе Style Dictionary, интеграция с Tailwind CSS, TypeScript, Storybook и будущая поддержка Figma.

**Содержание**

1. [Абстракция и назначение](#1-абстракция-и-назначение)
2. [Архитектура системы токенов](#2-архитектура-системы-токенов)
3. [Технический стек и зависимости](#3-технический-стек-и-зависимости)
4. [Структура данных токенов](#4-структура-данных-токенов)
5. [Жизненный цикл токенов](#5-жизненный-цикл-токенов)
6. [Интеграции и взаимодействия](#6-интеграции-и-взаимодействия)
7. [План внедрения и дорожная карта](#7-план-внедрения-и-дорожная-карта)
8. [Производные контракты](#8-производные-контракты) 
9. [Критерии успеха и валидации](#9-критерии-успеха-и-валидации)
10. [FAQ и решение проблем](#10-faq-и-решение-проблем)

---

## 1. Абстракция и назначение

### 1.1. Назначение системы

Создание централизованной системы управления дизайн-токенами для обеспечения:

- Единого источника истины для всех стилевых параметров проекта
- Автоматизированной генерации CSS-переменных, TypeScript-типов и Tailwind-конфигурации
- Поддержки мультитемности (светлая/темная тема)
- Согласованности дизайна во всем приложении
- Улучшения процесса разработки и уменьшения когнитивной нагрузки на разработчиков

### 1.2. Границы системы

**Включает**:
- JSON-определения токенов
- Конфигурация и скрипты Style Dictionary 
- Генерацию CSS-переменных
- Генерацию TypeScript-типов
- Интеграцию с Tailwind CSS через плагины
- Документацию в Storybook
- Утилиты для работы с токенами в React-компонентах
- Инфраструктуру для будущей интеграции с Figma

**Не включает**:
- UI-компоненты и бизнес-логику
- Конфигурацию Figma (будет реализована позднее)
- Серверные компоненты дизайн-системы

### 1.3. Участники

- **Потребители**: front-end разработчики, UX/UI дизайнеры
- **Поставщики**: Style Dictionary, Tailwind CSS, TypeScript
- **Наблюдатели**: CI/CD, инструменты контроля качества

---

## 2. Архитектура системы токенов

### 2.1. Концепция и подход

Система использует многоуровневую архитектуру токенов:

1. **Базовые токены (Primitive)**: 
   - Минимальные, атомарные значения (цвета, размеры, радиусы)
   - Независимы от темы и контекста

2. **Семантические токены (Semantic)**:
   - Смысловые значения, использующие базовые токены
   - Различаются в зависимости от темы (светлая/темная)

3. **Компонентные токены (Component)**:
   - Специфичные для определенных компонентов
   - Используют семантические токены

### 2.2. Общая схема работы

```
┌────────────────┐     ┌────────────────┐     ┌────────────────┐
│  JSON-токены   │────►│ Style Dictionary│────►│  CSS Variables │
│  (в репозитории)│     │  (трансформация) │     │  (в браузере)  │
└────────────────┘     └────────────────┘     └────────────────┘
                              │                       ▲
                              ▼                       │
                        ┌────────────────┐     ┌────────────────┐
                        │ TypeScript типы│     │  React-компоненты │
                        │ (для разработки)│     │  (используют токены)│
                        └────────────────┘     └────────────────┘
                              │                       ▲
                              ▼                       │
                        ┌────────────────┐     ┌────────────────┐
                        │ Tailwind плагин│────►│  Utility классы │
                        │ (расширение темы)│     │  (в шаблонах)   │
                        └────────────────┘     └────────────────┘
```

---

## 3. Технический стек и зависимости

### 3.1. Основные инструменты

- **Style Dictionary** (^3.7.2): Центральный инструмент для трансформации токенов
- **Tailwind CSS** (^3.4.17): Утилитарная CSS-библиотека
- **TypeScript** (^5.0.0): Система типизации
- **Next.js** (15.2.4): Фреймворк приложения
- **React** (^18.3.1): UI библиотека
- **Storybook** (^8.6.12): Документация и тестирование компонентов
- **next-themes** (^0.4.4): Управление темами

### 3.2. Дополнительные зависимости

- **@types/style-dictionary**: Типы для Style Dictionary
- **postcss**: Обработка CSS
- **shadcn/ui**: Существующие компоненты (базовые)

### 3.3. Потенциальные коллизии

| Технология | Версия | Потенциальная коллизия | Решение |
|------------|--------|------------------------|---------|
| Style Dictionary | ^3.7.2 | Устаревшие плагины | Кастомные трансформеры |
| Tailwind JIT | ^3.4.17 | Конфликты с CSS-переменными | Использование через плагин |
| next-themes | ^0.4.4 | Мерцание при загрузке | Специальный wrapper с `no-animation` |
| shadcn/ui | — | Несовместимость с новыми токенами | Постепенная миграция компонентов |

---

## 4. Структура данных токенов

### 4.1. Структура файлов

```
/design-system
  /tokens
    /base             # Базовые, примитивные токены
      colors.json
      typography.json
      spacing.json
      shadows.json
      radii.json
    /themes           # Темы (светлая/темная)
      light.json
      dark.json
    /components       # Компонентные токены
      button.json
      input.json
      card.json
  /transformers       # Кастомные трансформеры
    custom-transforms.js
  /formatters         # Кастомные форматтеры
    tailwind-plugin.js
  style-dictionary.config.js
  index.ts            # Экспорты токенов
```

### 4.2. JSON-схема токенов

Все JSON-файлы токенов должны следовать единой схеме:

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "DesignTokens",
  "type": "object",
  "properties": {
    "[category]": {
      "type": "object",
      "patternProperties": {
        "^[a-z0-9-]+$": {
          "type": "object",
          "properties": {
            "value": { "type": "string" },
            "description": { "type": "string" },
            "type": { "type": "string" }
          },
          "required": ["value"]
        }
      }
    }
  }
}
```

### 4.3. Соглашения о наименовании

- **Токены**: lowercase-kebab-case (`primary-color`, `spacing-md`)
- **Категории**: camelCase (`fontSize`, `borderRadius`)
- **Темы**: lowercase (`light`, `dark`)

### 4.4. Форматы вывода

- **CSS**: CSS-переменные в root
- **TS**: TypeScript интерфейсы и типы
- **JS**: JavaScript объекты для использования в коде
- **Tailwind**: Плагины, расширяющие Tailwind

---

## 5. Жизненный цикл токенов

### 5.1. Создание и обновление

1. Определение новых токенов в JSON-файлах
2. Запуск `npm run build:tokens`
3. Валидация сгенерированных артефактов
4. Коммит в репозиторий

### 5.2. Использование

**CSS переменные**:
```css
.my-component {
  color: var(--theme-text-primary);
  margin: var(--spacing-md);
}
```

**Tailwind классы**:
```jsx
<div className="text-text-primary m-spacing-md">
  Content
</div>
```

**TypeScript API**:
```tsx
import { useTokenStyles } from '@/lib/design-tokens';

function Component() {
  const styles = useTokenStyles({
    color: 'token:theme.text.primary',
    margin: 'token:spacing.md'
  });
  
  return <div style={styles}>Content</div>;
}
```

### 5.3. Мониторинг и обслуживание

- **CI/CD**: Автоматическая генерация при пуше в репозиторий
- **Storybook**: Визуальный мониторинг и документация
- **Lint**: Проверка использования устаревших токенов
- **Миграции**: Скрипты для массового обновления токенов

---

## 6. Интеграции и взаимодействия

### 6.1. Интеграция с Tailwind CSS

Расширение Tailwind через плагин, генерируемый Style Dictionary:

```js
// tailwind.config.ts
import type { Config } from 'tailwindcss';

const config: Config = {
  // ... существующая конфигурация
  plugins: [
    require('@/design-system/build/tailwind/light'),
    require('@/design-system/build/tailwind/dark'),
  ],
};

export default config;
```

### 6.2. Интеграция со Storybook

```js
// .storybook/preview.ts
import { withThemeByClassName } from '@storybook/addon-themes';
import { ThemeProvider } from '@/components/theme-provider';
import '@/app/globals.css';

export const decorators = [
  withThemeByClassName({
    themes: {
      light: 'light',
      dark: 'dark',
    },
    defaultTheme: 'light',
  }),
  (Story) => (
    <ThemeProvider>
      <Story />
    </ThemeProvider>
  ),
];
```

### 6.3. Интеграция с Next.js/React

```tsx
// src/components/theme-provider.tsx
'use client';

import { ThemeProvider as NextThemesProvider } from 'next-themes';
import { type ThemeProviderProps } from 'next-themes/dist/types';
import { useEffect } from 'react';

export function ThemeProvider({ children, ...props }: ThemeProviderProps) {
  useEffect(() => {
    const root = window.document.documentElement;
    const timer = setTimeout(() => {
      root.classList.remove('no-animation');
    }, 100);
    
    return () => clearTimeout(timer);
  }, []);

  return (
    <NextThemesProvider
      attribute="class"
      defaultTheme="system"
      enableSystem
      disableTransitionOnChange={false}
      {...props}
    >
      {children}
    </NextThemesProvider>
  );
}
```

### 6.4. Будущая интеграция с Figma

Контракт предусматривает подготовку к будущей интеграции с Figma через:
- Структуру токенов, совместимую с Figma Tokens Studio
- Скрипты синхронизации для двунаправленного обмена
- API для доступа к Figma API

---

## 7. План внедрения и дорожная карта

### 7.1. Этапы внедрения

1. **Подготовка (TD-IMP-001)**
   - Создание структуры директорий
   - Разработка базовой конфигурации
   - Установка зависимостей

2. **Базовые токены (TD-IMP-002)**
   - Извлечение существующих значений из CSS
   - Создание базовых JSON-токенов
   - Настройка трансформеров

3. **Интеграция Tailwind (TD-IMP-003)**
   - Разработка форматтера для Tailwind
   - Подключение к существующему конфигу
   - Тестирование утилит

4. **React-интеграция (TD-IMP-004)**
   - Создание хуков для работы с токенами
   - Настройка провайдера тем
   - Миграция компонентов на новые токены

5. **Документация Storybook (TD-IMP-005)**
   - Создание страниц документации
   - Настройка аддонов
   - Интерактивные примеры

### 7.2. Временная шкала

```
Неделя 1-2: Подготовка и базовые токены
Неделя 3-4: Интеграция Tailwind и React
Неделя 5-6: Документация и тестирование
Неделя 7-8: Миграция существующих компонентов
```

### 7.3. Ответственные лица и роли

- **Tech Lead**: Общее руководство и архитектура
- **UI-разработчик**: Извлечение токенов и создание JSON
- **Frontend-разработчик**: Интеграция с React и Tailwind
- **QA-инженер**: Тестирование и валидация

---

## 8. Производные контракты

Данный мастер-контракт порождает следующие специализированные контракты:

1. **TD-IMP-001**: Настройка инфраструктуры Style Dictionary
   - Установка зависимостей
   - Создание конфигурационных файлов
   - Настройка скриптов сборки

2. **TD-IMP-002**: Извлечение и создание базовых токенов
   - Аудит существующих CSS-переменных
   - Создание JSON-токенов
   - Валидация соответствия UI-guidelines

3. **TD-IMP-003**: Интеграция с Tailwind CSS
   - Разработка плагина
   - Интеграция с существующим конфигом
   - Миграция utility-классов

4. **TD-IMP-004**: React-интеграция и темизация
   - Создание утилит и хуков
   - Настройка провайдера темы
   - Рефакторинг существующих компонентов

5. **TD-IMP-005**: Документация в Storybook
   - Создание компонентов документации
   - Настройка тематических аддонов
   - Интерактивные примеры использования

6. **TD-API-001**: Руководство по API дизайн-токенов
   - Документация по использованию токенов
   - Примеры для разработчиков
   - Чеклисты и best practices

---

## 9. Критерии успеха и валидации

### 9.1. Функциональные критерии

- ✅ Сгенерированные CSS-переменные доступны в проекте
- ✅ Tailwind-классы корректно используют токены
- ✅ TypeScript-типы обеспечивают автокомплит и type-safety
- ✅ Темизация работает без мерцания при загрузке
- ✅ Документация Storybook показывает все доступные токены

### 9.2. Нефункциональные критерии

- ✅ Время сборки токенов < 1 секунды
- ✅ Размер CSS не увеличивается более чем на 5KB
- ✅ Нет повторных определений CSS-переменных
- ✅ Сохранение совместимости с существующими компонентами
- ✅ Доступность (a11y) не нарушается

### 9.3. Метрики успеха

- 100% компонентов используют новые токены к концу проекта
- Сокращение дублирования CSS на 40%
- Уменьшение времени разработки новых компонентов на 30%
- Положительные отзывы разработчиков (> 8/10)

---

## 10. FAQ и решение проблем

### 10.1. Частые вопросы

**Q: Что делать при конфликте имен токенов?**  
A: Следуйте соглашению об именовании. При конфликте предпочтение отдается новому токену с документированием изменения.

**Q: Как добавить новую тему?**  
A: Создайте новый JSON-файл в `/tokens/themes/`, добавьте его в конфиг Style Dictionary и запустите сборку.

**Q: Как использовать токены в динамических стилях?**  
A: Используйте хук `useTokenStyles()` для React-компонентов.

### 10.2. Устранение неполадок

| Проблема | Возможная причина | Решение |
|----------|-------------------|---------|
| CSS-переменные не применяются | Неверный селектор | Проверьте конфиг Style Dictionary |
| Tailwind не видит токены | Плагин не подключен | Обновите tailwind.config.js |
| Мерцание при смене темы | Отсутствие transition | Добавьте CSS-переходы |
| Конфликт с существующими стилями | Приоритеты CSS | Используйте !important или увеличьте специфичность |

### 10.3. Рекомендации по отладке

- Используйте DevTools для проверки CSS-переменных
- Проверяйте сгенерированные файлы в `/build/`
- Тестируйте темы в режиме инкогнито (без кэша)
- Логируйте полученные значения токенов при отладке

---

_Данный мастер-контракт предоставляет полное описание архитектуры, процессов и требований для внедрения state-of-the-art системы дизайн-токенов. Имплементация должна следовать указанным здесь принципам и техническим решениям._ 
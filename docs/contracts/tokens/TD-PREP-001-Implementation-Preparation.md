# TD-PREP-001: Подготовка к внедрению системы дизайн-токенов

## 0. Мета-данные

**Версия**: 1.1  
**Дата**: 2023-05-27  
**Статус**: Draft  
**Приоритет**: P0  
**Родительский контракт**: Нет (является предшествующим для [TD-MS-001: Системный мастер-контракт внедрения дизайн-токенов](./TD-MS-001-Design-Token-System.md))  
**Зависимости**: Нет  
**Исполнители**: Tech Lead, Frontend-разработчик, UI/UX-дизайнер
**Владелец контракта**: UX-дизайнер (ответственный за принятие решений)

---

## 1. Цель и назначение

Подготовить проект к внедрению системы дизайн-токенов путем проведения всестороннего аудита существующих стилей, создания прототипа на ограниченном наборе компонентов, разработки детального плана миграции и определения стратегии отката. Этот контракт является подготовительным этапом, результаты которого используются при реализации последующих контрактов системы дизайн-токенов.

## 2. Технические требования

### 2.1. Аудит существующих CSS-переменных и Tailwind-конфигурации

#### 2.1.1. Создание реестра стилевых сущностей

Создать документ-реестр в формате Markdown, содержащий:

```md
# Реестр текущих стилевых параметров

## CSS-переменные
| Переменная | Значение | Использование | Категория | Соответствие в новой системе |
|------------|----------|---------------|-----------|------------------------------|
| --primary  | #0ea5e9  | Кнопки, ссылки| Цвет      | color.primary.500            |
| ...        | ...      | ...           | ...       | ...                          |

## Tailwind-классы
| Класс        | Частота | Компоненты        | Категория | Соответствие в новой системе |
|--------------|---------|-------------------|-----------|------------------------------|
| text-2xl     | 12      | Заголовки, карты  | Шрифт     | fontSize.2xl                 |
| ...          | ...     | ...               | ...       | ...                          |

## Повторяющиеся значения
| Значение | Тип     | Частота | Предлагаемый токен       |
|----------|---------|---------|--------------------------|
| #f9fafb  | Цвет    | 15      | color.neutral.50         |
| 1.5rem   | Размер  | 8       | spacing.6                |
| ...      | ...     | ...     | ...                      |
```

#### 2.1.2. Методология аудита

1. **Анализ CSS-файлов**:
   - Извлечь все CSS-переменные из `app/globals.css`
   - Извлечь все CSS-переменные из `styles/globals.css`
   - Проверить инлайн-стили в React-компонентах

2. **Анализ Tailwind-конфигурации**:
   - Извлечь кастомные значения из `tailwind.config.ts`
   - Идентифицировать переопределенные темы и расширения

3. **Частотный анализ классов**:
   - Выполнить grep по кодовой базе для определения частоты использования классов
   - Идентифицировать наиболее используемые классы

4. **Анализ компонентов**:
   - Проанализировать стилизацию компонентов shadcn/ui
   - Определить шаблоны использования CSS-in-JS

5. **Анализ респонсивности**:
   - Идентифицировать медиа-запросы и стили для разных размеров экрана
   - Определить паттерны адаптивности для десктопа, планшета и мобильных устройств
   - Составить реестр респонсивных классов и их использования

#### 2.1.3. Методология измерения дублирования стилей

Для объективного измерения сокращения дублирования стилей будут использованы следующие метрики:

1. **Количественный анализ повторов значений**:
   - Подсчет уникальных цветовых значений до и после внедрения токенов
   - Подсчет уникальных значений размеров, отступов и других свойств

2. **Анализ CSS-файлов**:
   - Измерение размера сжатого CSS (в байтах) до и после внедрения
   - Подсчет количества CSS-правил до и после

3. **Коэффициент DRY (Don't Repeat Yourself)**:
   ```
   DRY коэффициент = (1 - количество_уникальных_значений / общее_количество_использований) * 100%
   ```
   Цель: увеличение коэффициента на 40%

#### 2.1.4. Выходные артефакты

- Полный реестр CSS-переменных с указанием их использования
- Реестр Tailwind-классов с частотой использования
- Отчет о потенциальных конфликтах и проблемах миграции
- Предложения по соответствию между существующими стилями и новой системой токенов
- Базовые метрики дублирования стилей (для последующего сравнения)

### 2.2. Создание прототипа на небольшом наборе компонентов

#### 2.2.1. Выбор компонентов для прототипирования

Прототип должен быть реализован для следующих компонентов:
- `app/account/page.tsx` в качестве основной страницы
- Вложенные компоненты из этой страницы:
  - `ProfileCard`
  - `TariffPaymentCard`
  - `EditProfileModal`
  - `AccountSelectorDropdown`

#### 2.2.2. Создание минимального набора токенов

Определить минимальный набор токенов для выбранных компонентов:

```json
// Пример минимального набора токенов
{
  "color": {
    "primary": { "500": { "value": "#0ea5e9" } },
    "neutral": {
      "50": { "value": "#f9fafb" },
      "900": { "value": "#111827" }
    }
  },
  "fontSize": {
    "base": { "value": "1rem" },
    "lg": { "value": "1.125rem" },
    "xl": { "value": "1.25rem" },
    "2xl": { "value": "1.5rem" }
  },
  "spacing": {
    "4": { "value": "1rem" },
    "6": { "value": "1.5rem" }
  }
}
```

#### 2.2.3. Процесс прототипирования

1. **Создание ветки**:
   - Создать ветку `design-tokens-prototype` из текущей main/develop ветки

2. **Базовая инфраструктура**:
   - Установить Style Dictionary
   - Настроить базовую конфигурацию
   - Создать скрипты сборки
   
3. **Модификация компонентов**:
   - Модифицировать выбранные компоненты для использования токенов
   - Проверить различные состояния компонентов

4. **Тестирование респонсив-дизайна**:
   - Тестирование компонентов на трех основных брейкпоинтах:
     - Десктоп (> 1024px)
     - Планшет (768px - 1024px)
     - Мобильный (< 768px)
   - Проверка корректности адаптивных стилей при использовании токенов
   - Валидация сохранения всех респонсив-функций (меню, адаптивные макеты)

5. **Общее тестирование**:
   - Проверить визуальную целостность
   - Протестировать темизацию (светлая/темная тема)
   - Протестировать на различных устройствах и браузерах

#### 2.2.4. Документация результатов

- Отчет о процессе прототипирования
- Скриншоты до/после для всех трех представлений (десктоп, планшет, мобильный)
- Выявленные проблемы и их решения
- Рекомендации для полного внедрения

### 2.3. Разработка конкретного плана миграции с метриками успеха

#### 2.3.1. Структура роадмапа внедрения

Создать документ-роадмап с детальным планом внедрения:

```md
# Роадмап внедрения дизайн-токенов

## Этап 1: Подготовка инфраструктуры (1 неделя)
- Задача 1.1: Установка зависимостей
  - Сложность: Низкая
  - Зависимости: Нет
  - Блокировки: Совместимость версий
  - Исполнители: Frontend-разработчик
  - Критерии завершения: Успешная сборка проекта с новыми зависимостями

- Задача 1.2: Создание скриптов сборки
  - Сложность: Средняя
  - Зависимости: 1.1
  - Блокировки: Нет
  - Исполнители: Frontend-разработчик
  - Критерии завершения: Скрипт генерирует CSS-переменные и TS-типы

...

## Метрики успеха:
1. Количественные:
   - 100% CSS-переменных заменены на токены
   - Сокращение дублирования стилей на 40% (по методологии в п.2.1.3)
   - Время загрузки страницы не увеличивается более чем на 5%
   
2. Валидационные тесты:
   - Тест 1: Проверка доступности всех CSS-переменных
   - Тест 2: Проверка переключения тем без мерцания
   - Тест 3: Визуальное соответствие дизайн-макетам
```

#### 2.3.2. Оценка сроков и ресурсов

Оценка трудозатрат будет производиться по методу T-shirt sizing с последующей конвертацией в дни:

| Размер | Сложность              | Примерная длительность |
|--------|------------------------|------------------------|
| XS     | Очень простая задача   | 0.5 дня                |
| S      | Простая задача         | 1 день                 |
| M      | Средняя задача         | 2-3 дня                |
| L      | Сложная задача         | 5-7 дней               |
| XL     | Очень сложная задача   | 10+ дней               |

Для каждой задачи в роадмапе указать:
- Размер (T-shirt size)
- Исполнитель(и)
- Дедлайн
- Зависимости

Общая оценка проекта будет суммой всех задач с учетом параллельного выполнения и зависимостей.

#### 2.3.3. Критерии успеха

Определить измеримые критерии успеха:

1. **Технические критерии**:
   - Успешная генерация токенов
   - Отсутствие ошибок в консоли
   - Время сборки проекта
   - Размер CSS-файлов

2. **Визуальные критерии**:
   - Соответствие дизайн-макетам
   - Последовательность стилей
   - Корректное отображение на всех устройствах

3. **DX-критерии**:
   - Удобство использования токенов
   - Документация и примеры
   - Время разработки новых компонентов

#### 2.3.4. Зависимости и блокировки

- Идентификация зависимостей между задачами
- Выявление внешних блокировок
- План снятия блокировок

### 2.4. Определение стратегии отката в случае проблем

#### 2.4.1. Git-стратегия

1. **Структура веток**:
   ```
   main
   ├── design-tokens-implementation
   │   ├── dt-infrastructure
   │   ├── dt-base-tokens
   │   ├── dt-components
   │   └── dt-documentation
   ```

2. **Процесс мерджа**:
   - Каждая подветка требует code review
   - Автоматические тесты на каждом PR
   - Поэтапный мердж в основную ветку реализации

#### 2.4.2. Параллельное развертывание

1. **Техника переходного периода**:
   - Префиксирование новых CSS-переменных (`--dt-`)
   - Поддержка обеих систем стилей одновременно
   - Постепенная миграция компонентов

2. **Feature Toggles**:
   ```jsx
   // Пример использования feature toggle
   {useDesignTokens ? (
     <Button className="bg-theme-action-primary" />
   ) : (
     <Button className="bg-primary" />
   )}
   ```

#### 2.4.3. Владелец процесса отката и принятия решений

1. **Ответственные лица**:
   - **Владелец решения об откате**: UX-дизайнер (как владелец контракта)
   - **Технический исполнитель отката**: Frontend-разработчик
   - **Валидатор успешности отката**: UX-дизайнер и заказчик

2. **Критерии для принятия решения об откате**:
   - Критические визуальные дефекты на продакшене
   - Значительное снижение производительности (>10%)
   - Блокирующие проблемы, влияющие на бизнес-функциональность

3. **Процесс принятия решения**:
   - Документирование проблемы
   - Оценка возможности быстрого исправления
   - Совещание UX-дизайнера и заказчика
   - Формальное решение с документированием причин

#### 2.4.4. План коммуникации при возникновении проблем

1. **Каналы коммуникации**:
   - Создать выделенный канал в мессенджере для быстрого оповещения
   - Еженедельные статус-митинги для синхронизации прогресса
   - Трекер задач для документирования проблем

2. **Процесс эскалации**:
   - Уровень 1: Разработчик пытается решить проблему самостоятельно (1 день)
   - Уровень 2: Вовлечение UX-дизайнера для совместного решения (2 дня)
   - Уровень 3: Эскалация заказчику с предложением вариантов (включая откат)

3. **Шаблоны отчетов**:
   ```md
   # Отчет о проблеме
   
   ## Описание
   [подробное описание проблемы]
   
   ## Затронутые компоненты
   [список затронутых компонентов]
   
   ## Серьезность
   [низкая/средняя/высокая/критическая]
   
   ## Предлагаемое решение
   [описание решения или необходимость отката]
   
   ## Временная оценка
   [оценка времени на решение]
   ```

#### 2.4.5. Процедура отката

1. **Автоматический скрипт отката**:
   - Реверт всех изменений, связанных с токенами
   - Возврат к предыдущим CSS-переменным
   - Возврат компонентов к исходному состоянию

2. **Дневник миграции**:
   - Документирование всех изменений
   - Чеклист для проверки отката
   - Скрипты для автоматизации процесса

3. **Резервное копирование**:
   - Создание снапшотов ключевых файлов перед изменением
   - Автоматическое резервное копирование в CI/CD

#### 2.4.6. Тестирование отката

- План тестирования процедуры отката
- Симуляция различных сценариев проблем
- Валидация работоспособности системы после отката

### 2.5. Процесс документирования извлеченных уроков

#### 2.5.1. Структура документации

После каждой фазы проекта создавать документ "Извлеченные уроки" со следующей структурой:

```md
# Извлеченные уроки: [Фаза проекта]

## Что сработало хорошо
- [пункт 1]
- [пункт 2]

## Что можно улучшить
- [пункт 1]
- [пункт 2]

## Технические инсайты
- [технический инсайт 1]
- [технический инсайт 2]

## Влияние на процесс разработки
- [изменение в процессе 1]
- [изменение в процессе 2]

## Рекомендации для будущих проектов
- [рекомендация 1]
- [рекомендация 2]
```

#### 2.5.2. Процесс сбора обратной связи

1. **Регулярный сбор обратной связи**:
   - От разработчиков (ИИ и человека) после каждой итерации
   - От заказчика после демонстрации результатов
   - От пользователей (если применимо) через тестирование прототипа

2. **Ретроспективы**:
   - Проводить мини-ретроспективы в конце каждой фазы
   - Документировать все проблемы и решения
   - Обновлять контракты с учетом новых знаний

3. **Создание базы знаний**:
   - Собранные уроки добавлять в базу знаний проекта
   - Использовать для обучения ИИ и улучшения будущих контрактов

## 3. Валидация и тестирование

### 3.1. Аудит существующих стилей

- Полнота реестра (охват >95% всех CSS-переменных)
- Точность соответствия между старыми и новыми стилями
- Валидация соответствия UI-guidelines
- Проверка адаптивности для всех трех вьюпортов

### 3.2. Прототип

- Визуальное соответствие прототипа текущей версии
- Корректная работа прототипа в обеих темах
- Успешная интеграция с Tailwind
- Тестирование на всех целевых устройствах

### 3.3. Роадмап внедрения

- Реалистичность оценок
- Полнота охвата всех аспектов внедрения
- Четкость критериев успеха
- Согласованность с заказчиком

### 3.4. Стратегия отката

- Эффективность скриптов отката
- Полнота документации процедуры
- Минимизация рисков потери данных
- Четкость процесса принятия решений

## 4. Доставка результатов

1. **Реестр стилевых сущностей**:
   - Документ в формате Markdown с полным перечнем CSS-переменных
   - Анализ использования Tailwind-классов
   - Рекомендации по миграции

2. **Прототип на выбранных компонентах**:
   - Код в отдельной ветке репозитория
   - Документация по внедрению
   - Скриншоты для визуального сравнения (десктоп, планшет, мобильный)

3. **Роадмап внедрения**:
   - Детальный план внедрения с оценкой сроков
   - Список задач с зависимостями
   - Критерии успеха и метрики

4. **Стратегия отката**:
   - Документ с описанием процедуры отката
   - Скрипты для автоматизации отката
   - Чеклист для валидации успешного отката

5. **Документ извлеченных уроков**:
   - Начальная версия после подготовительной фазы
   - План обновления после каждой фазы внедрения

## 5. Критерии приемки

- ✅ Создан полный реестр существующих стилевых параметров
- ✅ Разработан и протестирован прототип на странице account/page.tsx
- ✅ Составлен детальный роадмап внедрения с валидируемыми критериями успеха
- ✅ Определена и документирована стратегия отката
- ✅ Назначены ответственные за принятие решений и процесс отката
- ✅ Установлен процесс коммуникации при возникновении проблем
- ✅ Определен процесс документирования извлеченных уроков
- ✅ Все артефакты соответствуют требованиям к документации

## 6. Дополнительные рекомендации

- Привлечь дизайнера для валидации соответствия токенов дизайн-системе
- Рассмотреть возможность автоматизации аудита с помощью скриптов
- Организовать демо-сессию для команды после создания прототипа
- Создать канал коммуникации для оперативного решения вопросов при внедрении
- Провести мини-обучение по работе со Style Dictionary для всей команды
- Рассмотреть возможность привлечения консультанта с опытом внедрения дизайн-токенов 
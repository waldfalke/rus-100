# План миграции на систему дизайн-токенов

Этот документ описывает план постепенного перехода проекта на систему дизайн-токенов, основанную на Style Dictionary. План включает этапы подготовки, внедрения, управления рисками и откатов.

## 1. Подготовительные шаги

### 1.1. Настройка инфраструктуры

1. **Установка и настройка Style Dictionary**:
   ```bash
   npm install --save-dev style-dictionary
   ```

2. **Создание базовой структуры директорий**:
   ```
   tokens/
   ├── base/
   │   ├── color.json
   │   ├── typography.json
   │   ├── spacing.json
   │   ├── sizing.json
   │   ├── radius.json
   │   └── shadow.json
   ├── semantic/
   │   ├── color.json
   │   ├── typography.json
   │   ├── spacing.json
   │   └── elevation.json
   └── component/
       ├── card.json
       ├── button.json
       ├── input.json
       └── modal.json
   ```

3. **Создание конфигурации Style Dictionary**:
   ```js
   // style-dictionary.config.js
   module.exports = {
     source: ['tokens/**/*.json'],
     platforms: {
       css: {
         transformGroup: 'css',
         buildPath: 'styles/generated/',
         files: [{
           destination: 'tokens.css',
           format: 'css/variables',
           options: {
             outputReferences: true
           }
         }]
       },
       js: {
         transformGroup: 'js',
         buildPath: 'lib/',
         files: [{
           destination: 'tokens.js',
           format: 'javascript/es6',
           options: {
             outputReferences: true
           }
         }]
       },
       ts: {
         transformGroup: 'js',
         buildPath: 'lib/',
         files: [{
           destination: 'tokens.d.ts',
           format: 'typescript/es6-declarations'
         }]
       }
     }
   };
   ```

4. **Добавление скриптов в package.json**:
   ```json
   "scripts": {
     "build:tokens": "style-dictionary build",
     "watch:tokens": "style-dictionary build --watch"
   }
   ```

### 1.2. Настройка теминга

1. **Создание файлов для светлой и темной темы**:
   ```
   tokens/
   ├── themes/
   │   ├── light.json
   │   └── dark.json
   ```

2. **Настройка переключения тем через CSS-классы**:
   ```css
   :root {
     /* Базовые токены для светлой темы */
   }
   
   .dark {
     /* Переопределения для темной темы */
   }
   ```

### 1.3. Создание утилит и хелперов

1. **React хук для использования токенов**:
   ```typescript
   // useTokens.ts
   import { tokens } from '../lib/tokens';
   
   export const useTokens = () => {
     return tokens;
   };
   ```

2. **Утилиты для Tailwind CSS**:
   ```js
   // tailwind.tokens.js
   const tokens = require('./lib/tokens');
   
   module.exports = {
     // Преобразование токенов в формат для Tailwind
     colors: transformTokensToTailwindColors(tokens),
     spacing: transformTokensToTailwindSpacing(tokens),
     // ...другие преобразования
   };
   ```

## 2. Пилотное внедрение

### 2.1. Выбор компонентов для пилота

Для пилотного внедрения выбраны следующие компоненты:
- ProfileCard
- TariffPaymentCard
- EditProfileModal
- AccountSelectorDropdown

### 2.2. Создание компонентных токенов

1. **Определение токенов для каждого компонента** согласно прототипу в документе `token-prototype-definitions.md`.

2. **Запуск генерации токенов**:
   ```bash
   npm run build:tokens
   ```

### 2.3. Интеграция в страницу аккаунта

1. **Рефакторинг компонентов** для использования токенов:
   ```tsx
   // До
   <div className="p-4 rounded-lg border shadow-sm">
   
   // После
   <div className="p-[var(--component-card-padding)] rounded-[var(--radius-base)] border border-[var(--color-border-default)] shadow-[var(--shadow-sm)]">
   ```

2. **Создание стилизованных компонентов**:
   ```tsx
   // components/ui/Card.tsx
   import React from 'react';
   
   const Card = ({ children, className = "", ...props }) => {
     return (
       <div 
         className={`bg-[var(--color-surface-default)] border border-[var(--color-border-default)] rounded-[var(--radius-base)] shadow-[var(--shadow-sm)] p-[var(--spacing-component-padding-base)] ${className}`}
         {...props}
       >
         {children}
       </div>
     );
   };
   
   export { Card };
   ```

3. **Тестирование пилотных компонентов** на странице аккаунта.

## 3. Поэтапная миграция

### 3.1. Приоритизация компонентов

На основе аудита определены следующие приоритеты миграции:

1. **Высокий приоритет** (первая фаза):
   - Основные компоненты UI (кнопки, карточки, поля ввода)
   - Шаблоны страниц (лэйауты, контейнеры)

2. **Средний приоритет** (вторая фаза):
   - Специализированные компоненты (модальные окна, дропдауны)
   - Таблицы и формы

3. **Низкий приоритет** (финальная фаза):
   - Визуализация данных (графики, диаграммы)
   - Вспомогательные компоненты

### 3.2. График миграции

1. **Подготовительная фаза** (2 недели):
   - Настройка инфраструктуры
   - Определение базовых и семантических токенов
   - Интеграция с Tailwind

2. **Пилотная фаза** (2 недели):
   - Рефакторинг пилотных компонентов
   - Тестирование и сбор обратной связи

3. **Первая фаза миграции** (3 недели):
   - Миграция компонентов высокого приоритета
   - Обновление документации

4. **Вторая фаза миграции** (3 недели):
   - Миграция компонентов среднего приоритета
   - Проверка адаптивности и доступности

5. **Финальная фаза** (2 недели):
   - Миграция остальных компонентов
   - Полное тестирование
   - Удаление устаревших стилей

### 3.3. Подход к миграции компонентов

1. **Создание новой версии компонента** с использованием токенов.
2. **Параллельное существование** старой и новой версии в течение переходного периода.
3. **Постепенная замена** использования старого компонента на новый по всему проекту.
4. **Удаление старого компонента** после полной миграции.

## 4. Тестирование и валидация

### 4.1. Визуальное тестирование

1. **Скриншот-тестирование**:
   - Создание эталонных скриншотов до миграции
   - Сравнение с новыми скриншотами после миграции
   - Использование инструментов типа Chromatic или Percy

2. **Ручное визуальное тестирование**:
   - Проверка на различных устройствах
   - Тестирование темной и светлой тем

### 4.2. Функциональное тестирование

1. **Автоматизированные тесты UI**:
   - Обновление существующих тестов
   - Проверка взаимодействия с компонентами

2. **Пользовательское тестирование**:
   - Внутреннее альфа-тестирование
   - Бета-тестирование на ограниченной группе пользователей

## 5. Стратегия отката

### 5.1. Подход к откату

1. **Фазированный откат**:
   - Возможность откатить отдельные компоненты без полного отката системы
   - Сохранение работоспособности при частичном откате

2. **Полный откат**:
   - Возможность полного возврата к предыдущей версии системы стилей

### 5.2. Технические средства отката

1. **Версионирование в Git**:
   - Создание тегов для каждой фазы миграции
   - Возможность отката к любой фазе

2. **Feature Toggles**:
   - Реализация переключателей для новой системы токенов
   - Возможность выключения токенов для отдельных компонентов

3. **Сохранение предыдущих версий компонентов**:
   ```tsx
   // components/LegacyButton.tsx - для отката
   export { LegacyButton } from './Button.legacy';
   
   // components/Button.tsx - новая версия с токенами
   export { Button } from './Button.new';
   ```

### 5.3. План восстановления

1. **Обнаружение проблем**:
   - Мониторинг производительности и ошибок
   - Пользовательские репорты

2. **Принятие решения об откате**:
   - Определение критериев для отката
   - Процесс принятия решения

3. **Выполнение отката**:
   - Пошаговая инструкция для разных сценариев
   - Коммуникация с пользователями

## 6. Документация и обучение

### 6.1. Документация для разработчиков

1. **Руководство по системе токенов**:
   - Структура и принципы организации
   - Применение токенов в компонентах

2. **Примеры использования**:
   - Шаблоны типовых компонентов
   - Решение частых задач

### 6.2. Обучение команды

1. **Вводный семинар** для всей команды по новой системе токенов.
2. **Практические воркшопы** по миграции компонентов.
3. **Индивидуальные консультации** по сложным случаям.

## 7. Поддержка и развитие

### 7.1. Процессы обновления

1. **Регулярный аудит**:
   - Проверка консистентности
   - Выявление отклонений от системы

2. **Процесс внесения изменений**:
   - Предложение изменений
   - Рассмотрение и утверждение
   - Внедрение и документирование

### 7.2. Масштабирование системы

1. **Добавление новых типов токенов** по мере необходимости.
2. **Расширение компонентной библиотеки**.
3. **Интеграция с другими проектами** организации.

## Приложения

### Приложение A: Шаблон для миграции компонента

```
# Миграция компонента [Название]

## Текущее состояние
- Существующие стили и их проблемы
- Зависимости и использование

## План миграции
1. Определение компонентных токенов
2. Рефакторинг компонента
3. Тестирование
4. Замена использования

## Критерии успеха
- Визуальная идентичность
- Функциональность
- Производительность

## Риски и их смягчение
- Потенциальные проблемы
- Способы их решения
```

### Приложение B: Чеклист для проверки миграции

```
# Чеклист миграции компонента

## Подготовка
[ ] Созданы все необходимые токены
[ ] Токены проверены на соответствие дизайн-системе
[ ] Определены критерии успеха

## Реализация
[ ] Компонент использует только токены (без хардкодных значений)
[ ] Сохранена вся функциональность
[ ] Обеспечена поддержка темизации

## Тестирование
[ ] Пройдены визуальные тесты
[ ] Пройдены функциональные тесты
[ ] Проверена доступность
[ ] Проверена производительность

## Документация
[ ] Обновлена документация компонента
[ ] Добавлены примеры использования
``` 
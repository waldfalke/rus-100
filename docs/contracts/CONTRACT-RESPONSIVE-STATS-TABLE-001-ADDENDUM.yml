# CONTRACT-RESPONSIVE-STATS-TABLE-001-ADDENDUM.yml
# Addendum к контракту ResponsiveStatsTable - анализ текущего состояния и доработки

id: CONTRACT-RESPONSIVE-STATS-TABLE-001-ADDENDUM
title: "Addendum: ResponsiveStatsTable Implementation Gaps & Improvements"
parent_contract: "CONTRACT-RESPONSIVE-STATS-TABLE-001"
version: 1.0.0
project: "rus100"
created: "2025-01-10"
status: "active"

# --------------------------
# АНАЛИЗ ТЕКУЩЕГО СОСТОЯНИЯ
# --------------------------
current_implementation_analysis:
  compliant_features:
    - "✅ Fullscreen toggle buttons (Maximize2/X icons) implemented"
    - "✅ Body scroll lock/unlock in fullscreen mode"
    - "✅ Sticky headers with correct z-index hierarchy"
    - "✅ Mobile horizontal scroll synchronization"
    - "✅ Sort cycle (none → asc → desc → none) with correct icons"
    - "✅ Cell click handler with proper parameters"
    - "✅ TypeScript strict mode compliance"
    - "✅ Semantic HTML table structure"
    - "✅ Immutable sort (uses [...students].sort())"
    - "✅ A'/A'' pattern for mobile version"

  non_compliant_features:
    - "❌ Esc key handler missing - fullscreen cannot be closed with Esc"
    - "❌ CSS contains extensive hardcoded pixel values instead of design tokens"
    - "❌ Hardcoded breakpoints (768px/769px) instead of Tailwind responsive utilities"
    - "❌ Color values use hardcoded Tailwind classes (text-green-600, text-red-600) instead of semantic tokens"

# --------------------------
# ОБНАРУЖЕННЫЕ ПРОБЛЕМЫ
# --------------------------
identified_issues:
  critical:
    - issue: "Sticky headers не работают в десктопной версии"
      impact: "Основная функциональность таблицы нарушена - заголовки не фиксируются при скролле"
      location: "components/ui/responsive-stats-table.css, lines 58-65"
      root_cause: "Конфликт CSS стилей - .table-scroll-container имеет overflow-y: auto, что создает новый stacking context и ломает position: sticky"
      current_behavior: "Заголовки скроллятся вместе с содержимым таблицы"
      expected_behavior: "Заголовки должны оставаться видимыми при вертикальном скролле"
      technical_details:
        - "position: sticky работает только относительно ближайшего scrolling ancestor"
        - ".table-scroll-container создает новый scrolling context"
        - "sticky элементы внутри overflow: auto контейнера прилипают к границам этого контейнера"
        - "Но при скролле самого контейнера sticky элементы скроллятся вместе с ним"

    - issue: "Missing Esc key handler"
      impact: "Users cannot exit fullscreen mode with keyboard"
      location: "components/ui/responsive-stats-table.tsx"
      current_behavior: "Only mouse click on X button works"
      expected_behavior: "Esc key should close fullscreen mode"

  major:
    - issue: "Extensive CSS hardcoded values"
      impact: "Violates design system consistency, hard to maintain"
      location: "components/ui/responsive-stats-table.css"
      examples: 
        - "padding: 12px 16px (should use spacing tokens)"
        - "min-width: 200px (should use size tokens)"
        - "height: 60vh (should use layout tokens)"
        - "border-radius: 8px (should use --radius)"
        - "font-size: 0.875rem (should use typography tokens)"
      count: "30+ hardcoded pixel/rem values"

    - issue: "Hardcoded responsive breakpoints"
      impact: "Inconsistent with Tailwind responsive system"
      location: "components/ui/responsive-stats-table.css"
      examples:
        - "@media (max-width: 768px) - should use Tailwind md: breakpoint"
        - "@media (min-width: 769px) - should use Tailwind md: breakpoint"
        - "window.innerWidth <= 768 - should use Tailwind useBreakpoint hook"

  minor:
    - issue: "Hardcoded color classes in TypeScript"
      impact: "Colors not semantic, may not adapt to theme changes"
      location: "getCellClassName function"
      examples:
        - "text-green-600 (should use text-success)"
        - "text-yellow-600 (should use text-warning)"
        - "text-red-600 (should use text-destructive)"
        - "text-gray-400 (should use text-muted-foreground)"

# --------------------------
# ПЛАН ДОРАБОТОК
# --------------------------
improvement_plan:
  phase_0_architecture_fix:
    - task: "Исправить архитектуру sticky headers в десктопной версии"
      priority: "critical"
      effort: "2-3 hours"
      problem: "Текущая архитектура с .table-scroll-container ломает position: sticky"
      solutions:
        option_1_remove_container:
          description: "Убрать .table-scroll-container, сделать sticky на уровне table"
          implementation:
            - "Удалить .table-scroll-container wrapper"
            - "Применить overflow-y: auto напрямую к table или его parent"
            - "Убедиться что sticky headers работают относительно viewport"
          pros: "Простое решение, минимальные изменения"
          cons: "Может нарушить fullscreen логику"
        
        option_2_restructure:
          description: "Реструктурировать с отдельным sticky header"
          implementation:
            - "Создать отдельный фиксированный header вне table"
            - "Синхронизировать ширину колонок между header и table"
            - "Обновить scroll synchronization логику"
          pros: "Полный контроль над sticky behavior"
          cons: "Больше кода, сложнее синхронизация"
        
        option_3_css_fix:
          description: "Исправить CSS без изменения структуры"
          implementation:
            - "Изменить .table-scroll-container на position: relative без overflow"
            - "Добавить overflow: auto на уровень выше или использовать body scroll"
            - "Настроить sticky positioning относительно правильного ancestor"
          pros: "Минимальные изменения в коде"
          cons: "Может потребовать изменения в parent components"
      
      recommended_solution: "option_1_remove_container"
      acceptance_criteria:
        - "Заголовки таблицы остаются видимыми при скролле"
        - "Sticky positioning работает в обычном и fullscreen режимах"
        - "Не нарушается мобильная версия"
        - "Сохраняется функциональность сортировки"

  phase_1_critical_fixes:
    - task: "Add Esc key handler for fullscreen exit"
      priority: "high"
      effort: "1 hour"
      implementation:
        - "Add useEffect with keydown event listener"
        - "Check for event.key === 'Escape' and isFullscreen"
        - "Call setIsFullscreen(false) on Esc"
        - "Clean up event listener on unmount"
      acceptance_criteria:
        - "Esc key closes fullscreen mode"
        - "Event listener properly cleaned up"
        - "Works only when fullscreen is active"

  phase_2_design_tokens:
    - task: "Replace CSS hardcoded values with design tokens"
      priority: "medium"
      effort: "4-6 hours"
      scope:
        spacing:
          - "padding: 12px 16px → padding: var(--spacing-3) var(--spacing-4)"
          - "margin-bottom: 4px → margin-bottom: var(--spacing-1)"
          - "gap: 8px → gap: var(--spacing-2)"
        sizing:
          - "min-width: 200px → min-width: var(--size-48)"
          - "flex: 0 0 120px → flex: 0 0 var(--size-30)"
          - "height: 60vh → height: var(--layout-table-height)"
        typography:
          - "font-size: 0.875rem → font-size: var(--text-sm)"
          - "font-size: 0.75rem → font-size: var(--text-xs)"
        borders:
          - "border-radius: 8px → border-radius: var(--radius)"
          - "border: 1px solid → border: var(--border-width) solid"

    - task: "Replace hardcoded breakpoints with Tailwind utilities"
      priority: "medium"
      effort: "2-3 hours"
      implementation:
        - "Replace @media (max-width: 768px) with Tailwind md: prefix"
        - "Replace window.innerWidth <= 768 with useBreakpoint('md')"
        - "Update CSS classes to use responsive utilities"
      files_affected:
        - "components/ui/responsive-stats-table.css"
        - "components/ui/responsive-stats-table.tsx"

  phase_3_semantic_colors:
    - task: "Replace hardcoded color classes with semantic tokens"
      priority: "low"
      effort: "1-2 hours"
      replacements:
        - "text-green-600 → text-success"
        - "text-yellow-600 → text-warning"
        - "text-red-600 → text-destructive"
        - "text-gray-400 → text-muted-foreground"
        - "text-gray-600 → text-foreground"

# --------------------------
# НОВЫЕ ТРЕБОВАНИЯ
# --------------------------
additional_requirements:
  accessibility:
    - "Add aria-label for fullscreen toggle buttons"
    - "Add role='table' for mobile A'/A'' version"
    - "Add aria-sort attributes for sortable columns"
    - "Ensure focus management in fullscreen mode"

  performance:
    - "Memoize formatValue function to prevent unnecessary re-renders"
    - "Optimize scroll sync handlers with throttling"
    - "Add virtualization for large datasets (>100 students)"

  testing:
    - "Add unit tests for Esc key handler"
    - "Add integration tests for fullscreen mode"
    - "Add visual regression tests for responsive breakpoints"

# --------------------------
# ОБНОВЛЕННЫЕ КРИТЕРИИ ПРИЕМКИ
# --------------------------
updated_acceptance_criteria:
  - name: "Sticky Headers Functionality"
    description: "Заголовки таблицы остаются видимыми при скролле в десктопной версии"
    validation: "manual + automated"
    check: "E2E test: scroll table content, verify headers remain in viewport"
    status: "FAILING - headers scroll with content due to CSS architecture issue"
    priority: "CRITICAL"

  - name: "Esc Key Handler"
    description: "Esc key closes fullscreen mode"
    validation: "automated"
    check: "Unit test: render in fullscreen, simulate Esc keydown, verify setIsFullscreen(false) called"
    status: "FAILING - not implemented"

  - name: "Design Token Usage"
    description: "CSS uses design tokens instead of hardcoded values"
    validation: "automated"
    check: "Stylelint rule blocks hardcoded px/rem values, requires var() usage"
    status: "FAILING - 30+ hardcoded values found"

  - name: "Responsive Breakpoints"
    description: "Uses Tailwind responsive utilities instead of hardcoded media queries"
    validation: "automated"
    check: "ESLint rule blocks @media queries, requires Tailwind responsive prefixes"
    status: "FAILING - hardcoded @media found"

  - name: "Semantic Colors"
    description: "Uses semantic color tokens instead of hardcoded Tailwind color classes"
    validation: "automated"
    check: "ESLint rule blocks text-{color}-{number} patterns, requires semantic tokens"
    status: "FAILING - hardcoded color classes found"

# --------------------------
# МИГРАЦИОННАЯ СТРАТЕГИЯ
# --------------------------
migration_strategy:
  approach: "Incremental improvement without breaking changes"
  
  step_1_immediate:
    - "Add Esc key handler (non-breaking)"
    - "Add missing aria-labels (non-breaking)"
    
  step_2_gradual:
    - "Replace CSS hardcoded values with CSS custom properties"
    - "Maintain backward compatibility during transition"
    - "Test each change in isolation"
    
  step_3_optimization:
    - "Migrate to Tailwind responsive utilities"
    - "Replace color classes with semantic tokens"
    - "Add performance optimizations"

  rollback_plan:
    - "Keep original CSS as backup"
    - "Feature flags for new implementations"
    - "Gradual rollout with monitoring"

# --------------------------
# ВАЛИДАЦИЯ ДОРАБОТОК
# --------------------------
validation_checklist:
  functional:
    - "[ ] Sticky headers работают в десктопной версии (КРИТИЧНО)"
    - "[ ] Заголовки остаются видимыми при вертикальном скролле"
    - "[ ] Sticky positioning не конфликтует с fullscreen режимом"
    - "[ ] Esc key closes fullscreen mode"
    - "[ ] All existing functionality preserved"
    - "[ ] Mobile scroll sync still works"
    - "[ ] Sort functionality unchanged"
    - "[ ] Cell click handlers work"
    
  visual:
    - "[ ] No visual regressions after token migration"
    - "[ ] Responsive breakpoints work correctly"
    - "[ ] Dark/light theme compatibility"
    - "[ ] Color contrast maintained"
    
  performance:
    - "[ ] No performance degradation"
    - "[ ] Scroll sync remains smooth"
    - "[ ] Fullscreen toggle is instant"
    
  accessibility:
    - "[ ] Keyboard navigation works"
    - "[ ] Screen reader compatibility"
    - "[ ] Focus management in fullscreen"
    - "[ ] ARIA attributes correct"

# --------------------------
# ЗАКЛЮЧЕНИЕ
# --------------------------
summary:
  current_compliance: "30% - критическая функциональность (sticky headers) не работает"
  critical_gaps: "2 - sticky headers не работают, отсутствует Esc handler"
  major_gaps: "2 - хардкоды в CSS и брейкпоинтах"
  minor_gaps: "1 - хардкоды цветов в TypeScript"
  
  priority_order:
    1: "КРИТИЧНО: Исправить sticky headers - основная функциональность таблицы"
    2: "Добавить Esc key handler - улучшение UX"
    3: "Заменить hardcoded значения на design tokens - техдолг"
    4: "Мигрировать на Tailwind responsive utilities - оптимизация"
  
  recommended_timeline:
    - "Day 1: Исправить архитектуру sticky headers (критично)"
    - "Day 2: Добавить Esc handler и тестирование"
    - "Week 2-3: Design token migration"
    - "Week 4: Responsive utilities migration"
    - "Week 5: Testing and validation"
  
  risk_assessment: "Medium - архитектурные изменения для sticky headers могут повлиять на другую функциональность"
  
  technical_debt_impact: "HIGH - компонент не выполняет основную функцию (sticky headers)"
  
  success_metrics:
    - "Sticky headers работают в десктопной версии"
    - "100% contract compliance"
    - "0 hardcoded values in CSS"
    - "All acceptance criteria passing"
    - "No visual regressions"
    - "Maintained performance"

# --------------------------
# ТЕХНИЧЕСКИЕ РЕКОМЕНДАЦИИ
# --------------------------
technical_recommendations:
  immediate_actions:
    1: "КРИТИЧНО: Исправить sticky headers - убрать .table-scroll-container или изменить его архитектуру"
    2: "Протестировать sticky positioning в Chrome, Firefox, Safari"
    3: "Добавить Esc key handler как быстрое улучшение UX"
    4: "Создать E2E тест для проверки sticky headers"

  architecture_notes:
    - "position: sticky работает только относительно ближайшего scrolling ancestor"
    - "overflow: auto на .table-scroll-container создает новый stacking context и ломает sticky"
    - "Fullscreen режим - это workaround, а не решение основной проблемы"
    - "Мобильная версия работает корректно, проблема только в desktop версии"

  css_debugging_guide:
    - "Используйте DevTools: Elements → Computed → position для проверки sticky элементов"
    - "Проверьте, что sticky элемент имеет определенные top/bottom значения"
    - "Убедитесь, что нет transform/will-change на parent элементах"
    - "Проверьте z-index hierarchy для правильного layering"
    - "Используйте 'Scroll into view' в DevTools для тестирования"

  browser_compatibility:
    - "position: sticky поддерживается всеми современными браузерами (>95% coverage)"
    - "IE11 не поддерживает sticky - нужен fallback или исключить из поддержки"
    - "Safari может требовать -webkit-sticky префикс для версий < 13"

conclusion: "Компонент ResponsiveStatsTable имеет критическую архитектурную проблему с sticky headers, которая делает его неполноценным для production использования. Приоритет #1 - исправить эту проблему, так как это основная функциональность таблицы. Fullscreen режим должен остаться как дополнительная опция, а не основной способ работы с таблицей."
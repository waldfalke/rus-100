id: CONTRACT-RESPONSIVE-STATS-TABLE-001
title: "Responsive Stats Table Component"
type: component
version: 1.0.0
project: "rus100"
complexity_level: complicated

meta_contract:
  id: "METACONTRACT-001"
  path: "docs/METACONTRACT.yml"

description: |
  Адаптивная таблица статистики с полноэкранным режимом
  отображения на десктопе и внутренним скроллом. Поддерживает сортировку по
  колонкам, липкие заголовки, синхронизацию горизонтального скролла на мобильных
  устройствах. Использует паттерн A'/A'' для мобильной версии.

cynefin_domain: complicated

preconditions:
  environment:
    - "Next.js 15.5.5 (Pages Router)"
    - "TypeScript strict mode enabled"
    - "Tailwind CSS v4 configured"
  directory_structure:
    - "components/ui/ directory exists"
    - "lib/utils.ts with cn() utility exists"
  dependencies:
    - "lucide-react package installed"
    - "@/lib/utils for cn() utility"
  state:
    - "Component receives valid students, columns, data props"
    - "Window object available (client-side rendering)"

postconditions:
  files:
    - "components/ui/responsive-stats-table.tsx exists and exports ResponsiveStatsTable"
    - "components/ui/responsive-stats-table.css exists with all required styles"
  validation:
    - "TypeScript compilation passes with strict mode"
    - "Component renders without console errors"
    - "All props validate according to TypeScript interfaces"
  build:
    - "Production build includes component without errors"
    - "CSS classes resolve correctly in build output"
  architecture:
    - "Component follows project's component structure conventions"
    - "Uses design system tokens where possible (current implementation has hardcoded values)"
  documentation:
    - "Component exports proper TypeScript interfaces"
    - "Props are documented via TypeScript types"

props:
  required:
    - name: students
      type: StudentData[]
      description: Список студентов (id, name, email, avatar?)
    - name: columns
      type: StatColumn[]
      description: Определения столбцов (key, label, type, format?, sortable?)
    - name: data
      type: Record<string, StatData>
      description: Map studentId → объект статистики по ключам из columns
  optional:
    - name: className
      type: string
      description: Дополнительные классы для корневого контейнера
    - name: stickyStudent
      type: boolean
      default: true
      description: Делает колонку студента липкой слева (desktop)
    - name: onCellClick
      type: (studentId: string, columnKey: string, value: any) => void
      description: Обработчик клика по ячейке (desktop и mobile)
    - name: sortBy
      type: string
      description: Изначально выбранный столбец для сортировки
    - name: sortOrder
      type: "asc" | "desc"
      description: Изначальный порядок сортировки
    - name: onSort
      type: (column: string, order: "asc" | "desc") => void
      description: Колбэк при изменении сортировки

variants:
  - name: mobile_compact
    description: |
      Паттерн A'/A'': фиксированная левая колонка (A') и горизонтально
      скроллируемая строка показателей (A''). Заголовок показателей синхронизирован
      по горизонтальному скроллу со строками.
  - name: desktop_embedded
    description: Встроенный режим в поток страницы без оверлея.
  - name: desktop_fullscreen
    description: Полноэкранный оверлей, фиксированный контейнер на весь экран,
      скролл только внутри таблицы, скролл body заблокирован.

states:
  - default
  - fullscreen_enabled
  - mobile_breakpoint

invariants:
  - "Desktop table headers (th) MUST have position: sticky, top: 0, z-index ≥ 10"
  - "Student column MUST be sticky on left with higher z-index than other headers"
  - "Mobile horizontal scroll MUST be synchronized between header and all rows"
  - "Fullscreen mode MUST block body scroll (document.body.style.overflow = 'hidden')"
  - "Table MUST use semantic HTML: <table>, <thead>, <tbody>, <th>, <td>"
  - "Sort state MUST be immutable (no array mutation, use [...array].sort())"

# KNOWN VIOLATIONS (to be fixed):
# - CSS contains hardcoded pixel values (12px, 16px, 200px, 768px, etc.) instead of design tokens
# - Component lacks Esc key handler for fullscreen exit
# - Hardcoded breakpoints (768px/769px) instead of Tailwind responsive utilities

constraints:
  performance:
    - "Без JS-вычислений высоты контейнера для десктопа; полагаемся на CSS sticky и 100vh в fullscreen."
    - "Сортировка выполняется над копией массива студентов (иммутабельность)."
  accessibility:
    - "Контраст соответствует WCAG AA."
    - "Фокусируемые элементы имеют видимую фокус-рамку."
    - "Заголовки столбцов озвучиваются скринридером."
    - "Клавиша Esc закрывает полноэкранный режим."
  browser_support:
    - "Chrome ≥ 100, Edge ≥ 100, Firefox ≥ 100, Safari ≥ 15"
  responsiveness:
    - "≤768px — мобильная версия с A'/A''; ≥769px — десктоп с возможностью полноэкранного режима."

dependencies:
  external:
    - "lucide-react@latest (icons: ChevronUp, ChevronDown, ChevronsUpDown, X, Maximize2)"
  internal:
    - "@/lib/utils#cn for className merging"
    - "components/ui/responsive-stats-table.css for styles"
  tokens:
    - "CSS custom properties: --background, --foreground, --muted, --muted-foreground, --border"
    - "Tailwind utilities: responsive breakpoints, spacing, colors"

scope:
  mutable:
    - components/ui/responsive-stats-table.tsx
    - components/ui/responsive-stats-table.css
  invariant:
    - app/groups/[id]/GroupStatsClient.tsx (паттерн использования)
    - app/globals.css (базовые переменные темы)

anti_patterns:
  - pattern: "Фиксировать внешний хедер страницы вместо контейнера таблицы"
    reason: "Ломает общий лэйаут, расходится с UX."
    alternative: "Фиксировать именно контейнер таблицы в fullscreen режиме."
  - pattern: "Жестко задавать высоту через inline-стили для компенсации скролла"
    reason: "Вызывает сжатие/растяжение контейнера, артефакты скролла."
    alternative: "Использовать фиксированный оверлей 100vh и внутренний скролл."
  - pattern: "Несинхронизированный горизонтальный скролл на мобильной версии"
    reason: "Несоответствие заголовков и данных."
    alternative: "Синхронизировать scrollLeft хедера и строк."
  - pattern: "Мутация исходного массива студентов при сортировке"
    reason: "Побочные эффекты и баги состояния."
    alternative: "Создавать копию и сортировать её."

acceptance_criteria:
  - name: "Fullscreen Toggle"
    description: "Expand button shows on desktop, enters fullscreen. Close button exits fullscreen."
    validation: "manual"
    check: "Click expand button → fullscreen mode. Click X → normal mode."

  - name: "Body Scroll Lock"
    description: "Body scroll blocked in fullscreen, restored on exit"
    validation: "manual" 
    check: "Enter fullscreen → try scrolling page (should not scroll). Exit → page scrolls normally."

  - name: "Sticky Headers"
    description: "Table headers stick to top during vertical scroll"
    validation: "manual"
    check: "Scroll table vertically → headers remain visible at top"

  - name: "Mobile Scroll Sync"
    description: "Horizontal scroll synchronized between header and rows on mobile"
    validation: "manual"
    check: "Mobile: scroll header left/right → all rows scroll in sync"

  - name: "Sort Cycle"
    description: "Column sort cycles: none → asc → desc → none, with correct icons"
    validation: "manual"
    check: "Click sortable column 3 times → see ChevronsUpDown → ChevronUp → ChevronDown → ChevronsUpDown"

  - name: "Cell Click Handler"
    description: "onCellClick fires with correct studentId, columnKey, value"
    validation: "automated"
    check: "Unit test: render with onCellClick mock, click cell, verify callback args"

  - name: "Escape Key"
    description: "Esc key closes fullscreen mode"
    validation: "manual"
    check: "Enter fullscreen → press Esc → exits fullscreen"
    status: "FAILING - not implemented"

  - name: "No Hardcoded Values in TypeScript"
    description: "No hardcoded colors, spacing, or breakpoints in .tsx component code"
    validation: "automated"
    check: "ESLint rule blocks: /#[0-9A-Fa-f]{3,6}/, /\\d+px/, /768px/ in .tsx file"
    status: "PASSING"

  - name: "No Hardcoded Values in CSS"
    description: "CSS uses design tokens instead of hardcoded pixel values"
    validation: "automated"
    check: "ESLint/stylelint blocks hardcoded px values in .css file"
    status: "FAILING - CSS contains: 12px, 16px, 200px, 768px, 769px, 8px, 4px, 48px, 60vh, 120px, 150px, 100px"

  - name: "TypeScript Strict"
    description: "Component compiles with TypeScript strict mode"
    validation: "automated"
    check: "tsc --noEmit --strict components/ui/responsive-stats-table.tsx"
    status: "PASSING"

examples:
  - title: "Базовое использование в статистике группы"
    code: |
      <ResponsiveStatsTable
        students={students}
        columns={[
          { key: 'avgScore', label: 'Средний балл', type: 'score', sortable: true },
          { key: 'progress', label: 'Прогресс', type: 'percentage', sortable: true }
        ]}
        data={statsByStudentId}
        stickyStudent
        onCellClick={(id, key, value) => console.log(id, key, value)}
      />
    description: "Десктоп — по кнопке можно развернуть таблицу в fullscreen."

meta:
  author: "AI"
  created: "2025-10-30"
  updated: "2025-10-30"
  status: draft
  links:
    - docs/METACONTRACT.yml
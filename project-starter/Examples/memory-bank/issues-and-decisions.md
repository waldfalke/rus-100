# Журнал проблем и принятых решений

## Проблемы с обработкой больших Excel-файлов

### Проблема: Ошибка "Zip bomb detected" при обработке больших Excel-файлов

**Дата обнаружения:** 2025-04-20

**Описание проблемы:**
При обработке Excel-файла размером 702 МБ (3274998--chitai-gorod.ru.xlsx) возникает ошибка "Zip bomb detected". Система не может обработать ни одной строки из файла.

**Логи:**
```
2025-04-20 12:09:45.839 [main] ERROR org.apache.poi.openxml4j.opc.internal.marshallers.ZipPartMarshaller - Cannot write: /xl/worksheets/sheet1.xml: in ZIP
java.io.IOException: Zip bomb detected! The file would exceed the max size of the expanded data in the zip-file.
This may indicates that the file is used to inflate memory usage and thus could pose a security risk.
You can adjust this limit via ZipSecureFile.setMaxEntrySize() if you need to work with files which are very large.
Uncompressed size: 4294967212, Raw/compressed size: 624355840
Limits: MAX_ENTRY_SIZE: 4294966272, Entry: xl/worksheets/sheet1.xml
```

**Анализ:**
1. Несмотря на установку ZipSecureFile.setMaxEntrySize на значение чуть меньше 4GB (4294966272 байт), система все равно выдает ошибку "Zip bomb detected".
2. Размер несжатых данных (4294967212 байт) превышает установленный лимит на 940 байт.
3. Размер сжатых данных составляет 624355840 байт (примерно 595 МБ).
4. Коэффициент сжатия составляет примерно 6.88 (4294967212 / 624355840).
5. В проекте реализована система автоматического выбора стратегии обработки в зависимости от размера файла, которая должна использовать SaxExcelToCSVStrategy для файлов более 700 МБ.

**Принятые решения:**
1. Использовать систему автоматического выбора стратегии обработки в зависимости от размера файла:
   - StandardProcessingStrategy - для файлов до 100 МБ
   - HybridProcessingStrategy - для файлов от 100 МБ до 500 МБ
   - SegmentedProcessingStrategy - для файлов от 500 МБ до 700 МБ
   - SaxExcelToCSVStrategy - для файлов более 700 МБ
2. Для очень больших файлов (700+ МБ) использовать SaxExcelToCSVStrategy, которая использует SAX-парсер Apache POI для потокового чтения Excel и прямой конвертации в CSV-формат без загрузки всего файла в память.
3. После создания CSV-файла с помощью SAX-парсера, использовать FastCsvToJsonConverter для преобразования данных в JSON.
4. Добавить подробное логирование для отслеживания процесса обработки и использования памяти.
5. Реализовать механизм продолжения обработки даже при возникновении ошибки "Zip bomb detected", если часть данных уже была извлечена.

**Статус:** В процессе решения

---

### Проблема: Ошибка при закрытии OPCPackage

**Дата обнаружения:** 2025-04-20

**Описание проблемы:**
При обработке Excel-файла возникает ошибка при закрытии OPCPackage, связанная с отсутствием поля Factory в классе StyleSheetDocument.

**Логи:**
```
2025-04-20 12:07:40.872 [main] WARN  com.catmepim.strategy.SaxExcelToCSVStrategy - Error closing OPCPackage: Class org.openxmlformats.schemas.spreadsheetml.x2006.main.StyleSheetDocument does not have member field 'org.apache.xmlbeans.impl.schema.DocumentFactory Factory'
```

**Анализ:**
1. Ошибка связана с несовместимостью версий библиотек Apache POI и XMLBeans.
2. Ошибка возникает при закрытии OPCPackage, что может приводить к утечкам ресурсов.
3. Ошибка не критична для процесса обработки, но может влиять на производительность при обработке большого количества файлов.

**Принятые решения:**
1. Добавить обработку исключений при закрытии OPCPackage для предотвращения прерывания процесса обработки.
2. Добавить логирование для отслеживания утечек ресурсов.
3. Рассмотреть возможность обновления версий библиотек Apache POI и XMLBeans для устранения несовместимости.

**Статус:** В процессе решения

---

### Проблема: Нулевое количество обработанных строк

**Дата обнаружения:** 2025-04-20

**Описание проблемы:**
При обработке Excel-файла система сообщает об успешной обработке, но количество обработанных строк равно 0.

**Логи:**
```
2025-04-20 12:09:45.946 [main] DEBUG com.catmepim.strategy.SaxExcelToCSVStrategy - Updated metadata: processed 0 rows in 125222 ms
2025-04-20 12:09:45.947 [main] INFO  com.catmepim.strategy.SaxExcelToCSVStrategy - Successfully processed 0 rows from Excel to CSV in 125223 ms
```

**Анализ:**
1. Система сообщает об успешной обработке файла, но не обработала ни одной строки.
2. Время обработки составило 125223 мс (около 2 минут), что указывает на то, что система выполняла какие-то операции.
3. Вероятно, ошибка "Zip bomb detected" прервала процесс обработки до начала чтения данных.
4. В проекте реализована система автоматического выбора стратегии обработки, которая должна использовать SaxExcelToCSVStrategy для файлов более 700 МБ, но по каким-то причинам эта стратегия не была выбрана или не сработала корректно.

**Принятые решения:**
1. Улучшить обработку ошибок в SaxExcelToCSVStrategy для более точного отражения статуса обработки.
2. Реализовать механизм сегментированной обработки больших Excel-файлов с использованием SAX-парсера, создавая несколько CSV-файлов вместо одного.
3. Добавить дополнительное логирование для отслеживания процесса чтения данных из Excel-файла.
4. Реализовать механизм сборки JSON из нескольких CSV-файлов после их создания.

**Статус:** В процессе решения

---

## Проблемы с ETL-системой

### Проблема: Отсутствие данных в таблице products

**Дата обнаружения:** 2025-04-20

**Описание проблемы:**
Таблица products в базе данных не содержит записей, несмотря на выполнение ETL-процесса.

**Логи:**
```
2025-04-20 00:22:47.617 [main] INFO  c.catmepim.etl.loader.PostgresLoader - Current record count in 'products' table: 0
```

**Анализ:**
1. Система успешно подключается к базе данных и проверяет наличие таблицы products.
2. Количество записей в таблице products равно 0.
3. Вероятно, проблема связана с ошибками при обработке Excel-файлов, которые не позволяют извлечь данные для загрузки в базу данных.
4. Система автоматического выбора стратегии обработки должна использовать SaxExcelToCSVStrategy для файлов более 700 МБ, но по каким-то причинам эта стратегия не срабатывает корректно или не используется.

**Принятые решения:**
1. Реализовать сегментированную обработку больших Excel-файлов с использованием SAX-парсера, создавая несколько CSV-файлов, а затем объединяя их в JSON.
2. Добавить дополнительное логирование в процесс загрузки данных в базу данных.
3. Реализовать механизм проверки целостности данных перед загрузкой в базу данных.
4. Использовать разные стратегии обработки в зависимости от размера файла: EasyExcel для небольших файлов и SAX-парсер для больших.

**Статус:** В процессе решения

---

### Проблема: Избыточность стратегий обработки Excel-файлов

**Дата обнаружения:** 2025-04-20

**Описание проблемы:**
Система стратегий обработки Excel-файлов включает 4 различные стратегии: StandardProcessingStrategy, HybridProcessingStrategy, SegmentedProcessingStrategy и SaxExcelToCSVStrategy. Такое количество стратегий является избыточным и усложняет систему.

**Анализ:**
1. Основной критерий выбора стратегии - размер файла, вторичный - сложность данных (определяемая по конфигурации вендора).
2. Стратегии HybridProcessingStrategy и SegmentedProcessingStrategy решают схожие задачи - обработку файлов среднего размера.
3. Для очень больших файлов (700+ МБ) наиболее эффективна стратегия SaxExcelToCSVStrategy.
4. Для небольших файлов (до 300 МБ) наиболее эффективна стратегия StandardProcessingStrategy.

**Принятые решения:**
1. Упростить систему стратегий до двух основных стратегий:
   - StandardProcessingStrategy - для файлов до 300 МБ
   - SaxExcelToCSVStrategy - для файлов более 300 МБ
2. Заархивировать стратегии HybridProcessingStrategy и SegmentedProcessingStrategy (сохранить код, но не использовать).
3. Упростить класс StrategyThresholds, оставив только один основной порог standardToSaxCsvMB.
4. Добавить параноидальное логирование для отслеживания процесса выбора стратегии.

**Статус:** Выполнено
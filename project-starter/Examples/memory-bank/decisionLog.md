# Decision Log

## Ключевые решения

- Использование формальных методов (K framework, TLA+) для спецификации и верификации ETL и бизнес-логики.
- Модульная архитектура с разделением на core, etl, config для гибкости и расширяемости.
- Хранение конфигураций поставщиков в YAML для удобства и прозрачности.
- Использование PostgreSQL как основной базы данных.
- Запрет на использование `Any` в интерфейсах, строгая статическая типизация.
- Обязательные docstrings для всей кодовой базы.
- Поддержка нескольких форматов данных (Excel, CSV, JSON).
- Внедрение многоуровневой отказоустойчивости и чекпоинтов.
- Ориентация на AI-ассистентов и автоматизацию.
- **Принятие и внедрение централизованных Protocol-интерфейсов (PEP 544) как архитектурного стандарта для всех ядровых и расширяемых компонентов (ConverterProtocol, ETLProtocol, EnrichmentProtocol и др.), с абсолютной типизацией, структурированными docstring-контрактами и стратегическим размещением в рамках плоской структуры (см. PRD 3.0, Interfacing.md, Centralized Protocols).**
- **#DECISION_ID_HYBRID_CONTRACTS: Принятие гибридной стратегии управления контрактами (API, схемы данных, DDL): централизованный репозиторий (SSoT), локальные ссылки/копии в модулях, автоматическая синхронизация и валидация.**
- **#DECISION_ID_GITHUB_PAGES_DEPLOY:** Настройка автоматического деплоя на GitHub Pages через GitHub Actions.
- **#DECISION_ID_DYNAMIC_DIFFICULTY:** Внедрение динамических уровней сложности для генерации тестов на основе статистических данных (см. контракт FEA-002).
## Обоснование решений

- Формальные методы повышают надежность и позволяют верифицировать критичные компоненты, что редко встречается в PIM-системах.
- Модульная архитектура облегчает масштабирование, интеграцию новых поставщиков и поддержку.
- YAML — человекочитаемый формат, упрощающий настройку и версионирование конфигураций.
- PostgreSQL обеспечивает надежное хранение и масштабируемость.
- Строгая типизация и docstrings повышают качество кода и облегчают сопровождение.
- Поддержка разных форматов данных расширяет совместимость с поставщиками.
- Многоуровневая отказоустойчивость минимизирует потери данных и сбоев.
- Интеграция с AI-ассистентами позволяет автоматизировать и ускорять процессы.
- **Централизованные Protocol-интерфейсы и строгие контракты обеспечивают единообразие, расширяемость, прозрачность и AI-дружелюбность архитектуры.**
- **Абсолютная типизация и структурированные docstring-контракты повышают статическую анализируемость, предсказуемость и поддерживаемость кода.**
- **Стратегическое размещение интерфейсов в рамках плоской структуры минимизирует дублирование и облегчает навигацию для AI и разработчиков.**
- **Гибридная стратегия управления контрактами (#DECISION_ID_HYBRID_CONTRACTS) обеспечивает баланс между глобальной консистентностью (SSoT, версионирование) и локальной доступностью (контекст для AI/разработчиков), поддерживает автоматизацию (CI/CD, скрипты синхронизации) и прозрачность (ревью, история), что критически важно для сред с несколькими AI-агентами, IDE и разработчиками.**
- **Настройка автоматического деплоя на GitHub Pages через GitHub Actions (#DECISION_ID_GITHUB_PAGES_DEPLOY) упрощает публикацию и доступ к предпросмотру.**
- **Внедрение динамических уровней сложности (#DECISION_ID_DYNAMIC_DIFFICULTY) позволит создавать более релевантные тесты, используя накопленную статистику (ответ на запрос заказчика).**
## Детали реализации

- Используются Python-библиотеки: Pandas, pyarrow, orjson, polars, ijson.
- Для поиска и сопоставления данных применяются MinHashLSH и fuzzy matching.
- Архитектура поддерживает буферизацию, потоковую обработку, чекпоинты.
- Формальные спецификации разрабатываются на K framework и TLA+.
- Для документации и диаграмм используется Mermaid.
- Проверка типов обеспечивается mypy и pyright.
- **Внедрение централизованных Protocol-интерфейсов реализуется поэтапно:**
    - **Анализ существующих интерфейсов и их миграция к Protocol с абсолютной типизацией.**
    - **Добавление структурированных docstring-контрактов (Google Style) для всех методов.**
    - **Стратегическое размещение интерфейсов согласно принципам контекстной локальности и плоской структуры.**
    - **Интеграция автоматизированных проверок соблюдения стандартов (типизация, docstring, архитектурные требования) в CI/CD.**
    - **Постоянная синхронизация с требованиями PRD 3.0, Interfacing.md и Centralized Protocols.**
    - **Реализация гибридной стратегии управления контрактами (#DECISION_ID_HYBRID_CONTRACTS):**
        - **Создание центрального репозитория для мастер-контрактов (e.g., `/contracts`).**
        - **Внедрение механизма локальных ссылок (e.g., symlinks) или автоматического копирования в модулях.**
        - **Разработка скриптов/хуков для автоматической синхронизации локальных ссылок/копий.**
        - **Интеграция проверок консистентности контрактов в CI/CD.**
        - **Создание и поддержка индекса/карты контрактов (e.g., `contracts.md` или в Memory Bank).**
        - **Определение процесса ревью и валидации для изменений мастер-контрактов.**
    - **#DECISION_ID_GITHUB_PAGES_DEPLOY:** Настройка автоматического деплоя на GitHub Pages через GitHub Actions.
        - **Создание workflow `.github/workflows/nextjs.yml` для сборки и деплоя.**
        - **Включение `output: 'export'` в `next.config.mjs` для статической генерации.**
        - **Добавление шага для создания файла `.nojekyll` для отключения Jekyll.**
        - **Настройка репозитория (Settings -> Pages) на использование "GitHub Actions" в качестве источника.**
        - **Создание контракта инфраструктуры `INF-001_GitHub_Pages_Deployment.md` для документирования.**
    - **#DECISION_ID_DYNAMIC_DIFFICULTY:** Внедрение динамических уровней сложности (см. FEA-002).
        - **Разработка механизма сбора и анализа статистики по вопросам.**
        - **Определение статистических порогов для уровней сложности.**
        - **Модификация UI генератора тестов для отображения динамических уровней.**
        - **Создание контракта `contracts/features/FEA-002_Dynamic_Difficulty_Levels.md`.**

   ---

## Синтез и инсайты (Synthesis & Insights)
_Обобщение ключевых решений, выявленных паттернов и их влияния на проект. Заполняется по итогам анализа решений и обратной связи._

- [ ] (Пример) Синтез: Модульная архитектура позволила ускорить интеграцию новых поставщиков.
- [ ] (Пример) Инсайт: Формальные методы выявили критичные ошибки на ранних этапах.
- [ ] Синтез: Управление контрактами в сложных средах требует гибридного подхода (#DECISION_ID_HYBRID_CONTRACTS) для обеспечения доступности и консистентности для всех агентов (людей и AI).
- [ ] Инсайт: Автоматизация синхронизации и валидации контрактов является ключевым фактором успеха при работе с несколькими AI-ассистентами и IDE.
- [ ] Инсайт: Динамические уровни сложности повысят ценность продукта, но требуют надежной системы сбора данных.

---

## Кросс-ссылки (Cross-References)
_Используйте уникальные ID решений, теги и ссылки на связанные события, изменения и внешние документы (progress.md, activeContext.md, productContext.md, PRD и др.)._

- [ ] (Пример) Решение связано с изменением в activeContext.md от 2025-04-11.
- [ ] (Пример) См. задачу в progress.md #2025-04-10-02.
- [ ] Решение #DECISION_ID_HYBRID_CONTRACTS основано на анализе [@java_tools\(лог-Grok)-контрактное-программирование.md](../java_tools/(лог-Grok)-контрактное-программирование.md) и отражено в отчете [@java_tools\revised_detailed_contract_programming_analysis_report.md](../java_tools/revised_detailed_contract_programming_analysis_report.md).
- [ ] Связано с обновлением activeContext.md от 2025-04-15 (добавление стратегии управления контрактами).
- [ ] Решение #DECISION_ID_DYNAMIC_DIFFICULTY задокументировано в `contracts/features/FEA-002_Dynamic_Difficulty_Levels.md`.

---

## Обратная связь и ретроспектива (Feedback & Retrospective)
_Фиксация обратной связи по принятым решениям, результаты ретроспектив, а также предложения по улучшению процесса принятия решений._

- [ ] (Пример) Обратная связь: Требуется более формализованный процесс документирования решений.
- [ ] (Пример) Итог ретроспективы: Ввести шаблон для ID решений.

---

## Мета-работа и эволюция ролей (Meta-Work & Role Evolution)
_Документирование изменений в процессах принятия решений, распределении ответственности, эволюции ролей и инструментов._

- [ ] (Дата, инициатор) Описание изменения/инициативы, причина, ожидаемый эффект.
- [ ] (Пример) 2025-04-11, Архитектор: Введён шаблон для кросс-ссылок и ID решений.

---

## Регулярный аудит и кураторство (Review & Curation)
_Назначьте ответственных и периодичность аудита для контроля полноты, связности и актуальности решений._

- [ ] Ответственный: Архитектор. Периодичность: не реже одного раза в месяц.
- [ ] Задачи: аудит кросс-ссылок, синтеза, обратной связи, а также обязательная сверка документации с текущими архитектурными стандартами (Protocols, типизация, CI/CD).
- [ ] Важно: Регулярный аудит необходим для предотвращения устаревания документации и поддержания её соответствия коду и стандартам проекта.

# Стратегии обработки Excel-файлов

## Обзор

В системе CATMEPIM реализованы различные стратегии обработки Excel-файлов, оптимизированные для разных размеров файлов и требований к производительности. После упрощения системы используются две основные стратегии:

1. **StandardProcessingStrategy** - для файлов до 300 МБ
2. **SaxExcelToCSVStrategy** - для файлов более 300 МБ

## Стратегии обработки

### StandardProcessingStrategy

Стандартная стратегия обработки Excel-файлов, которая загружает весь файл в память и обрабатывает его целиком. Эта стратегия обеспечивает максимальную скорость обработки для небольших файлов.

**Оптимальна для:**
- Файлов размером до 300 МБ
- Случаев, когда важна скорость обработки
- Файлов с простой структурой

**Преимущества:**
- Высокая скорость обработки
- Простота реализации
- Полный доступ ко всем функциям Excel API

**Недостатки:**
- Высокое потребление памяти
- Не подходит для очень больших файлов
- Может вызывать OutOfMemoryError при обработке больших файлов

### SaxExcelToCSVStrategy

Стратегия обработки Excel-файлов с использованием SAX-парсера, которая не загружает весь файл в память, а обрабатывает его потоково. Эта стратегия оптимальна для очень больших файлов.

**Оптимальна для:**
- Файлов размером более 300 МБ
- Случаев, когда важно низкое потребление памяти
- Файлов с большим количеством строк

**Преимущества:**
- Низкое потребление памяти
- Возможность обработки очень больших файлов
- Устойчивость к ошибкам "Zip bomb detected"

**Недостатки:**
- Более низкая скорость обработки
- Ограниченный доступ к функциям Excel API
- Необходимость промежуточного преобразования в CSV

## Заархивированные стратегии

Следующие стратегии были заархивированы в рамках упрощения системы:

### HybridProcessingStrategy (заархивирована)

Гибридная стратегия обработки Excel-файлов, которая сочетает преимущества потоковой обработки и работы с памятью. Эта стратегия использует многопоточную обработку для повышения производительности.

### SegmentedProcessingStrategy (заархивирована)

Сегментированная стратегия обработки Excel-файлов, которая разбивает файл на сегменты и обрабатывает их по отдельности. Эта стратегия позволяет обрабатывать большие файлы с ограниченным потреблением памяти.

## Выбор стратегии

Выбор стратегии осуществляется автоматически на основе размера файла и требуемого формата вывода. Класс `ExcelProcessingStrategyFactory` содержит методы для создания и выбора наиболее подходящей стратегии.

### Автоматический выбор стратегии

```java
File excelFile = new File("path/to/file.xlsx");
ResourceConstraints constraints = new ResourceConstraints();
ExcelProcessingStrategy strategy = ExcelProcessingStrategyFactory.selectBestStrategy(excelFile, constraints);
```

### Явное указание стратегии

```java
ResourceConstraints constraints = new ResourceConstraints();
ExcelProcessingStrategy strategy = ExcelProcessingStrategyFactory.createStrategy(ProcessingMode.SAX_CSV, constraints);
```

### Настройка порога выбора стратегии

```java
StrategyThresholds thresholds = new StrategyThresholds(500); // 500 МБ
converter.setStrategyThresholds(thresholds);
```

## Логирование

В систему добавлено параноидальное логирование для отслеживания процесса выбора стратегии и обработки файлов:

```
Selecting strategy for file: large_file.xlsx, size: 702 MB
Strategy threshold: 300 MB
Using SAX Excel-to-CSV strategy for large file: 702 MB
```

## Обработка ошибок

Система обработки ошибок улучшена для обеспечения надежной работы даже при возникновении проблем:

- Обработка ошибок "Zip bomb detected"
- Продолжение обработки с частичными данными
- Подробное логирование ошибок и состояния системы

## Рекомендации по использованию

1. Для небольших файлов (до 300 МБ) рекомендуется использовать StandardProcessingStrategy
2. Для больших файлов (более 300 МБ) рекомендуется использовать SaxExcelToCSVStrategy
3. При необходимости можно настроить порог выбора стратегии через StrategyThresholds
4. Для файлов с очень сложной структурой может потребоваться снижение порога выбора стратегии

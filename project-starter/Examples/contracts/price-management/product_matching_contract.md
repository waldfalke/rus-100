# Контракт сопоставления товаров (Product Matching Contract)

## Метаданные
- **Версия**: 1.0.0
- **Статус**: Планируемый
- **Последнее обновление**: 2025-04-20
- **Последний редактор**: AI
- **Ветка разработки**: main

## История изменений
| Дата | Версия | Автор | Описание изменений | PR |
|------|--------|-------|-------------------|-----|
| 2025-04-20 | 1.0.0 | AI | Начальная версия | - |

## Описание
Данный контракт определяет процесс и правила сопоставления товаров из импортируемых прайс-листов с существующими товарами в каталоге системы CATMEPIM. Контракт устанавливает алгоритмы и критерии сопоставления, обработку неоднозначных случаев и процесс обновления цен.

## Интерфейс

```java
package com.catmepim.matching;

import com.catmepim.model.PriceItem;
import com.catmepim.model.Book;
import java.util.List;
import java.util.Optional;

/**
 * Интерфейс для сопоставления товаров из прайс-листов с товарами в каталоге
 */
public interface ProductMatcher {
    
    /**
     * Найти соответствующую книгу в каталоге для элемента прайс-листа
     * 
     * @param priceItem Элемент прайс-листа для сопоставления
     * @return Optional с найденной книгой или пустой, если соответствие не найдено
     */
    Optional<Book> findMatchingBook(PriceItem priceItem);
    
    /**
     * Найти все возможные соответствия для элемента прайс-листа
     * 
     * @param priceItem Элемент прайс-листа для сопоставления
     * @param threshold Порог уверенности (от 0.0 до 1.0)
     * @return Список книг, отсортированный по уверенности соответствия (от высшей к низшей)
     */
    List<MatchResult> findPotentialMatches(PriceItem priceItem, double threshold);
    
    /**
     * Обновить информацию о ценах для книги на основе элемента прайс-листа
     * 
     * @param book Книга для обновления
     * @param priceItem Элемент прайс-листа с информацией о цене
     * @return true, если цена была обновлена, false в противном случае
     */
    boolean updateBookPrice(Book book, PriceItem priceItem);
    
    /**
     * Результат сопоставления с оценкой уверенности
     */
    public static class MatchResult {
        private Book book;
        private double confidence;
        private List<String> matchedFields;
        
        // Геттеры и сеттеры...
    }
}
```

## Процесс сопоставления

### 1. Определение критериев сопоставления

Сопоставление товаров основывается на следующих критериях, приведенных в порядке важности:

1. **ISBN/EAN** - Точное совпадение по ISBN-13, ISBN-10 или EAN (наивысший приоритет)
2. **Название и автор** - Совпадение названия книги и имен авторов
3. **Название и издатель** - Совпадение названия книги и названия издательства
4. **Дополнительные атрибуты** - Совпадение по другим атрибутам (год издания, количество страниц и т.д.)

### 2. Алгоритм сопоставления

```
ФУНКЦИЯ findMatchingBook(priceItem):
    // Шаг 1: Поиск по ISBN/EAN (точное совпадение)
    IF priceItem.isbn НЕ РАВНО null:
        books = findBooksByIsbn(priceItem.isbn)
        IF books.size() == 1:
            ВЕРНУТЬ books.first()
        ELSE IF books.size() > 1:
            // Разрешение конфликтов по дополнительным критериям
            ВЕРНУТЬ resolveConflict(books, priceItem)
    
    // Шаг 2: Поиск по названию и автору (нечеткое совпадение)
    IF priceItem.title НЕ РАВНО null AND priceItem.author НЕ РАВНО null:
        books = findBooksByTitleAndAuthor(priceItem.title, priceItem.author)
        IF books.size() >= 1:
            // Выбор лучшего соответствия или разрешение конфликтов
            bestMatch = selectBestMatch(books, priceItem)
            IF bestMatch.confidence > CONFIDENCE_THRESHOLD:
                ВЕРНУТЬ bestMatch.book
    
    // Шаг 3: Поиск по названию и издателю
    IF priceItem.title НЕ РАВНО null AND priceItem.publisher НЕ РАВНО null:
        books = findBooksByTitleAndPublisher(priceItem.title, priceItem.publisher)
        IF books.size() >= 1:
            bestMatch = selectBestMatch(books, priceItem)
            IF bestMatch.confidence > CONFIDENCE_THRESHOLD:
                ВЕРНУТЬ bestMatch.book
    
    // Соответствие не найдено
    ВЕРНУТЬ Optional.empty()
```

### 3. Методы нечеткого сопоставления

Для сопоставления текстовых полей используются следующие методы:

1. **Очистка и нормализация текста**:
   - Приведение к нижнему регистру
   - Удаление незначащих символов
   - Нормализация пробелов
   - Удаление стоп-слов

2. **Алгоритмы нечеткого сопоставления**:
   - Расстояние Левенштейна
   - Сходство Джаро-Винклера
   - Коэффициент сходства Сёренсена-Дайса
   - TF-IDF для сравнения названий книг

3. **Пороги уверенности**:
   - Высокая уверенность: > 0.9
   - Средняя уверенность: 0.7 - 0.9
   - Низкая уверенность: 0.5 - 0.7
   - Недостаточная уверенность: < 0.5

### 4. Обработка неоднозначных сопоставлений

Когда найдено несколько потенциальных соответствий, система использует следующий подход:

1. **Автоматическое разрешение**:
   - Если одно из соответствий имеет существенно более высокую оценку, оно выбирается автоматически
   - Если найдено точное совпадение по ISBN и другим ключевым атрибутам, оно выбирается автоматически

2. **Ручное разрешение**:
   - Если автоматическое разрешение невозможно, запись помечается для ручного разрешения
   - Оператор получает список потенциальных соответствий с оценками уверенности
   - Оператор может выбрать соответствие или отметить как новый товар

## Инварианты и гарантии

1. **Точность сопоставления**:
   - Автоматическое сопоставление выполняется только при высокой уверенности (> 0.9)
   - При средней уверенности (0.7 - 0.9) требуется подтверждение оператором
   - При низкой уверенности (< 0.7) запись помечается как требующая ручного сопоставления

2. **Обновление цен**:
   - Цены обновляются только для правильно сопоставленных товаров
   - История изменения цен сохраняется в таблице `BookPricesHistory`
   - Конфликтующие цены (значительные отклонения) помечаются для проверки

3. **Логирование**:
   - Все решения о сопоставлении логируются
   - Для каждого элемента прайс-листа сохраняется информация о результате сопоставления

## Реализации

### 1. StandardProductMatcher

Стандартная реализация, использующая все описанные выше алгоритмы сопоставления. Подходит для большинства случаев.

### 2. IsbnOnlyMatcher

Упрощенная реализация, использующая только сопоставление по ISBN. Подходит для поставщиков с надежными данными по ISBN.

### 3. LearningProductMatcher

Реализация с элементами машинного обучения, которая улучшает критерии сопоставления на основе предыдущих решений оператора.

## Примеры использования

### Пример 1: Базовое сопоставление

```java
// Создание экземпляра сопоставителя
ProductMatcher matcher = new StandardProductMatcher();

// Получение элемента прайс-листа
PriceItem priceItem = getPriceItemFromImport();

// Поиск соответствующей книги
Optional<Book> matchedBook = matcher.findMatchingBook(priceItem);

if (matchedBook.isPresent()) {
    // Обновление цены
    matcher.updateBookPrice(matchedBook.get(), priceItem);
    System.out.println("Книга сопоставлена и цена обновлена");
} else {
    System.out.println("Не найдено соответствий, требуется ручная обработка");
}
```

### Пример 2: Работа с неоднозначными соответствиями

```java
// Создание экземпляра сопоставителя
ProductMatcher matcher = new StandardProductMatcher();

// Получение элемента прайс-листа
PriceItem priceItem = getPriceItemFromImport();

// Поиск всех потенциальных соответствий с порогом 0.5
List<MatchResult> potentialMatches = matcher.findPotentialMatches(priceItem, 0.5);

if (potentialMatches.isEmpty()) {
    System.out.println("Соответствий не найдено");
} else if (potentialMatches.size() == 1 && potentialMatches.get(0).getConfidence() > 0.9) {
    // Автоматическое сопоставление при высокой уверенности
    Book book = potentialMatches.get(0).getBook();
    matcher.updateBookPrice(book, priceItem);
    System.out.println("Книга автоматически сопоставлена");
} else {
    // Передача списка потенциальных соответствий оператору
    presentMatchOptionsToOperator(potentialMatches, priceItem);
}
```

## Связанные контракты

- [Price List Import Contract](./price_list_import_contract.md) - Контракт импорта прайс-листов
- [Database Schema Contract](../database/target_schema.md) - Схема базы данных
- [BookPrices Table DDL](../database/target/book_prices.sql) - Определение таблицы цен на книги 
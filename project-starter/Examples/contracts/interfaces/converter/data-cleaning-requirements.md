# Контракт: Требования к очистке данных в конвертере

## Метаданные
- **Версия**: 1.0.0
- **Статус**: Стабильный
- **Последнее обновление**: 2023-11-09
- **Последний редактор**: AI
- **Ветка разработки**: feature/data-cleaning

## История изменений
| Дата | Версия | Автор | Описание изменений | PR |
|------|--------|-------|-------------------|-----|
| 2023-11-09 | 1.0.0 | AI | Начальная версия | - |

## Описание
Данный контракт определяет требования к очистке данных в процессе конвертации Excel-файлов в JSON-формат. Очистка данных является важным этапом обработки, который обеспечивает корректность и согласованность выходных данных.

## Базовая очистка данных в конвертере

Конвертер должен выполнять следующие операции базовой очистки данных:

1. **Обработка пустых значений**:
   - Замена строк "N", "None", "NaN", "null", "-" на `null`
   - Преобразование пустых строк в `null`

2. **Удаление лишних пробелов**:
   - Удаление пробелов в начале и конце строки (trim)
   - Замена множественных пробелов одним пробелом

3. **Удаление специальных символов**:
   - Удаление невидимых управляющих символов (ASCII 0-31, кроме табуляции и переноса строки)
   - Удаление символов нулевой ширины (zero-width spaces)
   - Удаление BOM-маркеров

4. **Нормализация переносов строк**:
   - Приведение всех переносов строк к единому формату

## Реализация метода cleanData

Метод `cleanData` должен реализовывать базовую очистку данных согласно следующему алгоритму:

```java
/**
 * Очищает данные строки от мусора и некорректных значений.
 *
 * @param data исходные данные
 * @return очищенные данные
 */
private Map<Integer, String> cleanData(Map<Integer, String> data) {
    Map<Integer, String> cleanedData = new HashMap<>();
    
    for (Map.Entry<Integer, String> entry : data.entrySet()) {
        Integer key = entry.getKey();
        String value = entry.getValue();
        
        if (value != null) {
            // Удаляем лишние пробелы в начале и конце
            value = value.trim();
            
            // Заменяем множественные пробелы одним
            value = value.replaceAll("\\s+", " ");
            
            // Обрабатываем пустые значения
            if (value.isEmpty() || 
                value.equalsIgnoreCase("N") || 
                value.equalsIgnoreCase("None") || 
                value.equalsIgnoreCase("NaN") || 
                value.equalsIgnoreCase("null") || 
                value.equals("-")) {
                value = null;
            } else {
                // Удаляем невидимые управляющие символы
                value = value.replaceAll("[\\p{Cc}&&[^\t\n\r]]", "");
                
                // Удаляем символы нулевой ширины
                value = value.replaceAll("\\u200B|\\u200C|\\u200D|\\uFEFF", "");
            }
        }
        
        cleanedData.put(key, value);
    }
    
    return cleanedData;
}
```

## Расширенная очистка данных в ETL

Более сложная очистка и нормализация данных должна выполняться на уровне ETL-процесса, а не в конвертере. Это включает:

1. **Нормализация форматирования**:
   - Удаление HTML/XML-тегов
   - Обработка экранированных символов
   - Нормализация форматов дат, чисел и других типов данных

2. **Обработка кодировок**:
   - Нормализация Unicode (NFC или NFD)
   - Обработка некорректных последовательностей UTF-8

3. **Семантическая очистка**:
   - Исправление опечаток
   - Нормализация терминологии
   - Обработка дубликатов

## Валидация результатов

Для проверки качества очистки данных рекомендуется использовать статистический подход:

1. Выбрать случайную выборку из обработанных данных (например, 50 записей)
2. Проверить наличие ключевых полей и корректность их значений
3. Логировать предупреждения при обнаружении проблем, но не прерывать процесс

## Связанные контракты
- [ExcelToJsonConverter Contract](./excel-to-json-converter.md) - Основной контракт конвертера
- [ETL Process Contract](../../ETL-Process-Contract.md) - Общий процесс ETL

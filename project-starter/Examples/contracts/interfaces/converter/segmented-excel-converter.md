# Контракт: SegmentedProcessingStrategy - Сегментированная стратегия обработки

## Метаданные
- **Версия**: 1.0.0
- **Статус**: Стабильный
- **Последнее обновление**: 2023-11-08
- **Последний редактор**: AI
- **Ветка разработки**: feature/adaptive-processing

## История изменений
| Дата | Версия | Автор | Описание изменений | PR |
|------|--------|-------|-------------------|-----|
| 2023-11-08 | 1.0.0 | AI | Преобразование контракта SegmentedExcelConverter в контракт стратегии обработки | - |

## Описание

Сегментированная стратегия обработки (SegmentedProcessingStrategy) представляет собой реализацию интерфейса [ExcelProcessingStrategy](./processing-strategy.md), предназначенную для обработки Excel-файлов очень большого размера. Стратегия разбивает процесс конвертации на сегменты, генерируя промежуточные JSON-файлы, которые затем объединяются в конечный результат.

Данный подход предотвращает проблемы с памятью при обработке больших файлов и позволяет обрабатывать файлы практически любого размера. Стратегия автоматически выбирается для файлов размером более 500 МБ или при явном указании `ProcessingMode.SEGMENTED`.

## Особенности и преимущества

1. **Сегментированная обработка**:
   - Файл разбивается на управляемые сегменты для обработки
   - Значительно снижает потребление памяти
   - Предотвращает ошибки "Zip bomb detected" и OutOfMemoryError

2. **Отказоустойчивость**:
   - Возможность восстановления обработки с последнего чекпоинта
   - Сохранение промежуточных результатов для защиты от сбоев

3. **Высокая производительность**:
   - Оптимизирована для файлов размером более 500 МБ
   - Потоковое объединение сегментов без загрузки всех данных в память
   - Многопоточная обработка сегментов (опционально)

## Параметры стратегии

Стратегия использует класс `SegmentedStrategyParameters` для настройки:

```java
/**
 * Параметры для сегментированной стратегии обработки.
 */
public class SegmentedStrategyParameters {
    /**
     * Размер сегмента в строках (по умолчанию 10000).
     */
    private int segmentSize = 10000;

    /**
     * Директория для временных файлов (по умолчанию системная temp).
     */
    private File tempDir = new File(System.getProperty("java.io.tmpdir"));

    /**
     * Сохранять ли временные файлы после завершения (по умолчанию false).
     */
    private boolean keepTempFiles = false;

    /**
     * Создавать чекпоинты для возможности восстановления (по умолчанию true).
     */
    private boolean createCheckpoints = true;

    /**
     * Директория для чекпоинтов (по умолчанию подпапка в temp).
     */
    private File checkpointsDir;

    /**
     * Максимальный размер буфера в МБ для обработки каждого сегмента (по умолчанию 128).
     */
    private int maxBufferSizeMB = 128;

    // Конструкторы

    /**
     * Конструктор по умолчанию.
     */
    public SegmentedStrategyParameters() {
        this.checkpointsDir = new File(tempDir, "excel_checkpoints");
    }

    /**
     * Конструктор с указанием размера сегмента.
     *
     * @param segmentSize размер сегмента в строках
     */
    public SegmentedStrategyParameters(int segmentSize) {
        this();
        this.segmentSize = segmentSize;
    }

    /**
     * Конструктор с указанием размера сегмента и директории для временных файлов.
     *
     * @param segmentSize размер сегмента в строках
     * @param tempDir директория для временных файлов
     */
    public SegmentedStrategyParameters(int segmentSize, File tempDir) {
        this(segmentSize);
        this.tempDir = tempDir;
        this.checkpointsDir = new File(tempDir, "excel_checkpoints");
    }

    // Геттеры и сеттеры для всех полей
    // ... (с цепочечным стилем для сеттеров)
}
```

## Технические детали

### Механизм сегментации
1. Анализ файла для определения общего количества строк
2. Разделение на сегменты размером `segmentSize` строк
3. Последовательная обработка каждого сегмента с созданием промежуточных JSON-файлов
4. Объединение всех сегментов в единый результат

### Обработка ошибок
- Сохранение состояния после каждого сегмента
- Запись метаданных для возможности восстановления
- Пропуск проблемных строк (с записью в лог) для предотвращения остановки всего процесса

### Очистка данных
- Интеграция с JsonCleaner для нормализации данных
- Обработка специфических проблем формата и кодировки
- Применение типовых преобразований к каждому сегменту

### Интеграция с ExcelToJsonConverter
Стратегия полностью интегрируется с [ExcelToJsonConverter](./excel-to-json-converter.md) и может быть выбрана автоматически или указана явно:

```java
// Пример явного указания сегментированной стратегии
ExcelToJsonConverter converter = new ExcelToJsonConverter();
converter.setProcessingMode(ProcessingMode.SEGMENTED);

// Дополнительная настройка параметров стратегии
SegmentedStrategyParameters params = new SegmentedStrategyParameters()
    .setSegmentSize(5000)
    .setMaxBufferSizeMB(256)
    .setCreateCheckpoints(true);

converter.setStrategyParameters(params);

// Использование конвертера
converter.convert("huge_file.xlsx", "output.json");
```

## Выбор стратегии

Сегментированная стратегия автоматически выбирается в следующих случаях:
1. Размер файла превышает 500 МБ
2. Недостаточно памяти для гибридной обработки
3. Высокий показатель сложности файла (много листов, форматирования, формул)
4. Предыдущие попытки обработки завершились ошибкой OutOfMemoryError

## Производительность и оптимизации

### Метрики производительности
- Для файла 1 ГБ: обработка за ~5-8 минут при использовании 200-300 МБ памяти
- Для файла 5 ГБ: обработка за ~25-35 минут при использовании 300-400 МБ памяти

### Оптимизации
1. **Параллельная обработка**:
   - Возможность обрабатывать несколько сегментов одновременно
   - Автоматическая настройка количества потоков в зависимости от доступных ресурсов

2. **Предварительный анализ**:
   - Сканирование файла для оптимальной стратегии сегментации
   - Определение структуры данных для оптимизации обработки

3. **Умное кэширование**:
   - Кэширование часто используемых данных (заголовки, стили, форматы)
   - Предотвращение повторного разбора общих элементов

4. **Сжатие временных файлов**:
   - Автоматическое сжатие промежуточных файлов
   - Экономия дискового пространства при длительной обработке

## Связанные контракты

- [ExcelProcessingStrategy Contract](./processing-strategy.md) - Общий интерфейс для всех стратегий обработки
- [ExcelToJsonConverter Contract](./excel-to-json-converter.md) - Основной конвертер с адаптивными стратегиями
- [Data Cleaning Requirements](./data-cleaning-requirements.md) - Требования к очистке данных
- [Strategy Selection Requirements](./strategy-selection-requirements.md) - Требования к выбору стратегии
- [ETL Process Contract](../../ETL-Process-Contract.md) - Общий процесс ETL
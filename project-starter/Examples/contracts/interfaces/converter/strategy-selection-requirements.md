# Контракт: Требования к выбору стратегии обработки

## Метаданные
- **Версия**: 1.0.0
- **Статус**: Стабильный
- **Последнее обновление**: 2023-11-09
- **Последний редактор**: AI
- **Ветка разработки**: feature/strategy-selection

## История изменений
| Дата | Версия | Автор | Описание изменений | PR |
|------|--------|-------|-------------------|-----|
| 2023-11-09 | 1.0.0 | AI | Начальная версия | - |

## Описание
Данный контракт определяет требования к механизму выбора стратегии обработки Excel-файлов в процессе конвертации в JSON-формат. Правильный выбор стратегии обработки критически важен для обеспечения оптимальной производительности и надежности процесса конвертации.

## Основные критерии выбора стратегии

Выбор стратегии обработки должен основываться на следующих критериях:

1. **Размер файла** (основной критерий):
   - До 100 МБ: Стандартная стратегия
   - От 100 МБ до 500 МБ: Гибридная стратегия
   - Более 500 МБ: Сегментированная стратегия

2. **Профиль вендора** (дополнительный критерий):
   - Если профиль вендора определен и соответствует ожиданиям, можно использовать менее консервативную стратегию
   - Если профиль вендора не определен или не соответствует ожиданиям, следует использовать более консервативную стратегию

3. **Доступные ресурсы системы**:
   - Объем доступной памяти
   - Количество доступных процессоров
   - Доступное дисковое пространство

## Реализация выбора стратегии

Метод `selectBestStrategy` должен реализовывать выбор стратегии согласно следующему алгоритму:

```java
/**
 * Выбирает наиболее подходящую стратегию для указанного файла.
 *
 * @param excelFile файл Excel для оценки
 * @param resourceConstraints ограничения ресурсов
 * @param vendorProfile профиль вендора (может быть null)
 * @return наиболее подходящая стратегия обработки
 * @throws IOException при ошибке доступа к файлу
 */
public static ExcelProcessingStrategy selectBestStrategy(
        File excelFile, 
        ResourceConstraints resourceConstraints,
        VendorProfile vendorProfile) throws IOException {
    
    // Анализируем размер файла
    long fileSizeMB = excelFile.length() / (1024 * 1024);
    StrategyThresholds thresholds = new StrategyThresholds();
    
    // Учитываем профиль вендора для корректировки порогов
    double complexityFactor = 1.0;
    if (vendorProfile != null) {
        if (vendorProfile.isKnown() && vendorProfile.isCompliant()) {
            // Известный и соответствующий вендор - меньше сложность
            complexityFactor = 0.8;
        } else {
            // Неизвестный или несоответствующий вендор - больше сложность
            complexityFactor = 1.2;
        }
    }
    
    // Применяем фактор сложности к порогам
    long adjustedHybridThreshold = (long)(thresholds.getHybridToSegmentedMB() * complexityFactor);
    long adjustedStandardThreshold = (long)(thresholds.getStandardToHybridMB() * complexityFactor);
    
    // Выбираем стратегию на основе скорректированных порогов
    if (fileSizeMB > adjustedHybridThreshold) {
        return createStrategy(ProcessingMode.SEGMENTED, resourceConstraints);
    } else if (fileSizeMB > adjustedStandardThreshold) {
        return createStrategy(ProcessingMode.HYBRID, resourceConstraints);
    } else {
        return createStrategy(ProcessingMode.STANDARD, resourceConstraints);
    }
}
```

## Приоритеты оптимизаций

Оптимизации, описанные в контрактах стратегий, имеют следующие приоритеты:

1. **Обязательные оптимизации**:
   - Базовая очистка данных
   - Обработка ошибок с продолжением процесса
   - Проверка предусловий методов

2. **Рекомендуемые оптимизации**:
   - Многопоточная обработка в гибридной стратегии
   - Контрольные точки в сегментированной стратегии
   - Статистическая валидация результатов

3. **Опциональные оптимизации**:
   - Параллельная обработка сегментов
   - Умное кэширование часто используемых данных
   - Сжатие временных файлов
   - Предварительный анализ файла для оптимальной стратегии сегментации

## Обработка ошибок

При возникновении ошибок в процессе обработки:

1. Процесс должен продолжать работу, если это возможно
2. Ошибки должны логироваться с достаточной информацией для диагностики
3. При критических ошибках, которые делают невозможным продолжение обработки, должно выбрасываться соответствующее исключение

## Связанные контракты
- [ExcelToJsonConverter Contract](./excel-to-json-converter.md) - Основной контракт конвертера
- [ProcessingStrategy Contract](./processing-strategy.md) - Общий интерфейс стратегий обработки
- [SegmentedProcessingStrategy Contract](./segmented-excel-converter.md) - Сегментированная стратегия обработки

# Контракт типов переплета (Binding Types Contract)

## Метаданные
| Атрибут | Значение |
|---------|----------|
| Версия | 1.0.0 |
| Статус | Планируемый |
| Последнее обновление | 2025-04-26 |
| Последний редактор | AI |

## История изменений
| Дата | Версия | Автор | Описание изменений | PR |
|------|--------|-------|-------------------|-----|
| 2025-04-26 | 1.0.0 | AI | Начальная версия | - |

## Описание

Контракт типов переплета определяет структуру и правила работы с данными о типах переплета (обложки) книг в системе CATMEPIM. Контракт регламентирует хранение стандартизированных значений типов переплета и обеспечивает механизм нормализации различных вариантов названий типов переплета через систему синонимов.

## Цели и задачи

**Основная цель**: Обеспечить единообразие данных о типах переплета книг при импорте из различных источников.

**Задачи**:
1. Определить структуру хранения стандартизированных типов переплета
2. Обеспечить связь с системой синонимов для нормализации вариантов названий
3. Определить процесс маппинга и нормализации при импорте данных
4. Предоставить API для работы с типами переплета

## Структура хранения данных

### Таблица binding_types
Справочная таблица для стандартизированных типов переплета.

| Поле | Тип | Описание |
|------|-----|----------|
| id | SERIAL | Первичный ключ |
| code | VARCHAR(30) | Стандартный код типа переплета (HC, PB, IB) |
| name | VARCHAR(100) | Стандартное название типа переплета |
| description | TEXT | Описание типа переплета |
| data | JSONB | Дополнительные данные в JSON-формате |
| created_at | TIMESTAMP | Дата создания |
| updated_at | TIMESTAMP | Дата обновления |

#### Содержимое поля data (JSONB)
```json
{
  "display_order": 1,                // Порядок отображения
  "image_url": "https://example.com/bindings/hardcover.jpg",  // Изображение
  "properties": {                    // Дополнительные свойства
    "durability": "high",
    "weight": "heavy"
  }
}
```

### Связь с системой синонимов
Типы переплета используют общую систему синонимов, описанную в [Контракте синонимов](./synonyms_contract.md). Каждый стандартизированный тип переплета имеет набор синонимов в системе.

#### Пример записи в системе синонимов:
```json
{
  "standard_entity": {
    "type": "binding_type",
    "id": 1,
    "name": "Твердый переплет"
  },
  "synonyms": [
    {"value": "твердый", "source": "supplier_1"},
    {"value": "тв.пер.", "source": "supplier_2"},
    {"value": "твердая обложка", "source": "supplier_3"},
    {"value": "hardcover", "source": "en_translation"},
    {"value": "HC", "source": "international_code"},
    {"value": "ТП", "source": "abbreviation"}
  ]
}
```

## Стандартизированные типы переплета

| ID | Код | Название | Описание |
|----|-----|----------|----------|
| 1 | HC | Твердый переплет | Книги с твердой обложкой, прочным переплетом и прошитыми страницами |
| 2 | PB | Мягкий переплет | Книги с гибкой обложкой из картона или плотной бумаги |
| 3 | IB | Интегральный переплет | Книги с гибкой обложкой с загнутыми клапанами |
| 4 | SP | Спиральный переплет | Книги, скрепленные спиралью или пружиной |
| 5 | FB | Французский переплет | Книги с кожаным корешком и твердыми крышками |
| 6 | BE | Бесшвейное скрепление | Книги, скрепленные клеем без сшивания |
| 7 | LE | Кожаный переплет | Книги в кожаном переплете |
| 8 | CL | Тканевый переплет | Книги в тканевом переплете |

## Процесс нормализации при импорте

1. Получение значения типа переплета из источника
2. Поиск соответствующего синонима в системе синонимов
3. Определение стандартизированного типа переплета через связь с синонимом
4. Сохранение ID стандартизированного типа переплета в записи о книге

### Пример маппинга значений из разных источников

| Значение в источнике | Синоним в системе | Стандартизированный тип |
|----------------------|-------------------|-------------------------|
| "тв/п" | "тв/п" | Твердый переплет (ID=1) |
| "мягкая" | "мягкая" | Мягкий переплет (ID=2) |
| "7Б" | "7Б" | Интегральный переплет (ID=3) |
| "Hardcover" | "hardcover" | Твердый переплет (ID=1) |
| "Pocketbook" | "pocketbook" | Мягкий переплет (ID=2) |

## Хранение типа переплета в продукте

### Вариант 1: Прямая ссылка в таблице products
```sql
ALTER TABLE products ADD COLUMN binding_type_id INTEGER REFERENCES binding_types(id);
```

### Вариант 2: Хранение в JSON-поле data
```json
{
  "binding": {
    "type_id": 1,
    "original_text": "тв/п",
    "properties": {
      "material": "картон",
      "thickness": "3 мм"
    }
  }
}
```

## API для работы с типами переплета

### Базовые операции

```java
/**
 * Получение типа переплета по ID
 */
BindingType getBindingType(Integer id);

/**
 * Получение всех типов переплета
 */
List<BindingType> getAllBindingTypes();

/**
 * Получение типа переплета по коду
 */
BindingType getBindingTypeByCode(String code);

/**
 * Нормализация значения типа переплета через систему синонимов
 */
BindingType normalizeBindingType(String value);

/**
 * Создание нового типа переплета
 */
BindingType createBindingType(BindingType bindingType);

/**
 * Обновление существующего типа переплета
 */
BindingType updateBindingType(Integer id, BindingType bindingType);

/**
 * Добавление синонима для типа переплета
 */
void addSynonymForBindingType(Integer bindingTypeId, String synonym, String source);
```

### Пример использования API

```java
// Нормализация значения типа переплета из источника
String rawValue = "тв/п";
BindingType standardType = bindingTypeService.normalizeBindingType(rawValue);

// Получение всех типов переплета для выпадающего списка
List<BindingType> allTypes = bindingTypeService.getAllBindingTypes();

// Добавление нового синонима
bindingTypeService.addSynonymForBindingType(1, "твердая в суперобложке", "supplier_4");
```

## Примеры сценариев использования

### Сценарий 1: Импорт книг с различными обозначениями переплета
```
1. Загрузка Excel-файла от поставщика с данными о книгах
2. Извлечение значений типа переплета из файла
3. Для каждого значения:
   a. Поиск в системе синонимов
   b. Если синоним найден, использование связанного стандартного типа
   c. Если синоним не найден, запрос на добавление нового синонима
4. Сохранение книг с нормализованными типами переплета
```

### Сценарий 2: Обновление справочника типов переплета
```
1. Добавление нового стандартизированного типа переплета
2. Определение базового набора синонимов для нового типа
3. Добавление синонимов в систему
4. Обновление существующих книг, которые могут соответствовать новому типу
```

## Связь с другими контрактами

- [Database Schema Contract](./database_schema_contract.md) - Общая схема базы данных
- [Product Contract](./product_contract.md) - Контракт работы с товарами
- [Synonyms Contract](./synonyms_contract.md) - Контракт работы с синонимами
- [ETL Process Contract](../ETL-Process-Contract.md) - Процессы ETL

## Инварианты

1. Каждый тип переплета должен иметь уникальный код и название
2. Каждый синоним должен быть связан с одним и только одним стандартизированным типом переплета
3. При импорте данных все варианты типов переплета должны быть нормализованы
4. Продукт может иметь только один тип переплета (в отличие от категорий или авторов)

## Ограничения и допущения

1. Система поддерживает до 50 стандартизированных типов переплета
2. Для каждого типа переплета может быть неограниченное количество синонимов
3. Для статистических целей допускается временное сохранение оригинального значения из источника
4. Типы переплета не имеют иерархической структуры (в отличие от категорий)
5. Контракт не предусматривает локализацию названий типов переплета на разные языки (используется только русский) 
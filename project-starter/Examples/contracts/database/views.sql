-- Контракт: DDL для представлений
-- Версия: 1.0.0
-- Статус: Актуальный
-- Последнее обновление: 2025-04-20
-- Последний редактор: AI

-- Описание:
-- Этот файл содержит определения представлений (views) базы данных CATMEPIM,
-- которые обеспечивают удобный доступ к данным, хранящимся в формате JSONB.

-- Предусловия:
-- 1. Таблица products должна быть создана
-- 2. Поле data таблицы products должно содержать валидный JSON с ожидаемой структурой
-- 3. База данных должна поддерживать оператор ->>, возвращающий поле JSONB как text

-- Инварианты:
-- 1. Представления должны предоставлять доступ ко всем ключевым полям данных
-- 2. Изменения в основной таблице должны немедленно отражаться в представлениях

-- Представление для удобного доступа к данным продуктов
CREATE OR REPLACE VIEW products_view AS
SELECT
    id,
    data->>'Артикул' as артикул,
    data->>'Название' as название,
    data->>'Категория' as категория,
    data->>'Бренд' as бренд,
    data->>'Цена' as цена,
    data->>'Валюта' as валюта,
    data->>'Наличие' as наличие,
    data->>'Раздел' as раздел,
    data->>'Автор' as автор,
    data->>'Издательство' as издательство,
    data->>'Серия' as серия,
    data->>'Год издания' as год_издания,
    data->>'Кол-во страниц' as количество_страниц,
    data->>'Размеры' as размер,
    data->>'Переплет' as тип_обложки,
    data->>'Год, тираж' as тираж,
    data->>'Вес' as вес,
    data->>'Краткое описание' as краткое_описание,
    data->>'Описание' as описание,
    data->>'ИСБН' as isbn,
    created_at,
    updated_at
FROM products;

-- Комментарий к представлению
COMMENT ON VIEW products_view IS 'Представление для удобного доступа к данным продуктов';

-- Представление для книг (фильтрует только продукты с категорией, содержащей "книги" или с наличием ISBN)
CREATE OR REPLACE VIEW books_view AS
SELECT *
FROM products_view
WHERE 
    lower(категория) LIKE '%книг%' OR
    isbn IS NOT NULL; 
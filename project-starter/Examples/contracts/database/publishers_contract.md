# Контракт издательств (Publishers Contract)

## Метаданные
| Атрибут | Значение |
|---------|----------|
| Версия | 1.0.0 |
| Статус | Планируемый |
| Последнее обновление | 2025-04-25 |
| Последний редактор | AI |

## История изменений
| Дата | Версия | Автор | Описание изменений | PR |
|------|--------|-------|-------------------|-----|
| 2025-04-25 | 1.0.0 | AI | Начальная версия | - |

## Описание

Контракт издательств определяет структуру и правила работы с данными об издательствах книг в системе CATMEPIM. Контракт регламентирует хранение, импорт, нормализацию данных об издательствах и их импринтах (дочерних издательствах) в рамках ETL-процессов системы.

## Цели и задачи

**Основная цель**: Обеспечить единый подход к работе с данными об издательствах при создании Архетипов книг.

**Задачи**:
1. Определить структуру хранения данных об издательствах в базе данных
2. Описать процесс импорта и нормализации данных об издательствах из внешних источников
3. Определить правила обработки иерархической структуры издательств (импринтов)
4. Обеспечить дедупликацию и объединение записей об издательствах
5. Определить правила связывания издательств с продуктами

## Структура хранения данных

### Таблица publishers
Основная таблица для хранения данных об издательствах.

| Поле | Тип | Описание |
|------|-----|----------|
| id | BIGSERIAL | Первичный ключ |
| name | VARCHAR(255) | Название издательства |
| description | TEXT | Описание издательства |
| parent_id | BIGINT | ID родительского издательства (для импринтов) |
| data | JSONB | Дополнительные данные в JSON-формате |
| status | VARCHAR(20) | Статус (active, inactive, merged) |
| created_at | TIMESTAMP | Дата создания |
| updated_at | TIMESTAMP | Дата обновления |

#### Содержимое поля data (JSONB)
```json
{
  "legal_name": "ООО «Издательство «Эксмо»",  // Юридическое название
  "founded_date": "1991-01-15",              // Дата основания
  "closed_date": null,                       // Дата закрытия (если применимо)
  "website": "https://eksmo.ru",             // Веб-сайт
  "contact": {                               // Контактная информация
    "email": "info@eksmo.ru",
    "phone": "+7 (495) 411-68-86",
    "address": "123308, Москва, ул. Зорге, 1"
  },
  "genres": ["художественная", "нон-фикшн"],  // Основные жанры
  "languages": ["русский"],                   // Основные языки публикаций
  "logo_url": "https://example.com/logos/eksmo.png", // URL логотипа
  "external_ids": {                          // Идентификаторы во внешних системах
    "isbn_publisher_code": "5-04"
  }
}
```

## Иерархия издательств

Издательства в системе организованы в иерархическую структуру:

1. **Издательская группа** (верхний уровень) - крупная компания, владеющая несколькими издательствами (например, "Eksmo-AST Publishing Group")
2. **Издательство** (средний уровень) - основное издательство (например, "Эксмо", "АСТ")
3. **Импринт** (нижний уровень) - дочернее издательство с собственным брендом и направлением публикаций (например, "ЭКСМО-Детство", "Corpus")

Связи между уровнями представлены через поле `parent_id` в таблице `publishers`, которое указывает на родительское издательство.

## Импорт и нормализация данных

### Источники данных об издательствах
1. Excel-файлы от поставщиков
2. Каталоги ISBN и национальные библиотеки
3. Открытые API и каталоги издательств
4. Ручной ввод данных

### Процесс импорта
1. Извлечение данных об издательствах из источника
2. Нормализация названий издательств (удаление лишних пробелов, исправление регистра)
3. Поиск существующих издательств в базе для предотвращения дублей
4. Определение иерархической структуры (родительские издательства и импринты)
5. Создание новых или обновление существующих записей

### Маппинг полей
Пример сопоставления полей из Excel-файла поставщика:

| Поле в источнике | Поле в системе | Трансформация |
|-----------------|----------------|--------------|
| Издательство | name | trim(), capitalize() |
| Импринт | parent_id | resolve_parent() |
| Адрес | data->contact->address | normalize_address() |
| Сайт | data->website | normalize_url() |

### Примеры правил нормализации названий издательств
```
"ЭКСМО" -> "Эксмо" (нормализация регистра)
"изд-во АСТ" -> "АСТ" (удаление префикса)
"Издательство \"Просвещение\"" -> "Просвещение" (удаление кавычек и префикса)
```

## Дедупликация издательств

### Критерии определения дубликатов
1. **Точное совпадение**: Идентичные названия с учетом регистра и пробелов
2. **Нечеткое совпадение**: Похожие названия (расстояние Левенштейна < 3)
3. **Префиксы и суффиксы**: Названия с общими словами-маркерами ("Издательство", "Изд-во", "ООО")
4. **Метаданные**: Совпадение адреса, веб-сайта, ISBN-префикса

### Процесс объединения записей
1. Определение основной (целевой) записи и записи-дубля
2. Объединение описаний и контактных данных (приоритет более полной информации)
3. Обновление связей продуктов с издательствами
4. Маркировка дублирующей записи как `merged` с указанием ID основной записи
5. Запись информации о слиянии в журнал изменений

## API для работы с издательствами

### Базовые операции

```java
/**
 * Получение издательства по ID
 */
Publisher getPublisher(Long id);

/**
 * Поиск издательств по различным критериям
 */
List<Publisher> findPublishers(PublisherSearchCriteria criteria, Pagination pagination);

/**
 * Создание нового издательства
 */
Publisher createPublisher(Publisher publisher);

/**
 * Обновление существующего издательства
 */
Publisher updatePublisher(Long id, Publisher publisher);

/**
 * Получение дочерних издательств (импринтов)
 */
List<Publisher> getChildPublishers(Long parentId);

/**
 * Объединение дублирующихся записей издательств
 */
MergeResult mergePublishers(Long sourceId, Long targetId, MergeOptions options);
```

### Поиск издательств

```java
/**
 * Критерии поиска издательств
 */
class PublisherSearchCriteria {
    String nameLike;           // Поиск по названию (с поддержкой символов * и ?)
    Long parentId;             // Поиск по родительскому издательству
    Boolean isTopLevel;        // Только издательства верхнего уровня
    List<String> genres;       // Фильтр по жанрам
    String status;             // Фильтр по статусу
}
```

### Пример использования API

```java
// Поиск издательств по названию
PublisherSearchCriteria criteria = new PublisherSearchCriteria();
criteria.setNameLike("Экс*");
Pagination pagination = new Pagination(0, 10);
List<Publisher> publishers = publisherService.findPublishers(criteria, pagination);

// Получение всех импринтов издательства
List<Publisher> imprints = publisherService.getChildPublishers(42L);

// Объединение дублирующихся записей
MergeOptions options = new MergeOptions();
options.setUpdateProducts(true);
MergeResult result = publisherService.mergePublishers(123L, 456L, options);
```

## Примеры сценариев использования

### Сценарий 1: Импорт данных об издательствах из каталога ISBN
```
1. Загрузка файла с кодами издательств ISBN
2. Извлечение данных об издательствах (код, название, адрес)
3. Нормализация названий издательств согласно правилам
4. Проверка существования издательств в базе данных
5. Создание новых записей для издательств, отсутствующих в базе
6. Обновление существующих записей для издательств, уже присутствующих в базе
7. Запись ISBN-кодов издательств в поле data.external_ids.isbn_publisher_code
```

### Сценарий 2: Создание иерархии издательства и его импринтов
```
1. Создание основного издательства (например, "Эксмо")
2. Создание дочерних издательств (импринтов) с указанием parent_id
3. Обновление информации о жанровой специализации для каждого импринта
4. Назначение соответствующих продуктов каждому импринту
```

## Связь с другими контрактами

- [Database Schema Contract](./database_schema_contract.md) - Общая схема базы данных
- [Product Contract](./product_contract.md) - Контракт работы с товарами
- [ETL Process Contract](../ETL-Process-Contract.md) - Процессы ETL
- [Data Lineage Contract](./data_lineage_contract.md) - Отслеживание происхождения данных

## Инварианты

1. У каждого издательства должно быть заполнено поле `name`
2. Названия издательств должны быть уникальными (с учетом нормализации)
3. В иерархии издательств не должно быть циклических зависимостей (издательство не может быть собственным родителем или предком)
4. При объединении издательств все связи с продуктами должны сохраняться
5. Дата закрытия издательства не может быть раньше даты его основания

## Ограничения и допущения

1. Система поддерживает до 50 000 издательств
2. Название издательства может содержать до 255 символов
3. Глубина иерархии издательств ограничена тремя уровнями (издательская группа, издательство, импринт)
4. Не предусмотрена сложная система учета изменений владения издательствами
5. ISBN-коды издательств хранятся в поле data.external_ids.isbn_publisher_code 
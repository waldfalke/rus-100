# Контракт авторов (Authors Contract)

## Метаданные
| Атрибут | Значение |
|---------|----------|
| Версия | 1.0.0 |
| Статус | Планируемый |
| Последнее обновление | 2025-04-25 |
| Последний редактор | AI |

## История изменений
| Дата | Версия | Автор | Описание изменений | PR |
|------|--------|-------|-------------------|-----|
| 2025-04-25 | 1.0.0 | AI | Начальная версия | - |

## Описание

Контракт авторов определяет структуру и правила работы с данными об авторах книг в системе CATMEPIM. Контракт регламентирует хранение, импорт, нормализацию и связывание авторов с продуктами (книгами) в рамках ETL-процессов системы.

## Цели и задачи

**Основная цель**: Обеспечить единый подход к работе с данными об авторах при создании Архетипов книг.

**Задачи**:
1. Определить структуру хранения данных об авторах в базе данных
2. Описать процесс импорта и нормализации данных об авторах из внешних источников
3. Определить правила связывания авторов с книгами
4. Обеспечить поддержку псевдонимов и альтернативных написаний имен авторов
5. Обеспечить дедупликацию и объединение записей об авторах

## Структура хранения данных

### Таблица authors
Основная таблица для хранения данных об авторах.

| Поле | Тип | Описание |
|------|-----|----------|
| id | BIGSERIAL | Первичный ключ |
| name | VARCHAR(255) | Имя автора |
| original_name | VARCHAR(255) | Оригинальное написание имени (для иностранных авторов) |
| biography | TEXT | Биография автора |
| data | JSONB | Дополнительные данные в JSON-формате |
| status | VARCHAR(20) | Статус (active, merged) |
| created_at | TIMESTAMP | Дата создания |
| updated_at | TIMESTAMP | Дата обновления |

#### Содержимое поля data (JSONB)
```json
{
  "birth_date": "1960-01-01",       // Дата рождения
  "birth_place": "Москва, Россия",  // Место рождения
  "death_date": null,               // Дата смерти (если применимо)
  "death_place": null,              // Место смерти (если применимо)
  "nationality": "русский",         // Национальность
  "languages": ["русский", "английский"], // Языки, на которых пишет автор
  "genres": ["фантастика", "детектив"], // Основные жанры
  "awards": [                        // Награды
    {
      "name": "Премия Х",
      "year": 2010,
      "work": "Название произведения"
    }
  ],
  "image_url": "https://example.com/authors/123.jpg", // URL основного изображения
  "external_links": {                // Ссылки на внешние ресурсы
    "website": "https://author-site.com",
    "wikipedia": "https://ru.wikipedia.org/wiki/Автор"
  },
  "external_ids": {                 // Идентификаторы во внешних системах
    "goodreads": "12345",
    "librarything": "67890"
  }
}
```

### Таблица author_aliases
Хранит псевдонимы и альтернативные написания имен авторов.

| Поле | Тип | Описание |
|------|-----|----------|
| id | BIGSERIAL | Первичный ключ |
| author_id | BIGINT | Ссылка на основную запись автора |
| alias_name | VARCHAR(255) | Имя псевдонима |
| alias_type | VARCHAR(50) | Тип псевдонима (pen_name, variation, translation) |
| language | VARCHAR(10) | Язык псевдонима (для переводов) |
| is_primary | BOOLEAN | Является ли основным псевдонимом |
| created_at | TIMESTAMP | Дата создания |
| updated_at | TIMESTAMP | Дата обновления |

### Таблица product_authors
Связь авторов с продуктами (книгами).

| Поле | Тип | Описание |
|------|-----|----------|
| product_id | BIGINT | Ссылка на продукт |
| author_id | BIGINT | Ссылка на автора |
| role | VARCHAR(50) | Роль автора (author, editor, translator, illustrator) |
| sequence | INT | Порядок авторов в продукте |
| created_at | TIMESTAMP | Дата создания |
| updated_at | TIMESTAMP | Дата обновления |

## Импорт и нормализация данных

### Источники данных об авторах
1. Excel-файлы от издательств и поставщиков
2. Базы данных литературных сайтов
3. Открытые API библиотек и литературных ресурсов
4. Ручной ввод данных

### Процесс импорта
1. Извлечение данных об авторах из источника
2. Нормализация имен авторов (удаление лишних пробелов, исправление регистра)
3. Поиск существующих авторов в базе для предотвращения дублей
4. Создание новых или обновление существующих записей
5. Создание связей с продуктами

### Маппинг полей
Пример сопоставления полей из Excel-файла издательства "Эксмо":

| Поле в источнике | Поле в системе | Трансформация |
|-----------------|----------------|--------------|
| Автор | name | trim(), capitalize() |
| Биография | biography | sanitize_html() |
| Дата рождения | data->birth_date | parse_date() |
| Псевдоним | author_aliases | split_multiple() |
| Роль | product_authors.role | map_role_values() |

### Примеры правил нормализации имен авторов
```
"Иванов И. И." -> "Иванов Иван Иванович" (если полное имя известно)
"ТОЛСТОЙ ЛЕВ" -> "Толстой Лев" (нормализация регистра)
"Джон  Доу" -> "Джон Доу" (удаление лишних пробелов)
```

## Дедупликация авторов

### Критерии определения дубликатов
1. **Точное совпадение**: Идентичные имена с учетом регистра и пробелов
2. **Нечеткое совпадение**: Похожие имена (расстояние Левенштейна < 3)
3. **Псевдонимы**: Один из авторов является псевдонимом другого
4. **Метаданные**: Совпадение даты рождения, основных произведений

### Процесс объединения записей
1. Определение основной (целевой) записи и записи-дубля
2. Объединение биографических данных (приоритет более полной информации)
3. Перенос всех псевдонимов на основную запись
4. Перенос связей с продуктами на основную запись
5. Маркировка дублирующей записи как `merged` с указанием ID основной записи
6. Запись информации о слиянии в журнал изменений

## API для работы с авторами

### Базовые операции

```java
/**
 * Получение автора по ID
 */
Author getAuthor(Long id);

/**
 * Поиск авторов по различным критериям
 */
List<Author> findAuthors(AuthorSearchCriteria criteria, Pagination pagination);

/**
 * Создание нового автора
 */
Author createAuthor(Author author);

/**
 * Обновление существующего автора
 */
Author updateAuthor(Long id, Author author);

/**
 * Объединение дублирующихся записей авторов
 */
MergeResult mergeAuthors(Long sourceId, Long targetId, MergeOptions options);
```

### Поиск авторов

```java
/**
 * Критерии поиска авторов
 */
class AuthorSearchCriteria {
    String nameLike;          // Поиск по имени (с поддержкой символов * и ?)
    List<String> genres;      // Фильтр по жанрам
    List<String> roles;       // Фильтр по ролям
    Boolean hasPseudonyms;    // Только авторы с псевдонимами
    String status;            // Фильтр по статусу
}
```

### Пример использования API

```java
// Поиск авторов по имени
AuthorSearchCriteria criteria = new AuthorSearchCriteria();
criteria.setNameLike("Толст*");
Pagination pagination = new Pagination(0, 10);
List<Author> authors = authorService.findAuthors(criteria, pagination);

// Объединение дублирующихся записей
MergeOptions options = new MergeOptions();
options.setMergeProducts(true);
options.setMergeAliases(true);
MergeResult result = authorService.mergeAuthors(123L, 456L, options);
```

## Примеры сценариев использования

### Сценарий 1: Импорт новых авторов из Excel-файла
```
1. Загрузка Excel-файла от издательства
2. Извлечение данных об авторах из столбцов "Автор", "Биография", "Дата рождения"
3. Нормализация имен авторов согласно правилам
4. Проверка существования авторов в базе данных
5. Создание новых записей для авторов, отсутствующих в базе
6. Обновление существующих записей для авторов, уже присутствующих в базе
7. Создание связей с импортируемыми книгами
```

### Сценарий 2: Поиск и объединение дублирующихся авторов
```
1. Запуск регулярной задачи поиска дубликатов
2. Выявление потенциальных дубликатов по заданным критериям
3. Автоматическое объединение записей с высокой вероятностью дублирования
4. Создание задач для ручной проверки записей с неопределенной вероятностью
5. Запись информации о слияниях в журнал изменений
```

## Связь с другими контрактами

- [Database Schema Contract](./database_schema_contract.md) - Общая схема базы данных
- [Product Contract](./product_contract.md) - Контракт работы с товарами
- [ETL Process Contract](../ETL-Process-Contract.md) - Процессы ETL
- [Data Lineage Contract](./data_lineage_contract.md) - Отслеживание происхождения данных

## Инварианты

1. У каждого автора должно быть заполнено поле `name`
2. Имена авторов должны быть уникальными (с учетом нормализации)
3. При объединении авторов все связи с продуктами должны сохраняться
4. Статус автора должен быть одним из предопределенных значений (`active`, `merged`)
5. Каждая запись в таблице `product_authors` должна ссылаться на существующие записи в таблицах `products` и `authors`
6. Псевдонимы автора должны быть уникальными в рамках одного автора

## Ограничения и допущения

1. Система поддерживает до 1 миллиона уникальных авторов
2. Имя автора может содержать до 255 символов
3. Биография автора не ограничена по размеру, но рекомендуется до 10 000 символов
4. Поддерживаются следующие роли авторов: author (автор), editor (редактор), translator (переводчик), illustrator (иллюстратор), compiler (составитель)
5. Не предусмотрена сложная система управления авторскими правами 
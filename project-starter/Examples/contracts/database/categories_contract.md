# Контракт категорий (Categories Contract)

## Метаданные
| Атрибут | Значение |
|---------|----------|
| Версия | 1.0.0 |
| Статус | Планируемый |
| Последнее обновление | 2025-04-25 |
| Последний редактор | AI |

## История изменений
| Дата | Версия | Автор | Описание изменений | PR |
|------|--------|-------|-------------------|-----|
| 2025-04-25 | 1.0.0 | AI | Начальная версия | - |

## Описание

Контракт категорий определяет структуру и правила работы с иерархической системой категорий в CATMEPIM. Контракт регламентирует хранение, импорт, нормализацию данных о категориях и связывание категорий с продуктами в рамках ETL-процессов системы.

## Цели и задачи

**Основная цель**: Обеспечить единый подход к категоризации товаров при создании и управлении Архетипами книг.

**Задачи**:
1. Определить структуру хранения данных о категориях в базе данных
2. Описать правила построения иерархической структуры категорий
3. Определить процесс импорта и нормализации данных о категориях из внешних источников
4. Определить правила связывания категорий с продуктами
5. Обеспечить поддержку навигации по категориям и фильтрации продуктов

## Структура хранения данных

### Таблица categories
Основная таблица для хранения данных о категориях.

| Поле | Тип | Описание |
|------|-----|----------|
| id | BIGSERIAL | Первичный ключ |
| parent_id | BIGINT | ID родительской категории (NULL для корневых) |
| name | VARCHAR(255) | Название категории |
| path | VARCHAR(500) | Полный путь в иерархии (напр. "/1/4/10/") |
| level | INT | Уровень в иерархии (0 - корневой) |
| description | TEXT | Описание категории |
| data | JSONB | Дополнительные данные в JSON-формате |
| status | VARCHAR(20) | Статус (active, inactive, deprecated) |
| created_at | TIMESTAMP | Дата создания |
| updated_at | TIMESTAMP | Дата обновления |

#### Содержимое поля data (JSONB)
```json
{
  "display_order": 5,              // Порядок отображения среди одноуровневых категорий
  "synonym_ids": [42, 56],         // Связанные синонимы
  "icon_url": "https://example.com/icons/fiction.png",  // URL иконки
  "seo": {                         // SEO-данные
    "title": "Художественная литература - интернет-магазин Кот Учёный",
    "meta_description": "Купить художественную литературу с доставкой...",
    "meta_keywords": "книги, художественная литература, романы"
  },
  "external_ids": {                // Идентификаторы во внешних системах
    "1c": "CAT012345",
    "taxonomy_id": "LIT_FICTION"
  }
}
```

### Таблица product_categories
Связь категорий с продуктами.

| Поле | Тип | Описание |
|------|-----|----------|
| product_id | BIGINT | Ссылка на продукт |
| category_id | BIGINT | Ссылка на категорию |
| is_primary | BOOLEAN | Основная категория продукта |
| created_at | TIMESTAMP | Дата создания |
| updated_at | TIMESTAMP | Дата обновления |

## Иерархия категорий

Категории в системе организованы в многоуровневую древовидную структуру:

1. **Корневые категории** (уровень 0) - верхний уровень, представляет основные типы товаров (напр. "Книги", "Канцтовары")
2. **Основные разделы** (уровень 1) - основные жанры или типы (напр. "Художественная литература", "Нехудожественная литература")
3. **Подразделы** (уровни 2-5) - более специфичные жанры и категории (напр. "Детективы", "Фантастика", "Русская классика")

### Особенности иерархии

1. **Путь категории** - поле `path` содержит все ID предков, что позволяет эффективно выполнять запросы на получение всех подкатегорий
2. **Множественная принадлежность** - продукт может относиться к нескольким категориям, с выделением основной (is_primary = true)
3. **Наследование атрибутов** - атрибуты могут наследоваться от родительских категорий к дочерним

## Импорт и нормализация данных

### Источники данных о категориях
1. Excel-файлы от поставщиков
2. Таксономии национальных библиотек
3. Стандарты классификации книг (BISAC, UDK, BBK)
4. Ручной ввод данных

### Процесс импорта
1. Извлечение данных о категориях из источника
2. Нормализация названий категорий
3. Построение иерархической структуры
4. Сопоставление с существующими категориями в базе
5. Создание новых или обновление существующих записей
6. Обновление поля `path` для всех затронутых категорий

### Маппинг полей
Пример сопоставления полей из Excel-файла поставщика:

| Поле в источнике | Поле в системе | Трансформация |
|-----------------|----------------|--------------|
| Раздел | parent_id | resolve_parent_category() |
| Категория | name | trim(), capitalize() |
| Описание | description | sanitize_html() |
| Порядок | data->display_order | parse_int() |

### Примеры правил нормализации названий категорий
```
"ДЕТЕКТИВЫ" -> "Детективы" (нормализация регистра)
"Бизнес / Экономика" -> "Бизнес и экономика" (стандартизация разделителей)
"Худ. лит-ра" -> "Художественная литература" (раскрытие сокращений)
```

## Автоматическая категоризация продуктов

### Алгоритмы категоризации
1. **На основе метаданных** - категоризация по жанрам, указанным в метаданных книги
2. **На основе ключевых слов** - анализ названия и описания книги
3. **На основе подобия** - категоризация на основе похожих продуктов
4. **На основе издательства** - использование специализации издательства

### Процесс категоризации
1. Извлечение метаданных из записи о продукте
2. Применение алгоритмов категоризации
3. Вычисление релевантности для каждой категории
4. Выбор категорий с наивысшей релевантностью
5. Определение основной категории
6. Создание связей продукта с категориями

## API для работы с категориями

### Базовые операции

```java
/**
 * Получение категории по ID
 */
Category getCategory(Long id);

/**
 * Поиск категорий по различным критериям
 */
List<Category> findCategories(CategorySearchCriteria criteria, Pagination pagination);

/**
 * Создание новой категории
 */
Category createCategory(Category category);

/**
 * Обновление существующей категории
 */
Category updateCategory(Long id, Category category);

/**
 * Получение дочерних категорий
 */
List<Category> getChildCategories(Long parentId);

/**
 * Получение полного пути категории
 */
List<Category> getCategoryPath(Long categoryId);

/**
 * Получение всех продуктов в категории (включая подкатегории)
 */
List<Product> getCategoryProducts(Long categoryId, ProductSearchCriteria criteria, Pagination pagination);
```

### Поиск категорий

```java
/**
 * Критерии поиска категорий
 */
class CategorySearchCriteria {
    String nameLike;          // Поиск по названию (с поддержкой символов * и ?)
    Long parentId;            // Поиск по родительской категории
    Integer level;            // Поиск по уровню в иерархии
    String path;              // Поиск по части пути
    String status;            // Фильтр по статусу
}
```

### Пример использования API

```java
// Поиск категорий по названию
CategorySearchCriteria criteria = new CategorySearchCriteria();
criteria.setNameLike("Детектив*");
Pagination pagination = new Pagination(0, 10);
List<Category> categories = categoryService.findCategories(criteria, pagination);

// Получение всех подкатегорий
List<Category> subcategories = categoryService.getChildCategories(42L);

// Получение всех продуктов в категории и ее подкатегориях
ProductSearchCriteria productCriteria = new ProductSearchCriteria();
productCriteria.setStatus("active");
List<Product> products = categoryService.getCategoryProducts(
    42L, productCriteria, new Pagination(0, 20)
);
```

## Примеры сценариев использования

### Сценарий 1: Импорт категорий из стандартной классификации
```
1. Загрузка файла с классификацией BISAC (Book Industry Standards and Communications)
2. Извлечение данных о категориях (код, название, родительская категория)
3. Преобразование в иерархическую структуру
4. Сопоставление с существующими категориями
5. Создание новых категорий и обновление существующих
6. Обновление полей path и level для всех категорий
7. Запись кодов BISAC в поле data.external_ids.bisac
```

### Сценарий 2: Автоматическая категоризация импортируемых продуктов
```
1. Импорт данных о книгах из Excel-файла поставщика
2. Извлечение информации о жанрах и темах книг
3. Применение алгоритмов категоризации
4. Определение релевантных категорий для каждой книги
5. Создание связей между книгами и категориями
6. Выполнение проверки качества категоризации
7. Создание отчета о результатах категоризации
```

## Связь с другими контрактами

- [Database Schema Contract](./database_schema_contract.md) - Общая схема базы данных
- [Product Contract](./product_contract.md) - Контракт работы с товарами
- [ETL Process Contract](../ETL-Process-Contract.md) - Процессы ETL
- [Synonyms Contract](./synonyms_contract.md) - Работа с синонимами

## Инварианты

1. У каждой категории должно быть заполнено поле `name`
2. Дочерние категории не могут иметь уровень меньше или равный уровню родительской категории
3. Поле `path` должно содержать корректную последовательность ID предков категории
4. В иерархии категорий не должно быть циклических зависимостей
5. Каждая категория может иметь только одну родительскую категорию (кроме корневых)
6. Каждый продукт должен иметь не более одной основной категории (is_primary = true)

## Ограничения и допущения

1. Система поддерживает до 100 000 категорий
2. Глубина иерархии категорий ограничена 6 уровнями (0-5)
3. Название категории может содержать до 255 символов
4. Продукт может относиться к неограниченному количеству категорий
5. Не предусмотрена сложная система правил для атрибутов разных категорий 
# План миграции схемы базы данных

## Метаданные
- **Версия**: 1.0.0
- **Статус**: Планируемый
- **Последнее обновление**: 2025-04-20
- **Последний редактор**: AI
- **Ветка разработки**: main

## История изменений
| Дата | Версия | Автор | Описание изменений | PR |
|------|--------|-------|-------------------|-----|
| 2025-04-20 | 1.0.0 | AI | Начальная версия | - |

## Цель миграции
Данный документ описывает план миграции базы данных CATMEPIM с текущей схемы (одна таблица products с JSONB-данными) на целевую нормализованную схему, определенную в [target_schema.md](./target_schema.md).

## Общая стратегия
Миграция будет проводиться поэтапно, без прерывания работы существующей системы. Текущая таблица products будет продолжать использоваться в качестве основного хранилища данных на протяжении всего процесса миграции. Новые таблицы будут создаваться и заполняться данными параллельно с работой системы, а переключение на новую схему произойдет только после проверки целостности и корректности данных.

## Фазы миграции

### Фаза 1: Подготовка и планирование
1. **Создание резервной копии базы данных**
   - Полное резервное копирование текущей базы данных
   - Тестовое восстановление из резервной копии

2. **Разработка скриптов миграции**
   - Скрипты для создания новых таблиц
   - Скрипты для извлечения данных из JSONB
   - Скрипты для заполнения новых таблиц
   - Скрипты для верификации данных

3. **Создание тестовой среды**
   - Развертывание копии базы данных в тестовой среде
   - Настройка инструментов для мониторинга процесса миграции

### Фаза 2: Создание структуры нормализованной базы данных
1. **Создание основных таблиц**
   ```sql
   -- Создание таблицы books, authors, publishers и т.д.
   CREATE TABLE books (...);
   CREATE TABLE authors (...);
   CREATE TABLE publishers (...);
   ```

2. **Создание таблиц связей**
   ```sql
   -- Создание таблиц book_authors, book_categories и т.д.
   CREATE TABLE book_authors (...);
   CREATE TABLE book_categories (...);
   ```

3. **Создание индексов**
   ```sql
   -- Создание индексов для оптимизации поиска
   CREATE INDEX idx_books_isbn ON books(isbn);
   CREATE INDEX idx_books_title ON books(title);
   ```

4. **Создание представлений для поддержания совместимости**
   ```sql
   -- Создание представления, эмулирующего текущую структуру
   CREATE VIEW legacy_products_view AS
   SELECT ... FROM books
   JOIN ... ON ...;
   ```

### Фаза 3: Миграция данных
1. **Начальная загрузка данных**
   - Извлечение данных из таблицы products
   - Нормализация данных и устранение дубликатов
   - Заполнение таблиц books, authors, publishers и т.д.

2. **Разработка механизма синхронизации**
   - Триггеры на таблице products для отслеживания изменений
   - Процедуры для репликации изменений в новые таблицы

3. **Валидация данных**
   - Проверка целостности и соответствия данных
   - Исправление несоответствий

### Фаза 4: Разработка нового функционала для прайс-листов
1. **Создание таблиц для прайс-листов**
   ```sql
   -- Создание таблиц suppliers, price_lists, price_items и т.д.
   CREATE TABLE suppliers (...);
   CREATE TABLE price_lists (...);
   CREATE TABLE price_items (...);
   ```

2. **Разработка компонентов для работы с прайс-листами**
   - Создание классов для импорта прайс-листов
   - Создание классов для сопоставления товаров
   - Создание классов для обработки конфликтов и активации прайс-листов

3. **Тестирование функционала прайс-листов**
   - Тестирование импорта прайс-листов
   - Тестирование сопоставления товаров
   - Тестирование активации прайс-листов

### Фаза 5: Переключение системы на новую схему
1. **Постепенное переключение**
   - Модификация кода для использования новых таблиц
   - Переключение функционала по одному модулю
   - Поддержание обратной совместимости через представления

2. **Окончательное переключение**
   - Полная остановка системы на короткое время
   - Финальная синхронизация данных
   - Переключение всех компонентов на новую схему
   - Изменение конфигурации системы

3. **Мониторинг и поддержка**
   - Мониторинг производительности и стабильности
   - Исправление обнаруженных проблем
   - Сбор обратной связи от пользователей

### Фаза 6: Архивация старой схемы
1. **Архивация таблицы products**
   - Создание архивной копии таблицы products
   - Отключение триггеров и процедур синхронизации

2. **Очистка базы данных**
   - Удаление временных таблиц и представлений
   - Оптимизация индексов и статистики

## Риски и их снижение

| Риск | Вероятность | Влияние | Меры по снижению |
|------|-------------|---------|-----------------|
| Потеря данных | Низкая | Высокое | Резервное копирование, валидация данных, постепенное переключение |
| Длительное время миграции | Средняя | Среднее | Оптимизация скриптов, пакетная обработка, параллельное выполнение |
| Несоответствие данных | Высокая | Среднее | Строгая валидация, логирование ошибок, ручная коррекция |
| Проблемы с производительностью | Средняя | Высокое | Мониторинг, оптимизация запросов, индексирование |

## Тестирование и валидация

1. **Подготовка тестовых данных**
   - Создание тестовых наборов данных
   - Определение критериев успешной миграции

2. **Тесты целостности данных**
   - Проверка количества записей
   - Проверка ключевых полей
   - Проверка связей между таблицами

3. **Тесты производительности**
   - Измерение времени выполнения запросов
   - Сравнение с текущей схемой
   - Оптимизация проблемных мест

4. **Тесты функциональности**
   - Проверка основных бизнес-процессов
   - Проверка обработки ошибок
   - Проверка интеграции с другими системами

## Ресурсы и сроки

| Фаза | Ресурсы | Длительность | Зависимости |
|------|---------|--------------|-------------|
| Подготовка и планирование | 1 разработчик | 1 неделя | - |
| Создание структуры | 1 разработчик | 1 неделя | Подготовка и планирование |
| Миграция данных | 1 разработчик | 2 недели | Создание структуры |
| Разработка функционала прайс-листов | 1 разработчик | 2 недели | Создание структуры |
| Переключение системы | 1 разработчик | 1 неделя | Миграция данных, Разработка функционала |
| Архивация старой схемы | 1 разработчик | 0.5 недели | Переключение системы |

**Общая продолжительность**: 7.5 недель (без учета параллельных работ)

## Связанные документы

- [schema.md](./schema.md) - Текущая схема базы данных
- [target_schema.md](./target_schema.md) - Целевая схема базы данных
- [products.sql](./products.sql) - DDL текущей таблицы products
- [target/books.sql](./target/books.sql) - DDL таблицы books (целевая схема)
- [target/price_lists.sql](./target/price_lists.sql) - DDL таблиц для управления прайс-листами 
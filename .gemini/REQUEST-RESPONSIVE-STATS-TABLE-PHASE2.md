# Запрос на дополнительный ресёрч: ResponsiveStatsTable (Фаза 2)

## Контекст
- Проведён 360° аудит адаптивной таблицы статистики. Выявлены проблемы:
  1) Дублирование управления адаптивностью (JS + CSS)
  2) «Магические числа» и хардкоды в стилях
  3) Хрупкое sticky-позиционирование при сложных overflow-контекстах
  4) Потенциальная нестабильность ключей в мобильной версии (исправлено: композитные ключи)
- Внесён точечный фикс ключей в `MobileStatsTable.tsx` (композитные ключи для header/total/cell).

## Цель ресёрча (Phase 2)
Сконсолидировать адаптивность, устранить первопричины проблем sticky, токенизировать стили, подтвердить производительность и доступность. Выдать чёткий план мини-патчей с измеримыми метриками.

## Приоритетные вопросы к Gemini
1. Sticky-позиционирование: где формируются контексты overflow/stacking, кто ломает sticky? Построить карту контейнеров и стека.
2. Консолидация адаптивности: какие ветки JS и CSS дублируют логику? Предложить единый источник правды (JS или CSS).
3. Токенизация: перечислить «магические числа» (ширины 80/120px, paddings, цвета) и предложить соответствия CSS-переменным/дизайн-токенам.
4. Синхронизация скролла: точные зависимости `headerScrollRef`, `totalsScrollRef`, `rowScrollRefs`. Где возможен рассинхрон и как упразднить?
5. Виртуализация: оценить целесообразность и границы (N студентов × M колонок). Предложить библиотеку/подход и интеграционные риски.
6. Производительность: оценить TTI/CLS/scroll-jank на мобильных устройствах. Где «узкие места» (tooltips, сортировка, форматтеры)?
7. Доступность: фокус-управление, таб-циклы, ARIA для tooltip/таблицы. Где недочёты?
8. Дубли CSS: `components/stats-table/responsive-stats-table.css` vs `components/ui/responsive-stats-table.css`. Что реально используется? Предложить унификацию.
9. Хуки: пересечения `useTableSort`, `useGroupCollapse`, `useScrollSync`, `useColumnWidths`. Где скрытая связность/копипаста?
10. Ключи за пределами MobileStatsTable: проверить `DesktopStatsTable`, `StudentRow`, `TableCell` на устойчивость ключей.
11. Стабильность при fullscreen и переключении desktop/mobile: выявить гонки состояний/разрывы.
12. Tooltip-оверлеи: Z-index/portals/overlay взаимодействия. Есть ли клиппинг при скролле?

## Коды и области анализа
- Orchestrator: `components/stats-table/ResponsiveStatsTableOrganism.tsx`
- Organisms: `components/stats-table/organisms/DesktopStatsTable.tsx`, `.../MobileStatsTable.tsx`
- Molecules: `components/stats-table/molecules/GroupHeader.tsx`, `TotalsRow.tsx`, `StudentRow.tsx`
- Atoms: `components/stats-table/atoms/TableHeader.tsx`, `TableCell.tsx`, `StudentInfo.tsx`, `SortIcon.tsx`
- Hooks: `components/stats-table/hooks/useTableSort.ts`, `useGroupCollapse.ts`, `useScrollSync.ts`, `useColumnWidths.ts`
- Styles: `components/stats-table/responsive-stats-table.css`, `components/ui/responsive-stats-table.css`
- Consumers: `components/CustomTestsStats.tsx`, страницы в `app/groups/[id]/` (таблица статистики)
- Data: `data/statistics-adapter.ts`

## Сценарии воспроизведения
1. Открыть таблицу на мобильном и десктопе; переключать collapse/expand групп, сортировку, fullscreen.
2. Активно скроллить header/totals/rows и наблюдать синхронизацию.
3. Включить/выключить sticky студент; проверять клиппинг tooltip и позиционирование.

## Ожидаемые артефакты от Gemini
- Карта DOM и overflow/stacking контекстов (диаграмма), указание узлов, ломающих sticky.
- Таблица дубликатов адаптивности с рекомендацией консолидации (JS vs CSS), оценка рисков.
- Таблица «магических чисел» → предложенные CSS-переменные/дизайн-токены.
- План мини-патчей (по файлам, точные фрагменты, ограниченный дифф), очередность.
- Метрики до/после: scroll-jank, CLS, время рендера строк и tooltip.
- Проверка ключей вне мобильной части и рекомендации.
- Аудит доступности: список конкретных улучшений с ссылками на WAI-ARIA.

## Критерии успеха
- Sticky работает предсказуемо; нет клиппинга/срывов при скролле.
- Устранено дублирование адаптивности; определён единый источник правды.
- «Магические числа» заменены на токены/переменные, стили унифицированы.
- Скролл-секции синхронизированы; не наблюдается рассинхрон.
- Ключи устойчивы во всех компонентах; нет предупреждений React.
- Производительность и доступность подтверждены базовыми метриками.

## Риски и оговорки
- Возможны визуальные регрессии при консолидации стилей — требуется поэтапное внедрение.
- Sticky-зависимости от контекста страницы/лейаута — часть фиксов может потребовать изменения родительских контейнеров.

## Формат ответа
Пожалуйста, предоставьте артефакты с указанием файлов и строк, минимальные диффы и измеримые метрики. Предпочтительны схемы (Mermaid) и таблицы соответствий токенов.
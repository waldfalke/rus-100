/* ===========================================================
 * trumbowyg.cleanpaste.js v1.0
 * Font Clean paste plugin for Trumbowyg
 * http://alex-d.github.com/Trumbowyg
 * ===========================================================
 * Authors : Eric Radin
 *           Todd Graham (slackwalker)
 *
 * This plugin will perform a "cleaning" on any paste, in particular
 * it will clean pasted content of microsoft word document tags and classes.
 */

let GlobalCleanPaste = {};

(function ($) {
    'use strict';

    let allowStyleValues = ['color'];

    function filterCss(styleValue) {
        var result = "";
        let lines = styleValue.split(";");
        for (let i = 0; i < lines.length; ++i) {
            let pair = lines[i].split(":");
            if (pair.length === 2) {
                pair[0] = pair[0].toLowerCase().replace(/\s+/g, "");
                if (allowStyleValues.indexOf(pair[0]) !== -1) {
                    if (pair[0] === 'color' && pair[1].replace(/\s+/g, "") === "rgb(0,0,0)") {
                        continue;
                    }
                    result += lines[i];
                    result += ";";
                }
            }
        }
        return result;
    }

    function checkValidTags(snippet) {
        var theString = snippet;

        // Replace uppercase element names with lowercase
        theString = theString.replace(/<[^> ]*/g, function (match) {
            return match.toLowerCase();
        });

        // Replace uppercase attribute names with lowercase
        theString = theString.replace(/<[^>]*>/g, function (match) {
            match = match.replace(/ [^=]+=/g, function (match2) {
                return match2.toLowerCase();
            });
            return match;
        });

        // Put quotes around unquoted attributes
        theString = theString.replace(/<[^>]*>/g, function (match) {
            match = match.replace(/( [^=]+=)([^"][^ >]*)/g, '$1\"$2\"');
            return match;
        });

        return theString;
    }

    let stripUnacceptedAttributes = function (html) {
        return html.replace(/<[^>]*>/g, function (match) {
            match = match.replace(/ ([^=]+)="([^"]*)"/g, function (match2, attributeName, attributeValue) {
                if (['alt', 'href', 'src', 'title', 'color'].indexOf(attributeName) !== -1) {
                    return match2;
                } else if (attributeName === "style") {
                    let filtered = filterCss(attributeValue);
                    if (filtered.length === 0) {
                        return "";
                    } else {
                        return " " + attributeName + '="' + filterCss(attributeValue) + '"';
                    }
                }
                return '';
            });
            return match;
        });
    }

    let stripNoAttrsSpans = function (html) {
        let tempDiv = document.createElement('div');
        tempDiv.innerHTML = html;
        let jq = $(tempDiv);

        let spans = jq.find("span");
        for (let i = 0; i < spans.length; ++i) {
            let span = spans[i];
            if (span.style.length === 0) {
                $(span).replaceWith(span.innerHTML);
            }
        }
        let res = tempDiv.innerHTML;
        tempDiv.remove();
        return res;
    }

    let filterEmptyTags = function (elementQ) {
        elementQ.find("font").each(function () {
            if (this.attributes.length === 0) {
                $(this).replaceWith(this.childNodes);
            }
        })
        elementQ.find(":not(br)").each(function () {
            let contents = this.innerHTML;
            if ($(this).hasClass("bKeepMe")) {
            } else if (contents === '') {
                $(this).replaceWith('');
            } else if (/^\s+$/.test(contents)) {
                $(this).replaceWith(' ');
            }
        })
    }

    /**
     *
     * @param {string} html
     * @return {string}
     */
    function cleanIt(html, cleanAttrs = true, cleanEmptyTags = true, cleanNoArgSpans = true) {
        // first make sure all tags and attributes are made valid
        html = checkValidTags(html);

        // Replace opening bold tags with strong
        html = html.replace(/<b(\s+|>)/g, '<strong$1');
        // Replace closing bold tags with closing strong
        html = html.replace(/<\/b(\s+|>)/g, '</strong$1');

        // Replace italic tags with em
        html = html.replace(/<i(\s+|>)/g, '<em$1');
        // Replace closing italic tags with closing em
        html = html.replace(/<\/i(\s+|>)/g, '</em$1');

        // strip out comments -cgCraft
        html = html.replace(/<!(?:--[\s\S]*?--\s*)?>\s*/g, '');

        // strip out &nbsp; -cgCraft
        html = html.replace(/&nbsp;/gi, ' ');
        // strip out extra spaces -cgCraft
        //html = html.replace(/ <\//gi, '</');

        // Remove multiple spaces
        html.replace(/\s+/g, ' ');

        // strip &nbsp; -cgCraft
        html = html.replace(/^\s*|\s*$/g, '');

        // Strip out unaccepted attributes
        if (cleanAttrs) {
            html = stripUnacceptedAttributes(html);
        }

        // Final clean out for MS Word crud
        html = html.replace(/<\?xml[^>]*>/g, '');
        html = html.replace(/<[^ >]+:[^>]*>/g, '');
        html = html.replace(/<\/[^ >]+:[^>]*>/g, '');

        if (cleanEmptyTags) {
            let tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            let jq = $(tempDiv);
            if (cleanEmptyTags) {
                filterEmptyTags(jq);
            }
            html = tempDiv.innerHTML;
            tempDiv.remove();
        }

        if (cleanNoArgSpans) {
            html = stripNoAttrsSpans(html)
        }

        // remove unwanted tags
        html = html.replace(/<(div|style|meta|link).*?>/gi, ' ');

        html = html.replace(/\s+/g, " ");

        return html;
    }



    GlobalCleanPaste.filter = function (elementQ) {
        const tagName = elementQ[0].tagName.toLowerCase();
        if (tagName === "textarea") {

        } else {

        }
        elementQ.html(cleanIt(elementQ.html()));
        filterEmptyTags(elementQ);
    }

    $.cleanUpHtmlForRichEdit = function (text) {
        let cleanedText = cleanIt(text, false, true, true);
        let tempDiv = document.createElement('div');
        tempDiv.innerHTML = cleanedText;
        //filterEmptyTags($(tempDiv));
        return stripUnacceptedAttributes(tempDiv.innerHTML);
    }

    // clean editor
    // this will clean the inserted contents
    // it does a compare, before and after paste to determine the
    // pasted contents
    $.extend(true, $.trumbowyg, {
        plugins: {
            cleanPaste: {
                init: function (trumbowyg) {
                    trumbowyg.pasteHandlers.push(function () {
                        setTimeout(function () {
                            try {
                                trumbowyg.$ed.html(cleanIt(trumbowyg.$ed.html(), true, true, true));
                                filterEmptyTags(trumbowyg.$ed);
                            } catch (c) {
                            }
                        }, 1);
                    });
                }
            }
        }
    });
})(jQuery);
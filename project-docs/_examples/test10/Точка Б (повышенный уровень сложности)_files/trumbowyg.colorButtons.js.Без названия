(function ($) {
    'use strict';

    function buildButtonIcon() {
        if ($("#trumbowyg-fore-color-teal").length <= 0) {
            const iconWrap = $(document.createElementNS("http://www.w3.org/2000/svg", "svg"));
            iconWrap.addClass("trumbowyg-icons");
            iconWrap.html(`
                <symbol id="trumbowyg-fore-color-teal" viewBox="0 0 72 72">
                    <path fill="#4bacc6" d="M32 15h7.8L56 57.1h-7.9l-4-11.1H27.4l-4 11.1h-7.6L32 15zm-2.5 25.4h12.9L36 22.3h-.2l-6.3 18.1z"/>
                </symbol>
            `).appendTo(document.body);
        }
        if ($("#trumbowyg-fore-color-orange").length <= 0) {
            const iconWrap = $(document.createElementNS("http://www.w3.org/2000/svg", "svg"));
            iconWrap.addClass("trumbowyg-icons");
            iconWrap.html(`
                <symbol id="trumbowyg-fore-color-orange" viewBox="0 0 72 72">
                    <path fill="#f79646" d="M32 15h7.8L56 57.1h-7.9l-4-11.1H27.4l-4 11.1h-7.6L32 15zm-2.5 25.4h12.9L36 22.3h-.2l-6.3 18.1z"/>
                </symbol>
            `).appendTo(document.body);
        }
    }

    function hex(x) {
        return ('0' + parseInt(x).toString(16)).slice(-2);
    }

    function colorToHex(rgb) {
        if (rgb.search('rgb') === -1) {
            return rgb.replace('#', '');
        } else if (rgb === 'rgba(0, 0, 0, 0)') {
            return 'transparent';
        } else {
            rgb = rgb.match(/^rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d?(.\d+)))?\)$/);
            if (rgb == null) {
                return 'transparent'; // No match, return transparent as unkown color
            }
            return hex(rgb[1]) + hex(rgb[2]) + hex(rgb[3]);
        }
    }

    function colorTagHandler(element, trumbowyg) {
        var tags = [];

        if (!element.style) {
            return tags;
        }

        // text color
        var foreColor;
        if (element.style.color !== '') {
            foreColor = colorToHex(element.style.color);
        } else if (element.hasAttribute('color')) {
            foreColor = colorToHex(element.getAttribute('color'));
        }
        if (foreColor === '4bacc6') {
            tags.push('foreColorTeal');
        }

        return tags;
    }

    $.extend(true, $.trumbowyg, {
        // Register plugin in Trumbowyg
        plugins: {
            colorButtons: {
                // Code called by Trumbowyg core to register the plugin
                init: function (trumbowyg) {
                    buildButtonIcon();
                    var btnDef = {
                        fn: 'foreColor',
                        forceCss: true,
                        hasIcon: true,
                        param: '#4bacc6',
                    }
                    trumbowyg.addBtnDef("foreColorTeal", btnDef);
                    btnDef = {
                        fn: 'foreColor',
                        forceCss: true,
                        hasIcon: true,
                        param: '#f79646',
                    }
                    trumbowyg.addBtnDef("foreColorOrange", btnDef);
                },
                tagHandler: colorTagHandler
            }
        }
    })
})(jQuery);
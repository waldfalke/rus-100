(function ($) {
    'use strict';


    // If the plugin is a button
    function buildButtonIcon() {
        if ($("#trumbowyg-simple-underline").length <= 0) {
            const iconWrap = $(document.createElementNS("http://www.w3.org/2000/svg", "svg"));
            iconWrap.addClass("trumbowyg-icons");
            iconWrap.html(`
                <symbol id="trumbowyg-simple-underline" viewBox="0 0 64 64">
    <text fill="#000000" font-family="Helvetica" font-size="51" font-weight="bold" id="svg_6" stroke-width="0" text-anchor="middle" transform="matrix(1 0 0 1 0 0)" x="32.04" xml:space="preserve" y="44">U</text>
  <path d="m11.48,52.47l41.6,0l0,3.1l-41.6,0l0,-3.1z" fill="#000000" id="svg_2"/>
                </symbol>
            `).appendTo(document.body);
        }
        if ($("#trumbowyg-double-underline").length <= 0) {
            const iconWrap = $(document.createElementNS("http://www.w3.org/2000/svg", "svg"));
            iconWrap.addClass("trumbowyg-icons");
            iconWrap.html(`
                <symbol id="trumbowyg-double-underline" viewBox="0 0 64 64">
  <text fill="#000000" font-family="Helvetica" font-size="51" font-weight="bold" id="svg_6" stroke-width="0" text-anchor="middle" transform="matrix(1 0 0 1 0 0)" x="32.03" xml:space="preserve" y="44">D</text>
  <path d="m11.23,49.17l41.6,0l0,3.8l-41.6,0l0,-3.8z" fill="#000000" id="svg_7">D</path>
  <path d="m11.23,56.32l41.6,0l0,3.8l-41.6,0l0,-3.8z" fill="#000000" id="svg_9" transform="matrix(1 0 0 1 0 0)">D</path>
                </symbol>
            `).appendTo(document.body);
        }
        if ($("#trumbowyg-waved-underline").length <= 0) {
            const iconWrap = $(document.createElementNS("http://www.w3.org/2000/svg", "svg"));
            iconWrap.addClass("trumbowyg-icons");
            iconWrap.html(`
                <symbol id="trumbowyg-waved-underline" viewBox="0 0 64 64">
  <text fill="#000000" font-family="Helvetica" font-size="51" font-weight="bold" id="svg_6" stroke-width="0" text-anchor="middle" x="32.03" xml:space="preserve" y="44">W</text>
  <path d="m3.58,52.8c0.73,0 1.47,0.2 1.84,0.7l1.85,2c0.55,0.9 1.29,1.9 2.21,2.6c0.93,0.8 1.85,1.3 3.51,1.3c1.48,0 2.58,-0.5 3.69,-1.3l2.03,-2.6c0.56,-0.9 1.11,-1.6 1.85,-2c0.37,-0.5 0.92,-0.7 1.84,-0.7c0.74,0 1.3,0.2 1.85,0.7l1.85,2c0.36,0.9 1.1,1.9 2.03,2.6c0.92,0.8 2.03,1.3 3.69,1.3c1.47,0 2.58,-0.5 3.51,-1.3c0.92,-0.7 1.47,-1.7 2.21,-2.6c0.55,-0.9 1.11,-1.6 1.66,-2c0.56,-0.5 1.11,-0.7 1.85,-0.7c0.92,0 1.47,0.2 1.84,0.7c0.74,0.4 1.11,1.1 1.85,2c0.55,0.9 1.29,1.9 2.21,2.6c0.93,0.8 1.85,1.3 3.51,1.3c1.48,0 2.59,-0.5 3.69,-1.3l2.03,-2.6c0.74,-0.9 1.16,-1.51 1.85,-2c0.57,-0.41 0.92,-0.7 1.84,-0.7c0.74,0 0.85,-0.19 1.36,-1.71c0.41,-1.23 0.12,-1.69 -1.54,-1.69c-1.29,0 -2.58,0.5 -3.51,1.3l-2.21,2.6c-0.44,0.69 -1,1.36 -1.66,2c-0.37,0.5 -1.11,0.7 -1.85,0.7c-0.74,0 -1.48,-0.2 -1.84,-0.7l-1.85,-2c-0.55,-0.9 -1.29,-1.9 -2.22,-2.6c-0.92,-0.8 -1.84,-1.3 -3.5,-1.3c-1.48,0 -2.59,0.5 -3.69,1.3l-2.03,2.6c-0.56,0.9 -1.11,1.6 -1.85,2c-0.37,0.5 -0.93,0.7 -1.85,0.7c-0.74,0 -1.29,-0.2 -1.84,-0.7c-0.56,-0.4 -1.11,-1.1 -1.66,-2c-0.56,-0.9 -1.3,-1.9 -2.22,-2.6c-0.92,-0.8 -2.03,-1.3 -3.69,-1.3c-1.48,0 -2.58,0.5 -3.51,1.3c-0.92,0.7 -1.47,1.7 -2.21,2.6c-0.56,0.9 -1.11,1.6 -1.66,2c-0.56,0.5 -1.11,0.7 -1.85,0.7c-0.74,0 -1.48,-0.2 -1.85,-0.7c-0.72,-0.63 -1.34,-1.3 -1.84,-2c-0.55,-0.9 -1.29,-1.9 -2.22,-2.6c-0.92,-0.8 -1.84,-1.3 -3.5,-1.3c-0.37,0 -0.74,0.2 -0.93,0.5c-0.37,0.3 -0.55,0.7 -0.55,1.2c0,0.5 0.18,1 0.55,1.2c0,0.4 0.56,0.6 0.93,0.6l0,-0.1z" fill="#000000" id="svg_1" stroke="#000"/>
                </symbol>
            `).appendTo(document.body);
        }

        if ($("#trumbowyg-dotted-underline").length <= 0) {
            const iconWrap = $(document.createElementNS("http://www.w3.org/2000/svg", "svg"));
            iconWrap.addClass("trumbowyg-icons");
            iconWrap.html(`
                <symbol id="trumbowyg-dotted-underline" viewBox="0 0 64 64">
  <path d="m3.3,53.1l5.9,0l0,5.3l-5.9,0l0,-5.3z" id="svg_2"/>
  <path d="m16.3,53.1l5.9,0l0,5.3l-5.9,0l0,-5.3z" id="svg_6"/>
  <path d="m29.29,53.1l5.9,0l0,5.3l-5.9,0l0,-5.3z" id="svg_8"/>
  <path d="m42.29,53.1l5.9,0l0,5.3l-5.9,0l0,-5.3z" id="svg_9"/>
  <path d="m55.29,53.2l5.9,0l0,5.3l-5.9,0l0,-5.3z" id="svg_10"/>
  <text fill="#000000" font-family="Helvetica" font-size="51" font-weight="bold" id="svg_1" stroke-width="0" style="cursor: move;" text-anchor="middle" x="32" xml:space="preserve" y="44">P</text>
                </symbol>
            `).appendTo(document.body);
        }

        if ($("#trumbowyg-dashed-underline").length <= 0) {
            const iconWrap = $(document.createElementNS("http://www.w3.org/2000/svg", "svg"));
            iconWrap.addClass("trumbowyg-icons");
            iconWrap.html(`
                <symbol id="trumbowyg-dashed-underline" viewBox="0 0 64 64">
  <text fill="#000000" font-family="Helvetica" font-size="51" font-weight="bold" id="svg_6" stroke-width="0" style="cursor: move;" text-anchor="middle" x="32.03" xml:space="preserve" y="44">A</text>
  <path d="m2.03,53l16.2,0l0,3.8l-16.2,0l0,-3.8z" fill="#000000" id="svg_9">D</path>
  <path d="m23.91,53l16.2,0l0,3.8l-16.2,0l0,-3.8z" fill="#000000" id="svg_5">D</path>
  <path d="m45.78,53l16.2,0l0,3.8l-16.2,0l0,-3.8z" fill="#000000" id="svg_7">D</path>
                </symbol>
            `).appendTo(document.body);
        }

        if ($("#trumbowyg-dotted-dashed-underline").length <= 0) {
            const iconWrap = $(document.createElementNS("http://www.w3.org/2000/svg", "svg"));
            iconWrap.addClass("trumbowyg-icons");
            iconWrap.html(`
                <symbol id="trumbowyg-dotted-dashed-underline" viewBox="0 0 64 64">
  <text fill="#000000" font-family="Helvetica" font-size="51" font-weight="bold" id="svg_6" stroke-width="0" text-anchor="middle" x="32.03" xml:space="preserve" y="44">TT</text>
  <path d="m29,52.25l5.9,0l0,5.3l-5.9,0l0,-5.3z" id="svg_1">IA</path>
  <path d="m2.03,53l16.2,0l0,3.8l-16.2,0l0,-3.8z" fill="#000000" id="svg_9">IA</path>
  <path d="m45.68,53l16.2,0l0,3.8l-16.2,0l0,-3.8z" fill="#000000" id="svg_7">T</path>
                </symbol>
            `).appendTo(document.body);
        }
    }

    let underlinesSelector = 'du,wu,u,dtu,dau,ddu';
    let paragraphSelector = 'p,h1,h2,h3,h4,h5,h6,h7,h8,h9';

    let isKeepElement = function (element, trumbowyg) {
        let keepSelectors = trumbowyg.o.keepElements;
        if (keepSelectors) {
            const $el = $(element);
            for (const selector of keepSelectors) {
                if ($el.is(selector)) {
                    return true;
                }
            }

        }
        return false;
    }

    let filterEmptyTags = function (elementQ, trumbowyg) {
        elementQ.find("*").each(function () {
            if (this.tagName === 'BR')
                return;
            let contents = this.innerHTML;
            if (isKeepElement(this, trumbowyg))
                return;
            if (contents === '') {
                $(this).replaceWith('');
            } else if (/^\s+$/.test(contents)) {
                $(this).replaceWith(' ');
            }
        })
    }

    let rangeToContainer = function (range, tag) {
        let cnt = document.createElement(tag);
        cnt.appendChild(range.cloneContents());
        return cnt;
    }

    let stripTags = function (element, tagsSelector) {
        $(element).find(tagsSelector).each(function () {
            $(this).replaceWith(this.innerHTML);
        });
        return element;
    }

    /**
     * @param {Range|DocumentFragment} source
     * @return {DocumentFragment|undefined}
     */
    let rangeOrFragmentToFragment = function (source) {
        if (source instanceof Range) {
            return source.cloneContents();
        } else if (source instanceof DocumentFragment) {
            return source;
        }
        throw new Error("argument should be a Range or DocumentFragment");
    }

    /**
     * @param {Range|DocumentFragment} source
     */
    let getHtml = function (source) {
        let fragment = rangeOrFragmentToFragment(source);
        return [].map.call(fragment.childNodes,
            e => e.outerHTML !== undefined ? e.outerHTML : e.textContent).join('');
    }

    // Функция для вычисления пути от узла до parentCont
    let getNodePath = function (node, root) {
        const path = [];
        let currentNode = node;
        while (currentNode !== root) {
            const index = Array.from(currentNode.parentNode.childNodes).indexOf(currentNode);
            path.unshift(index);
            currentNode = currentNode.parentNode;
        }
        return path;
    }

// Функция для нахождения узла в клоне по пути индексов
    let findNodeByPath = function (root, path) {
        let node = root;
        path.forEach(index => {
            node = node.childNodes[index];
        });
        return node;
    }

    let cloneNodeAndRange = function (range, node) {
        const nodeClone = node.cloneNode(true);

        const startContainerPath = getNodePath(range.startContainer, node);
        const endContainerPath = getNodePath(range.endContainer, node);

        const range1 = document.createRange();
        const startNodeClone = findNodeByPath(nodeClone, startContainerPath);
        const endNodeClone = findNodeByPath(nodeClone, endContainerPath);

        range1.setStart(startNodeClone, range.startOffset);
        range1.setEnd(endNodeClone, range.endOffset);
        return [nodeClone, range1];
    }

    /**
     *
     * @param {Range} range
     * @param {Node} parentCont
     */
    let splitTo3parts = function (range, parentCont) {
        let [nodeClone, rangeClone] = cloneNodeAndRange(range, parentCont);
        let range1 = document.createRange();

        range1.selectNodeContents(nodeClone);
        range1.setStart(rangeClone.endContainer, rangeClone.endOffset);
        const fragment3 = range1.cloneContents();
        range1.deleteContents();

        range1.selectNodeContents(nodeClone);
        range1.setEnd(rangeClone.startContainer, rangeClone.startOffset);
        const fragment1 = range1.cloneContents();
        range1.deleteContents();

        range1.selectNodeContents(nodeClone);
        const fragment2 = range1.cloneContents();
        return [fragment1, fragment2, fragment3];
    }

    /**
     *
     * @param {Range} range
     * @param {[string]} tags
     * @return {Node|undefined} return any node that has that of tags and parent of selection;
     */
    let findParentTagsNode = function (range, tags) {
        let node = range.commonAncestorContainer;
        while (node.nodeType === 3)
            node = node.parentNode;
        while (node.tagName.toLowerCase() !== 'div') {
            if (tags.indexOf(node.tagName.toLowerCase()) >= 0) {
                return node;
            }
            node = node.parentNode;
        }
        return undefined;
    }

    /**
     *
     * @param {Node|Element} node
     * @param {Range} range
     * @param {string} tag
     */
    let areAllRangeNodesHaveTag = function (node, range, tag) {
        if (!node.tagName) {
            return node.textContent.length === 0;
        }
        if (tag.toLowerCase() === node.tagName.toLowerCase()) {
            return true;
        }
        let childRange = document.createRange();
        for (const child of node.childNodes) {
            if (child.textContent.length === 0 || !range.intersectsNode(child))
                continue;
            childRange.selectNodeContents(child);
            if (childRange.compareBoundaryPoints(Range.START_TO_END, range) <= 0)
                continue;
            if (childRange.compareBoundaryPoints(Range.END_TO_START, range) >= 0)
                continue;
            if (!areAllRangeNodesHaveTag(child, range, tag)) {
                return false;
            }
        }
        return true;
    }

    /**
     *
     * @param {Range} range
     * @param params
     * @param {Node} parentNode
     * @param {boolean} addUnderline
     */
    let doToggleRangeUnderline = function (range, params, parentNode, addUnderline, trumbowyg) {
        let tag = params.tag;
        const [f1, f2, f3] = splitTo3parts(range, parentNode);
        let $cont = $(parentNode);
        if (addUnderline) {
            let middle = $(`<${tag}></${tag}>`);
            middle.append(f2);
            stripTags(middle[0], params.stripTags);
            middle.wrap("<div/>");
            range.selectNode(middle[0]);
        } else {
            let middle = $("<div></div>");
            middle.append(f2);
            stripTags(middle[0], params.stripTags);
            range.selectNodeContents(middle[0]);
        }
        $cont.empty().append(f1).append(range.cloneContents()).append(f3);
        filterEmptyTags($cont, trumbowyg);
    }

    let toggleRangeCustomUnderline = function (range, params, trumbowyg) {
        if (range.collapsed) {
            return;
        }
        let tag = params.tag;
        let parentUnderlineNode = findParentTagsNode(range, params.stripTags);
        let parentNode = parentUnderlineNode ? parentUnderlineNode.parentNode : range.commonAncestorContainer;
        while (parentNode.nodeType === 3)
            parentNode = parentNode.parentNode;

        let addUnderline;
        if (parentUnderlineNode) {
            addUnderline = parentUnderlineNode.tagName.toLowerCase() !== tag.toLowerCase();
        } else {
            addUnderline = !areAllRangeNodesHaveTag(parentNode, range, tag);
        }

        if (parentNode.tagName && parentNode.tagName.toLowerCase() === "div") {
            let childRange = document.createRange();
            for (const child of parentNode.childNodes) {
                if (child.textContent.length === 0)
                    continue;
                if (!range.intersectsNode(child)) {
                    continue;
                }
                childRange.selectNodeContents(child);
                if (childRange.compareBoundaryPoints(Range.START_TO_START, range) < 0) {
                    childRange.setStart(range.startContainer, range.startOffset);
                }
                if (childRange.compareBoundaryPoints(Range.END_TO_END, range) > 0) {
                    childRange.setEnd(range.endContainer, range.endOffset);
                }
                doToggleRangeUnderline(childRange, params, child, addUnderline, trumbowyg);
            }
        } else {
            doToggleRangeUnderline(range, params, parentNode, addUnderline, trumbowyg);
        }
    }

    $.extend(true, $.trumbowyg, {
        // Register plugin in Trumbowyg
        plugins: {
            underlines: {
                // Code called by Trumbowyg core to register the plugin
                init: function (trumbowyg) {
                    buildButtonIcon();

                    let toggleCustomUnderline = function (params) {
                        trumbowyg.saveRange();
                        if (window.getSelection().isCollapsed) return;
                        var sel = window.getSelection();
                        for (var i = 0; i < sel.rangeCount; ++i) {
                            try {
                                toggleRangeCustomUnderline(sel.getRangeAt(i), params, trumbowyg);
                            } catch (e) {
                                console.log(e);
                                console.log(e.stack);
                            }
                        }
                        trumbowyg.restoreRange();
                        trumbowyg.syncCode();
                        trumbowyg.semanticCode(false, true);
                    }

                    let btnDefs = {
                        doubleUnderline: {
                            fn: toggleCustomUnderline,
                            tag: 'du',
                            title: 'Double underline',
                            text: 'DU',
                            key: 'D',
                            param: {
                                tag: 'du', stripTags: underlinesSelector
                            },
                            forceCSS: false,
                            class: 'btn-du',
                            hasIcon: true
                        },
                        dottedUnderline: {
                            fn: toggleCustomUnderline,
                            tag: 'dtu',
                            title: 'Dotted underline',
                            text: 'DT',
                            param: {
                                tag: 'dtu', stripTags: underlinesSelector
                            },
                            forceCSS: false,
                            class: 'btn-dtu',
                            hasIcon: true
                        },
                        dashedUnderline: {
                            fn: toggleCustomUnderline,
                            tag: 'dau',
                            title: 'Dashed underline',
                            text: 'DA',
                            param: {
                                tag: 'dau', stripTags: underlinesSelector
                            },
                            forceCSS: false,
                            class: 'btn-da',
                            hasIcon: true
                        },
                        dottedDashedUnderline: {
                            fn: toggleCustomUnderline,
                            tag: 'ddu',
                            title: 'Dotted-Dashed underline',
                            text: 'DD',
                            param: {
                                tag: 'ddu', stripTags: underlinesSelector
                            },
                            forceCSS: false,
                            class: 'btn-dd',
                            hasIcon: true
                        },
                        wavedUnderline: {
                            fn: toggleCustomUnderline,
                            tag: 'wu',
                            title: 'Waved underline',
                            text: 'WU',
                            key: 'W',
                            param: {
                                tag: 'wu', stripTags: underlinesSelector
                            },
                            forceCSS: false,
                            class: 'btn-wu',
                            hasIcon: true
                        }, simpleUnderline: {
                            fn: toggleCustomUnderline, tag: 'u', title: 'Underline', text: 'U', key: 'u', param: {
                                tag: 'u', stripTags: underlinesSelector
                            }, forceCSS: false, class: 'btn-u', hasIcon: true
                        }
                    };
                    for (const [name, btnDef] of Object.entries(btnDefs)) {
                        trumbowyg.addBtnDef(name, btnDef);
                    }
                },
            }
        }
    })
})(jQuery);
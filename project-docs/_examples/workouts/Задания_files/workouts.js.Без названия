class WorkoutTagDialog {
    constructor(n) {
        this.questionNumber = n;
        this.workoutData = WORKOUT_DATA[this.questionNumber];
        this.categories = CATEGORIES[this.questionNumber];
        this.showDifficulty = !!DIFFICULTIES[this.questionNumber];
    }
    onClick(item, event) {
        const $dlg = $("#dialog");
        if (this.workoutData.testId) {
            $dlg.find("#checkup-btn").removeClass("hidden").attr("href", `/test/test${this.workoutData.testId}`);
        } else {
            $dlg.find("#checkup-btn").addClass("hidden");
        }
        $dlg.find("#edit-workout-btn").attr("href", "/editw/" + this.workoutData.number);
        this.fillTitles($dlg);
        this.fillAmountUrls($dlg);
        this.fillSelectCategory($dlg);
        this.prepareSelectDifficulty($dlg);
        event.preventDefault();
        $dlg.dialog("open").dialog({
            dialogClass: "ui-dialog-filled"
        });
        this.positionDialog($dlg, $(item));
        $(".ui-widget-overlay").click((() => $("#dialog").dialog("close")));
    }
    fillSelectCategory($dlg) {
        let $select = $dlg.find(".category-select");
        $select.empty();
        if (!(this.categories && this.categories.length > 0)) {
            $dlg.find(".category-row").addClass("hidden");
            return;
        }
        $dlg.find(".category-row").removeClass("hidden");
        $select.append(`<option value="0">Любой</option>`);
        for (let category of this.categories) {
            $select.append(`<option value="${category.number}">${category.title}</option>`);
        }
        $select.select2({
            dropdownAutoWidth: true
        }).off("select2:select").on("select2:select", this.updateLinks.bind(this));
    }
    prepareSelectDifficulty($dlg) {
        if (!this.showDifficulty) {
            $dlg.find(".difficulty-row").addClass("hidden");
            return;
        }
        $dlg.find(".difficulty-row").removeClass("hidden");
        $dlg.find(".difficulty-select").select2({
            dropdownAutoWidth: true
        }).off("select2:select").on("select2:select", this.updateLinks.bind(this)).val("").change();
    }
    updateLinks() {
        this.fillAmountUrls();
    }
    fillAmountUrls($dlg) {
        $dlg = $dlg ? $dlg : $("#dialog");
        let category = this.getCategoryQueryPart($dlg);
        let difficulty = this.getDifficultyQueryPart($dlg);
        $dlg.find(".workout-btn-size").each(((idx, el) => {
            const $el = $(el);
            const size = $el.data("size");
            $el.attr("href", `/workout/${this.workoutData.tagName}?size=${size}${category}${difficulty}`);
        }));
    }
    getCategoryQueryPart($dlg) {
        let category = $dlg.find(".category-select").val();
        return Number.parseInt(category) ? `&category=${category}` : "";
    }
    getDifficultyQueryPart($dlg) {
        if (!this.showDifficulty) return "";
        let val = $dlg.find(".difficulty-select").val();
        return val ? `&difficulty=${val}` : "";
    }
    fillTitles($dlg) {
        let labelMain = $dlg.find(".workouts-label-main");
        let labelAmount = $dlg.find(".workouts-label-amount");
        let withSelections = this.categories && this.categories.length > 0;
        let withCheckup = this.workoutData.testId;
        if (!withCheckup && !withSelections) {
            labelMain.text("Выбери количество заданий:");
            labelAmount.addClass("hidden");
        } else if (withCheckup && !withSelections) {
            labelMain.text("Или выбери количество заданий:");
            labelAmount.addClass("hidden");
        } else if (!withCheckup && withSelections) {
            labelMain.text("Выбери:");
            labelAmount.removeClass("hidden");
            labelAmount.text("Количество заданий:");
        } else {
            labelMain.text("Или выбери:");
            labelAmount.removeClass("hidden");
            labelAmount.text("Количество заданий:");
        }
    }
    positionDialog($dlg, $item) {
        const elemOffset = $item.offset();
        const elemWidth = $item.outerWidth();
        const dialogWidth = $dlg.outerWidth();
        const viewportWidth = $(window).width();
        let elCenterX = elemOffset.left + elemWidth / 2;
        let left = 0;
        if (elCenterX - dialogWidth / 2 - 10 < 0) {
            left = -dialogWidth / 2 + elCenterX - 10;
        } else if (elCenterX + dialogWidth / 2 > viewportWidth - 10) {
            left = elCenterX + dialogWidth / 2 - viewportWidth + 10;
        }
        $dlg.dialog("option", "position", {
            my: "center center",
            at: left > 0 ? `center-${left} center` : `center+${-left} center`,
            of: $item[0],
            collision: "fit"
        });
    }
}

class WorkoutsController {
    constructor() {
        $((() => {
            $(".workout-cont").click((function(e) {
                let number = $(this).data("question-number");
                if (number) {
                    new WorkoutTagDialog(number).onClick(this, e);
                    e.preventDefault();
                    return false;
                }
            }));
            $(".achievements.hover-host").click((e => {
                bUtil.fixHoverPosition(e);
                return false;
            })).hover(bUtil.fixHoverPosition);
            $("#dialog").dialog({
                autoOpen: false,
                modal: true,
                closeOnEscape: true,
                width: "auto"
            }).find("a").click((() => {
                $("#dialog").dialog("close");
            }));
        }));
    }
}
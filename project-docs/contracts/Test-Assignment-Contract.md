# Контракт: Назначение тестов

## Метаданные
- **Версия**: 1.0.0
- **Статус**: В разработке
- **Последнее обновление**: 2023-05-23
- **Последний редактор**: AI
- **Ветка разработки**: main

## История изменений
| Дата | Версия | Автор | Описание изменений | PR |
|------|--------|-------|-------------------|-----|
| 2023-05-23 | 1.0.0 | AI | Начальная версия | - |

## Назначение

Данный контракт описывает компонент назначения тестов в системе подготовки к ЕГЭ по русскому языку. Компонент обеспечивает механизмы распределения созданных тестов учащимся или группам учащихся, отслеживания прогресса выполнения и управления сроками прохождения тестов.

## Общее описание компонента

Компонент назначения тестов позволяет преподавателям назначать созданные тесты отдельным ученикам или группам учеников, устанавливать сроки выполнения, отслеживать статус прохождения и получать уведомления о завершении тестов. Учащиеся получают доступ к назначенным им тестам, информацию о сроках и требованиях, а также возможность приступить к выполнению теста в удобное для них время в рамках установленного периода.

## Компоненты системы

### AssignmentManager (Менеджер назначений)

#### Функциональность
- Создание назначения теста
- Редактирование параметров назначения
- Удаление назначения
- Получение списка всех назначений с фильтрацией
- Проверка статуса назначений
- Отправка уведомлений о назначении и сроках выполнения
- Управление доступностью теста

#### Интерфейсы
- **createAssignment**: Создание нового назначения теста
- **updateAssignment**: Обновление существующего назначения
- **deleteAssignment**: Удаление назначения
- **getAssignmentById**: Получение назначения по идентификатору
- **getAssignmentsForTeacher**: Получение списка назначений, созданных учителем
- **getAssignmentsForStudent**: Получение списка назначений для ученика
- **getAssignmentsForGroup**: Получение списка назначений для группы
- **getAssignmentStatus**: Получение статуса выполнения назначения

#### Входные данные
- Информация о назначении (тест, ученики/группы, сроки, настройки)
- Идентификаторы назначений для операций получения, обновления и удаления
- Параметры фильтрации для получения списков назначений

#### Выходные данные
- Созданное или обновленное назначение
- Списки назначений, соответствующих запросу
- Статус операции (успех/ошибка)
- Сообщения об ошибках (если есть)

### AssignmentViewer (Просмотр назначений)

#### Функциональность
- Отображение списка назначенных тестов для ученика
- Фильтрация и сортировка назначений
- Просмотр деталей назначения
- Переход к выполнению теста
- Просмотр результатов выполненных тестов
- Отслеживание сроков выполнения

#### Интерфейсы
- **listAssignments**: Получение списка назначений с фильтрацией
- **getAssignmentDetails**: Получение подробной информации о назначении
- **startTestAttempt**: Начало попытки прохождения теста
- **getAssignmentResults**: Получение результатов выполненного назначения

#### Входные данные
- Идентификатор пользователя
- Параметры фильтрации и сортировки
- Идентификатор назначения для детального просмотра

#### Выходные данные
- Список назначений со статусами
- Детальная информация о назначении
- Ссылка для прохождения теста
- Результаты выполнения (если тест завершен)

### NotificationService (Сервис уведомлений)

#### Функциональность
- Отправка уведомлений о новых назначениях
- Отправка напоминаний о приближающихся сроках
- Уведомление преподавателей о завершении тестов учениками
- Настройка каналов уведомлений (email, push, в системе)

#### Интерфейсы
- **sendAssignmentNotification**: Отправка уведомления о новом назначении
- **sendReminderNotification**: Отправка напоминания о приближающемся сроке
- **sendCompletionNotification**: Уведомление о завершении теста учеником
- **configureNotificationSettings**: Настройка параметров уведомлений

#### Входные данные
- Информация о назначении
- Список получателей
- Тип уведомления
- Канал доставки

#### Выходные данные
- Статус отправки
- Лог отправленных уведомлений

## Схема данных

### Assignment (Назначение)
```typescript
interface Assignment {
  id: string;                  // Уникальный идентификатор назначения
  testId: string;              // Идентификатор теста
  createdBy: string;           // Идентификатор преподавателя, создавшего назначение
  assignedTo: {                // Информация о получателях назначения
    students?: string[];       // Список идентификаторов учеников (если назначено индивидуально)
    groups?: string[];         // Список идентификаторов групп (если назначено группе)
  };
  schedule: {                  // Расписание выполнения
    availableFrom: Date;       // Дата и время начала доступности
    availableUntil: Date;      // Дата и время окончания доступности
    durationMinutes?: number;  // Ограничение по времени выполнения (опционально)
  };
  settings: {                  // Настройки назначения
    attemptsAllowed: number;   // Количество разрешенных попыток
    showResults: boolean;      // Показывать ли результаты после выполнения
    shuffleQuestions: boolean; // Перемешивать ли вопросы
    shuffleOptions: boolean;   // Перемешивать ли варианты ответов
    passingScore?: number;     // Минимальный проходной балл (опционально)
  };
  status: AssignmentStatus;    // Статус назначения
  createdAt: Date;             // Дата и время создания
  updatedAt: Date;             // Дата и время последнего обновления
}

enum AssignmentStatus {
  DRAFT,       // Черновик (не опубликовано)
  SCHEDULED,   // Запланировано (еще не доступно)
  ACTIVE,      // Активно (доступно для выполнения)
  COMPLETED,   // Завершено (срок истек)
  CANCELLED    // Отменено
}
```

### AssignmentAttempt (Попытка выполнения)
```typescript
interface AssignmentAttempt {
  id: string;                  // Уникальный идентификатор попытки
  assignmentId: string;        // Идентификатор назначения
  studentId: string;           // Идентификатор ученика
  startedAt: Date;             // Дата и время начала попытки
  completedAt?: Date;          // Дата и время завершения попытки (если завершена)
  status: AttemptStatus;       // Статус попытки
  score?: number;              // Набранные баллы (если завершена)
  maxScore: number;            // Максимально возможные баллы
  percentage?: number;         // Процент выполнения (если завершена)
  answers: Answer[];           // Ответы на вопросы
  timeSpentSeconds: number;    // Время, затраченное на выполнение
}

enum AttemptStatus {
  IN_PROGRESS,   // В процессе выполнения
  COMPLETED,     // Завершена пользователем
  TIMED_OUT,     // Завершена по истечении времени
  ABANDONED      // Прервана (не завершена)
}

interface Answer {
  questionId: string;          // Идентификатор вопроса
  answerValue: any;            // Ответ пользователя (формат зависит от типа вопроса)
  isCorrect?: boolean;         // Правильность ответа (если проверено)
  score?: number;              // Количество баллов за ответ
  timeSpentSeconds?: number;   // Время, затраченное на ответ
}
```

### AssignmentNotification (Уведомление о назначении)
```typescript
interface AssignmentNotification {
  id: string;                  // Уникальный идентификатор уведомления
  assignmentId: string;        // Идентификатор назначения
  recipientId: string;         // Идентификатор получателя
  type: NotificationType;      // Тип уведомления
  channel: NotificationChannel; // Канал доставки
  content: string;             // Содержание уведомления
  createdAt: Date;             // Дата и время создания
  sentAt?: Date;               // Дата и время отправки (если отправлено)
  readAt?: Date;               // Дата и время прочтения (если прочитано)
  status: NotificationStatus;  // Статус уведомления
}

enum NotificationType {
  NEW_ASSIGNMENT,     // Новое назначение
  REMINDER,           // Напоминание о сроке
  COMPLETION,         // Завершение теста
  GRADE_AVAILABLE     // Результаты доступны
}

enum NotificationChannel {
  EMAIL,     // Электронная почта
  PUSH,      // Push-уведомление
  IN_APP     // Уведомление в приложении
}

enum NotificationStatus {
  PENDING,   // Ожидает отправки
  SENT,      // Отправлено
  DELIVERED, // Доставлено
  READ,      // Прочитано
  FAILED     // Ошибка отправки
}
```

## Алгоритмы и процессы

### Процесс назначения теста
1. Преподаватель выбирает созданный тест для назначения
2. Преподаватель выбирает получателей (отдельных учеников или группы)
3. Преподаватель устанавливает параметры назначения:
   - Период доступности (дата/время начала и окончания)
   - Ограничение по времени выполнения (опционально)
   - Количество разрешенных попыток
   - Настройки отображения результатов
   - Настройки перемешивания вопросов и ответов
4. Система создает назначение со статусом "Черновик"
5. Преподаватель проверяет информацию и подтверждает назначение
6. Система изменяет статус назначения на "Запланировано" или "Активно" (в зависимости от даты начала)
7. Система отправляет уведомления получателям о новом назначении

### Процесс выполнения назначенного теста
1. Ученик входит в систему и видит список назначенных ему тестов
2. Ученик выбирает активное назначение и начинает выполнение
3. Система создает новую попытку и отображает первый вопрос теста
4. Ученик отвечает на вопросы, система сохраняет ответы
5. По завершении всех вопросов или по истечении времени система завершает попытку
6. Система подсчитывает результат и отображает его ученику (если это разрешено настройками)
7. Система уведомляет преподавателя о завершении теста учеником

### Алгоритм управления статусами назначений
1. Система периодически проверяет все назначения
2. Для назначений со статусом "Запланировано", если текущая дата >= даты начала, статус меняется на "Активно"
3. Для назначений со статусом "Активно", если текущая дата > даты окончания, статус меняется на "Завершено"
4. При изменении статуса назначения система отправляет соответствующие уведомления

### Алгоритм отправки напоминаний
1. Система периодически проверяет все активные назначения
2. Для каждого назначения определяется список учеников, еще не выполнивших тест
3. Если до даты окончания доступности остается менее N дней (настраиваемый параметр), система отправляет напоминания
4. Напоминания могут отправляться с разной частотой в зависимости от приближения дедлайна

## Взаимодействие с другими компонентами

### Компонент создания тестов
- Предоставляет информацию о созданных тестах для назначения
- Предоставляет возможность создать назначение непосредственно после создания теста

### Компонент управления пользователями
- Предоставляет информацию о пользователях и группах для назначения тестов
- Обеспечивает проверку прав доступа при операциях с назначениями

### Компонент проведения тестов
- Получает информацию о назначении для отображения теста
- Передает результаты выполнения для обновления статистики назначения

### Компонент аналитики
- Получает данные о назначениях для анализа эффективности обучения
- Предоставляет статистику по выполнению назначений в разрезе учеников, групп, тестов

## Нефункциональные требования

### Производительность
- Время создания назначения: не более 2 секунд
- Время получения списка назначений: не более 1 секунды
- Время начала выполнения теста: не более 3 секунд
- Обработка до 1000 одновременно активных назначений

### Масштабируемость
- Поддержка до 10 000 активных назначений в системе
- Поддержка до 1 000 назначений на одного преподавателя
- Поддержка до 100 одновременно выполняемых тестов

### Надежность
- Сохранение промежуточных ответов при выполнении теста
- Автоматическое восстановление сессии при потере соединения
- Отказоустойчивость при пиковых нагрузках

### Безопасность
- Проверка прав доступа при всех операциях с назначениями
- Защита от несанкционированного доступа к тестам
- Предотвращение мошенничества при выполнении тестов

## Ограничения и допущения
- Максимальное количество учеников в одном назначении: 500
- Максимальное количество групп в одном назначении: 20
- Минимальный период доступности: 1 час
- Максимальный период доступности: 90 дней
- Максимальное количество попыток: 10
- Система не поддерживает назначение разных версий одного теста одному ученику одновременно

## Примеры использования

### Пример 1: Назначение теста группе учеников
```typescript
// Данные для создания назначения
const assignmentData = {
  testId: "test-123",
  createdBy: "teacher-456",
  assignedTo: {
    groups: ["group-789"]
  },
  schedule: {
    availableFrom: new Date("2023-05-25T08:00:00Z"),
    availableUntil: new Date("2023-05-30T20:00:00Z"),
    durationMinutes: 90
  },
  settings: {
    attemptsAllowed: 2,
    showResults: true,
    shuffleQuestions: true,
    shuffleOptions: true,
    passingScore: 70
  }
};

// Создание назначения
const assignmentId = await assignmentManager.createAssignment(assignmentData);

// Публикация назначения
await assignmentManager.updateAssignment(assignmentId, { status: AssignmentStatus.SCHEDULED });
```

### Пример 2: Получение списка назначений для ученика
```typescript
// Получение активных назначений для ученика
const activeAssignments = await assignmentViewer.listAssignments({
  studentId: "student-123",
  status: [AssignmentStatus.ACTIVE],
  sortBy: "availableUntil",
  sortOrder: "asc"
});

// Получение результатов выполненных назначений
const completedAssignments = await assignmentViewer.listAssignments({
  studentId: "student-123",
  hasAttempts: true,
  attemptStatus: [AttemptStatus.COMPLETED, AttemptStatus.TIMED_OUT],
  sortBy: "completedAt",
  sortOrder: "desc"
});
```

## Связанные контракты
- [Test Creation Contract](./Test-Creation-Contract.md)
- [User Management Contract](./User-Management-Contract.md)
- [Question Bank Contract](./Question-Bank-Contract.md)
- [Database Schema Contract](./Database-Schema-Contract.md) 
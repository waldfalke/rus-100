# Руководство по системе Дизайн-Токенов

**Дата:** 2025-05-02

## 1. Введение

Добро пожаловать! Этот документ описывает систему дизайн-токенов, внедренную в данном проекте. Если вы присоединились к команде недавно или не участвовали в процессе внедрения, это руководство поможет вам понять, как работает система стилизации и как с ней взаимодействовать.

**Зачем это было сделано?**

Ранее в проекте существовали проблемы с консистентностью стилей:
*   Дублирование CSS-переменных с разными значениями.
*   Непоследовательное применение отступов, шрифтов, цветов.
*   Сложности с поддержкой и переключением тем (светлая/темная).

**Дизайн-токены** — это централизованный способ управления всеми значениями UI-дизайна (цвета, типографика, отступы, тени, радиусы и т.д.). Они хранятся в виде структурированных данных и используются для генерации CSS-переменных и других форматов.

**Преимущества:**
*   **Консистентность:** Единообразный внешний вид по всему приложению.
*   **Поддержка тем:** Легкое переключение и кастомизация тем.
*   **Масштабируемость:** Упрощение поддержки и внесения изменений в дизайн.
*   **Связь с дизайном:** Возможность синхронизации с дизайн-макетами (в перспективе).

## 2. Структура системы

Система построена на базе **Style Dictionary** и использует трехуровневую иерархию токенов, определения которых хранятся в JSON-файлах в директории `design-system/tokens/`:

1.  **Базовые (Base) токены (`design-system/tokens/base/`)**
    *   Фундаментальные, "сырые" значения: конкретные цвета (палитра `#rrggbb`, `hsl`), размеры шрифтов (`rem`), шаги отступов (`rem`), значения теней и т.д.
    *   Примеры файлов: `colors.json`, `typography.json`, `spacing.json`, `size.json`, `shadow.json`.
    *   Эти значения, как правило, не должны использоваться напрямую в коде компонентов.

2.  **Семантические (Semantic) токены (`design-system/tokens/themes/`)**
    *   Описывают *назначение* или *контекст* использования базовых токенов. Они ссылаются на базовые токены.
    *   Примеры: `цвет фона страницы`, `цвет основного текста`, `цвет границы по умолчанию`, `основной брендовый цвет`, `стиль заголовка H1`.
    *   Определяются отдельно для каждой темы в файлах `light.json` и `dark.json`. Именно эти токены используются для темизации приложения.

3.  **Компонентные (Component) токены (`design-system/tokens/components/`)**
    *   Специфичные значения для конкретных UI-компонентов, которые могут переопределять семантические или базовые токены.
    *   Примеры: `фон кнопки primary в состоянии hover`, `размер иконки в инпуте`, `отступ в шапке карточки`.
    *   Примеры файлов: `button.json`, `card.json`, `dialog.json`.

**Style Dictionary** — это инструмент, который читает все эти JSON-файлы и преобразует их в нужные форматы (в нашем случае, в основном, в CSS-переменные).

## 3. Процесс сборки

При изменении любых JSON-файлов с определениями токенов в `design-system/tokens/`, необходимо **обязательно** запустить скрипт сборки:

```bash
npm run build:tokens
```

Этот скрипт делает следующее:
1.  Запускает Style Dictionary.
2.  Читает все определения токенов (`base`, `themes`, `components`).
3.  Разрешает ссылки (алиасы) между токенами.
4.  Генерирует файлы CSS-переменных для каждой темы:
    *   `styles/tokens.light.css` (переменные для светлой темы, обернуты в `:root { ... }`)
    *   `styles/tokens.dark.css` (переменные для темной темы, обернуты в `.dark { ... }`)
5.  Генерирует файлы TypeScript (`.d.ts`) и JavaScript (`.js`) в `src/tokens/` для возможного использования токенов в коде (менее частый сценарий).

**Важно:** Без запуска `npm run build:tokens` изменения в JSON-файлах не отразятся в приложении!

## 4. Использование токенов в разработке

Существует два основных способа использования сгенерированных токенов:

### 4.1. Основной способ: Через Tailwind CSS (Неявно)

**Это предпочтительный и самый частый способ стилизации.**

Файл конфигурации `tailwind.config.ts` настроен так, чтобы использовать CSS-переменные, сгенерированные Style Dictionary, для определения своей темы.

**Что это значит для вас:**
*   Вы можете (и должны) использовать **стандартные utility-классы Tailwind** для большинства задач стилизации:
    *   **Цвета:** `bg-primary`, `text-secondary`, `border-border`, `text-destructive-foreground`, `hover:bg-accent` и т.д.
    *   **Фон/Текст:** `bg-background`, `text-foreground`, `text-muted-foreground`.
    *   **Компонентные цвета:** `bg-tabs-active`, `text-tabs-active-text`, `bg-progress-track`, `bg-progress-indicator` (специальные классы для компонентных токенов).
    *   **Скругления:** `rounded-md`, `rounded-lg` (используют переменную `--radius`).
    *   **Отступы:** `p-2`, `p-4`, `m-1`, `m-6`, `space-x-4`, `gap-2` (используют стандартную шкалу Tailwind, которая теперь основана на базовых токенах отступов).
    *   **Тени:** `shadow-sm`, `shadow-md`, `shadow-lg`.
*   При использовании этих классов Tailwind автоматически применит правильное значение из CSS-переменной, соответствующей текущей теме (светлой или темной).

**Пример:**
```jsx
// Эта кнопка будет использовать цвет фона из --primary,
// цвет текста из --primary-foreground,
// и радиус скругления из --radius
<Button className="bg-primary text-primary-foreground rounded-md">
  Click Me
</Button>

// Этот div будет использовать цвет фона страницы
<div className="bg-background text-foreground p-4">
  Content
</div>

// Использование компонентных токенов через классы Tailwind
<TabsTrigger
  className="data-[state=active]:bg-tabs-active data-[state=active]:text-tabs-active-text"
>
  Tab
</TabsTrigger>
```

**ВАЖНО:** Избегайте конструкций вида `bg-[var(--primary)]` - они могут работать некорректно в сочетании с data-атрибутами и другими модификаторами. Вместо этого используйте классы, определённые в tailwind.config.ts или переходите к прямому использованию CSS.

### 4.2. Прямое использование CSS-переменных

В редких случаях, когда возможностей Tailwind недостаточно (например, для очень специфичных стилей кастомного компонента или при написании CSS вне Tailwind), вы можете использовать CSS-переменные напрямую.

**Какие переменные доступны:**

1.  **"Плоские" переменные для Tailwind:** Это переменные, сгенерированные специально для `tailwind.config.ts` (например, `--background`, `--foreground`, `--primary`, `--radius`, `--destructive`). Их список и соответствие семантическим токенам задокументированы в контракте `docs/contracts/tokens/TD-FMT-001-TailwindFormatter.md`.
2.  **Иерархические переменные:** Все остальные токены (базовые, семантические, компонентные) доступны по их полным иерархическим именам (например, `--color-primary-500`, `--theme-typography-body-default-font-size`, `--component-button-padding-x`).

**Пример использования в CSS (например, в CSS Modules):**
```css
.my-custom-component {
  /* Использование "плоской" переменной */
  border-color: hsl(var(--border));
  border-radius: var(--radius);

  /* Использование иерархической переменной */
  font-size: var(--theme-typography-body-small-font-size);
  padding-left: var(--spacing-3);
}
```

**Старайтесь минимизировать прямое использование переменных и отдавать предпочтение классам Tailwind.**

### 4.3. Использование в JS/TS

Скрипт сборки также генерирует JS-объекты и TS-типы в `src/tokens/`. Это может быть полезно в редких случаях, когда значения токенов нужны в логике JavaScript (например, для расчетов в Canvas или SVG). В большинстве случаев для стилизации это не требуется.

## 5. Темизация

*   Система поддерживает **светлую** и **темную** темы.
*   Сгенерированные файлы `styles/tokens.light.css` и `styles/tokens.dark.css` содержат соответствующие значения переменных.
*   Переключение тем осуществляется с помощью библиотеки `next-themes` и компонента-провайдера (вероятно, `ThemeProvider` в корне приложения). Он добавляет класс `.dark` к `<html>`, когда активна темная тема, что позволяет применять правильные CSS-переменные.

## 6. Модификация и добавление токенов

При необходимости внести изменения в дизайн-систему:

1.  **Определите уровень токена:**
    *   Изменяете фундаментальное значение (например, основной синий цвет)? -> Редактируйте **базовый** токен (`design-system/tokens/base/colors.json`).
    *   Изменяете назначение цвета (например, цвет фона для карточек)? -> Редактируйте **семантический** токен (`design-system/tokens/themes/light.json` **И** `dark.json`).
    *   Изменяете стиль конкретного компонента? -> Добавьте/отредактируйте **компонентный** токен (`design-system/tokens/components/button.json`).

2.  **Внесите изменения в соответствующий JSON-файл(ы).**
    *   При изменении семантических токенов **обязательно** вносите изменения для **обеих** тем (`light.json` и `dark.json`), чтобы обеспечить консистентность.
    *   Используйте ссылки (алиасы) на базовые токены для семантических и компонентных (`"value": "{color.primary.500}"`).

3.  **Пересоберите токены:**
    ```bash
    npm run build:tokens
    ```

4.  **Проверьте результат** в браузере и Storybook.

## 7. Кастомный форматтер для Tailwind

Для обеспечения совместимости имен токенов с ожиданиями `tailwind.config.ts` используется кастомный форматтер Style Dictionary (`design-system/formatters/css-variables-tailwind.js`). Он преобразует определенные семантические токены (например, `theme.color.primary.default`) в CSS-переменные с плоскими именами (`--primary`).

Подробное описание маппинга и требований к форматтеру находится в контракте `docs/contracts/tokens/TD-FMT-001-TailwindFormatter.md`.

## 8. Отслеживание статуса компонентов (@token-status)

Чтобы понимать, насколько компонент интегрирован с новой системой токенов, в начале `.tsx` файлов компонентов используется специальный комментарий-маркер:

```typescript
// @token-status: [СТАТУС] ([ДЕТАЛИ])
```

*   **СТАТУСЫ:**
    *   `COMPLETED`: Полностью использует токены (неявно через Tailwind или явно).
    *   `PENDING`: Требует рефакторинга для использования токенов.
    *   `NEEDS_REVIEW`: Статус не определен, требуется проверка.
    *   `NA`: Не применимо (хуки, утилиты).
*   **ДЕТАЛИ:** Поясняют статус (например, `(Implicit via Tailwind)`, `(Uses legacy vars)`).

Это помогает быстро оценить состояние компонента. (Маркеры **не** добавляются в `.stories.tsx` файлы).

## 9. Отладка токенов

Для помощи в отладке проблем с применением токенов в проекте используется ряд инструментов:

### 9.1. TokenDebugger

Компонент `TokenDebugger` из `components/debug/TokenDebugger.tsx` позволяет визуализировать все CSS-переменные, доступные в приложении в данный момент. Он показывает имена и значения переменных, а также цветные превью для цветовых переменных.

Добавьте его на страницу для отладки:

```jsx
import { TokenDebugger } from '@/components/debug/TokenDebugger';

// В компоненте страницы или лейауте
<TokenDebugger />
```

Компонент добавит небольшую кнопку в нижней части экрана, которая открывает панель со всеми CSS-переменными.

### 9.2. Component Overrides

В сложных случаях, когда компоненты shadcn/ui или Radix имеют высокую специфичность CSS, которая перекрывает токены, используется файл `styles/component-overrides.css`. Он содержит высокоспецифичные селекторы для переопределения стилей проблемных компонентов.

Если вы столкнулись с проблемой, когда компонент не принимает стили из токенов, проверьте, не нужно ли добавить селектор в этот файл.

**Пример:**
```css
/* Для компонента Tabs */
[role="tablist"] [role="tab"][data-state="active"] {
  background-color: var(--primary) !important;
  color: var(--primary-foreground) !important;
}
```

**Недавние добавления:**
```css
/* TopNavBlock - для обеспечения консистентных отступов и стилей в темной теме */
nav.bg-muted {
  padding: 0.5rem 1rem !important;
  margin-bottom: 2rem !important;
}

html.dark nav.bg-muted {
  background-color: hsl(var(--muted)) !important;
}

html.dark nav.bg-muted .bg-card {
  background-color: hsl(var(--card)) !important;
  color: hsl(var(--card-foreground)) !important;
}
```

## 10. Ключевые файлы и директории

*   `design-system/`: Корень системы токенов и сборки.
    *   `tokens/`: Определения токенов (JSON).
        *   `base/`
        *   `themes/`
        *   `components/`
    *   `formatters/`: Кастомные форматтеры Style Dictionary.
    *   `style-dictionary.config.js`: Конфигурация Style Dictionary.
    *   `build.js`: Скрипт сборки токенов.
*   `styles/tokens.light.css`: Сгенерированные CSS-переменные (светлая тема).
*   `styles/tokens.dark.css`: Сгенерированные CSS-переменные (темная тема).
*   `styles/component-overrides.css`: Высокоспецифичные селекторы для переопределения стилей.
*   `tailwind.config.ts`: Конфигурация Tailwind, использующая сгенерированные переменные.
*   `package.json`: Содержит скрипт `build:tokens`.
*   `docs/contracts/tokens/`: Контракты, связанные с токенами.
*   `docs/design-blog/`: Блог разработки системы.
*   `components/debug/TokenDebugger.tsx`: Компонент для отладки CSS-переменных.

---

Надеемся, это руководство поможет вам комфортно работать с новой системой стилизации. Если у вас возникнут вопросы, обращайтесь к команде! 
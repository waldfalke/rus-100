class TestFolderDTO {}

class EditGroupController {
    constructor() {
        this.initBeforeSubmitCallback();
        this.hideGlobalMessages();
        this.initSelectTestFolders();
        this.initSelectUserFolders();
        this.updateUserAvailableTestFolders();
        const $sel = $("#account-selector");
        if ($sel.length > 0) {
            applyAccountSelector($sel, (acc => acc.canManageUsers));
        }
        new MaterialTextInput($(".name-row")[0]);
        $("#deactivateAndCloneButton").on("click", (e => {
            this.tryDeactivateAndClose();
        }));
        this.handleDelete();
    }
    initBeforeSubmitCallback() {
        $("#form-edit-group").submit((function() {
            if ($("#form-edit-group select#test-lists :selected").length === 0) {
                $("input#clearedTestLists").val(1);
            }
            if ($("#form-edit-group select#userTestFolders :selected").length === 0) {
                $("input#clearedUserTestFolders").val(1);
            }
        }));
    }
    hideGlobalMessages() {
        setTimeout((() => {
            $(".global-message").css("opacity", "0");
            setTimeout((() => {
                $(".global-message").css("display", "none");
            }), 500);
        }), 5e3);
    }
    handleDelete() {
        $(".deleteButton").on("click", (() => {
            let id = Number.parseInt($('input[name="id"]').val());
            let name = $('input[name="name"]').val();
            let onDeleted = function() {
                alert("Группа удалена");
                window.location = "/";
            };
            new DeleteGroupUseCase({
                id: id,
                name: name
            }, onDeleted).showDialog();
        }));
    }
    initSelectTestFolders() {
        $("select#test-lists").select2({
            closeOnSelect: false,
            dropdownAutoWidth: true,
            width: "style"
        });
    }
    initSelectUserFolders() {
        $("select#test-lists").on("change", this.onSelectedFoldersChange.bind(this));
        $("select#userTestFolders").select2({
            closeOnSelect: false,
            dropdownAutoWidth: true,
            width: "style"
        });
    }
    onSelectedFoldersChange() {
        this.updateUserAvailableTestFolders();
    }
    updateUserAvailableTestFolders() {
        let selectedIds = this.getSelectedGroupFolderIds();
        let $items = $("#form-edit-group select#userTestFolders option");
        let existingIds = new Map;
        for (let i = 0; i < $items.length; i++) {
            let $item = $($items[i]);
            let id = Number.parseInt($item.val());
            if (!selectedIds.has(id)) {
                $item.remove();
            } else {
                existingIds.set(id, id);
            }
        }
        let $select = $("select#userTestFolders");
        for (let id of selectedIds.keys()) {
            if (!existingIds.has(id)) {
                let folder = this.getFolder(id);
                if (folder && folder.canSelectToShowInUserMenu) {
                    var newOption = new Option(folder.name, "" + folder.id, false, folder.isShowInUserMenu);
                    $select.append(newOption).trigger("change");
                }
            }
        }
        $select.trigger("change");
    }
    getFolder(id) {
        for (let folder of TEST_FOLDERS) {
            if (folder.id === id) {
                return folder;
            }
        }
    }
    getSelectedGroupFolderIds() {
        let ids = new Map;
        let $items = $("#form-edit-group select#test-lists :selected");
        for (let i = 0; i < $items.length; i++) {
            let id = Number.parseInt($($items[i]).val());
            ids.set(id, id);
        }
        return ids;
    }
    async tryDeactivateAndClose() {
        let dlg = new SimpleYesNoDialog;
        let id = Number.parseInt($('input[name="id"]').val());
        let result = await dlg.showAsync("Деактивировать и клонировать?", `Эта группа будет закрыта и отправлена в архив. Ученики в этой группе станут неактивными.\n         Будет создана новая группа с тем же названием, папками с тестами итд.\n          В новую группу будут скопированы активные ученики этой группы. Выполнить?"`, "Да", "Нет");
        if (!result) return;
        let requestResult = await new DeactivateAndCloneApiRequest(id).exec();
        if (!requestResult) {
            alert("Что-то пошло не так.");
            return;
        }
        result = await dlg.showAsync("Готово", `Сделано. Перейти к новой группе?")`, "Да", "Нет");
        if (result) {
            window.location = "/group/edit/" + requestResult;
        }
    }
}

$((() => {
    new EditGroupController;
}));

class DeleteGroupUseCase extends JsonApiUseCaseWithDialog {
    constructor(group, onDeletedCallback) {
        super("DELETE", "/api/teacher/studentGroup", {
            group: group.id
        });
        this.noRequestBody = true;
        this.onDeletedCallback = onDeletedCallback;
        this.maxWidth = 600;
        let $dialog = this.initDefaultDialog("Удалить группу?", "Удалить");
        let $message = $dialog.find(".dialog-message");
        $message.append(`<p>Если вы хотите сбросить прогресс у всех учеников, нажмите "ОТМЕНА" и напишите Марьям с указанием идентификатора группы: ${group.id}.</p>`);
        $message.append(`<p><br/></p>`);
        $message.append(`<p>Удалить группу "${group.name}"?</p>`);
        this.showDialog();
    }
    async onOkClick() {
        let result;
        try {
            result = await this.exec();
        } catch (error) {
            console.log(error);
            alert("Ошибка: " + JSON.stringify(error));
            return;
        }
        if (this.onDeletedCallback) {
            this.onDeletedCallback.call(undefined);
        }
    }
}

class DeactivateAndCloneApiRequest extends JsonApiReplyUseCase {
    constructor(groupId) {
        super("POST", "/api/teacher/closeAndCloneGroup", {
            groupId: groupId
        });
    }
}
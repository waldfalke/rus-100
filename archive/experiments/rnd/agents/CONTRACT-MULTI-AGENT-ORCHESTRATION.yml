# contracts/CONTRACT-MULTI-AGENT-ORCHESTRATION.yml
# Contract for Multi-Agent Orchestration in Claude Code (Cascade)

id: CONTRACT-MULTI-AGENT-ORCHESTRATION-001
title: "Multi-Agent Orchestration for Claude Code"
type: infrastructure
version: 1.0
created_at: "2025-10-10"
complexity_level: complex  # Emergent coordination patterns, requires experimentation

meta_contract:
  id: "METACONTRACT-001"
  path: "contracts/METACONTRACT.yml"
  version: "1.0"

cynefin_domain: "Complex"

summary: |
  Contract defining multi-agent orchestration architecture for Claude Code (Cascade).
  Describes how to configure independent Cascade sessions as specialized agents
  coordinating through file-based communication. Focus on CONFIGURATION (system prompts,
  file structure, workflow patterns), NOT code implementation.

description: |
  ## Purpose
  
  Enable multiple independent Claude Code (Cascade) sessions to work as coordinated
  specialized agents without shared memory or runtime. Each agent is a separate Cascade
  session with its own system prompt file, communicating through a file-based task queue.
  
  ## Core Concept
  
  - **Agent** = Cascade session + system prompt (.md file)
  - **Agent Creator** = Meta-agent that generates system prompts (NOT code)
  - **Orchestrator** = Supervisor agent that coordinates (does NOT do work itself)
  - **Communication** = File-based task queue (NO Redis, NO message brokers)
  - **Isolation** = Result zones OR git worktrees (NO shared state in memory)
  
  ## Scope
  
  This contract defines:
  - Agent Registry structure (where system prompts live)
  - Task Queue protocol (how agents communicate)
  - Orchestrator responsibilities (coordination only)
  - Worker Agent patterns (specialized execution)
  - Agent Creator specification (prompt generation)
  - File isolation strategies (conflict prevention)
  
  This contract does NOT define:
  - Python/JavaScript implementation code
  - Cascade CLI internal APIs
  - Logging/monitoring infrastructure
  - Specific agent prompts (those are created by Agent Creator)

# --------------------------
# Architecture Components
# --------------------------

architecture:
  agent_registry:
    description: "Directory storing system prompt files for all agent types"
    location: ".agents/registry/"
    structure: |
      .agents/
      ├── registry/
      │   ├── orchestrator.md        # Supervisor agent prompt
      │   ├── contract-steward.md    # Specialized worker prompt
      │   ├── code-artisan.md        # Specialized worker prompt
      │   ├── agent-creator.md       # Meta-agent prompt
      │   └── ...
      └── registry.json              # Agent metadata
    
    registry_json_schema:
      type: "object"
      properties:
        agents:
          type: "object"
          patternProperties:
            "^[a-z-]+$":
              type: "object"
              required: ["system_prompt", "specialization"]
              properties:
                system_prompt:
                  type: "string"
                  description: "Path to .md file (relative to .agents/)"
                specialization:
                  type: "string"
                  description: "What this agent does"
                tools:
                  type: "array"
                  description: "Cascade tools this agent can use"
                context_files:
                  type: "array"
                  description: "Files agent should read for context"
    
    example: |
      {
        "agents": {
          "contract-steward": {
            "system_prompt": "registry/contract-steward.md",
            "specialization": "Creates YAML contracts following METACONTRACT",
            "tools": ["read_file", "write_file"],
            "context_files": ["contracts/METACONTRACT.yml"]
          },
          "orchestrator": {
            "system_prompt": "registry/orchestrator.md",
            "specialization": "Coordinates other agents, does NOT do work itself",
            "tools": ["read_file", "write_file", "list_dir"]
          }
        }
      }

  task_queue:
    description: "File-based queue for agent communication"
    location: ".agents/tasks/"
    structure: |
      .agents/
      ├── tasks/
      │   ├── task-001.json          # Pending task
      │   ├── task-002.json          # Waiting on dependencies
      │   └── ...
      └── results/
          ├── contract-steward/
          │   ├── task-001-result.json
          │   └── CONTRACT-BUTTON.yml
          ├── code-artisan/
          │   └── task-002-result.json
          └── orchestrator/
              └── execution-log.md
    
    task_schema:
      type: "object"
      required: ["id", "agent_type", "status", "input", "created_at"]
      properties:
        id:
          type: "string"
          pattern: "^task-\\d{3}$"
        agent_type:
          type: "string"
          description: "Which agent should process this (from registry.json)"
        status:
          type: "string"
          enum: ["pending", "running", "completed", "failed"]
        input:
          type: "object"
          description: "Task-specific input data"
        depends_on:
          type: "array"
          items: { type: "string" }
          description: "IDs of tasks that must complete first"
        output_path:
          type: "string"
          description: "Where result will be written"
        created_at:
          type: "string"
          format: "date-time"
    
    example: |
      {
        "id": "task-001",
        "agent_type": "contract-steward",
        "status": "pending",
        "input": {
          "component": "Button",
          "requirements": "Primary and secondary variants, disabled state"
        },
        "depends_on": [],
        "output_path": ".agents/results/contract-steward/CONTRACT-BUTTON.yml",
        "created_at": "2025-10-10T21:00:00Z"
      }

  file_isolation:
    description: "How to prevent file conflicts between parallel agents"
    strategies:
      result_zones:
        name: "Result Zones (MVP)"
        description: "Each agent writes to isolated directory in shared workspace"
        complexity: "Low"
        pros:
          - "Simple setup"
          - "No git conflicts (isolated write zones)"
          - "Audit trail (see who created what)"
          - "Works for sequential AND parallel"
        cons:
          - "Agents can read all files (no read isolation)"
          - "No git-level isolation"
        structure: |
          project/
          ├── .git/                    # Shared
          ├── .agents/
          │   ├── tasks/               # Shared read
          │   └── results/             # Isolated write
          │       ├── contract-steward/
          │       ├── code-artisan/
          │       └── orchestrator/
          └── components/              # Final merge destination
        
      git_worktrees:
        name: "Git Worktrees (Advanced)"
        description: "Each agent works in separate git worktree on own branch"
        complexity: "Medium"
        pros:
          - "Full filesystem isolation"
          - "Git-level safety"
          - "True parallel work"
        cons:
          - "Complex setup (requires git worktree commands)"
          - "Merge conflicts possible"
          - "More disk space"
        workflow: |
          1. Orchestrator creates branch per agent:
             git worktree add ../workspace-contract-steward agent-contract
          2. Spawn Cascade in that worktree:
             cascade --cwd=../workspace-contract-steward \
                     --system-prompt=.agents/registry/contract-steward.md
          3. Agent works in isolation
          4. Merge branches when done:
             git merge agent-contract

# --------------------------
# Agent Types
# --------------------------

agent_types:
  orchestrator:
    role: "Supervisor - coordinates other agents"
    responsibilities:
      - "Read user request and decompose into subtasks"
      - "Create task files in .agents/tasks/"
      - "Monitor .agents/results/ for completion"
      - "Aggregate results and report to user"
      - "Handle task dependencies"
      - "Retry failed tasks if needed"
    constraints:
      - "MUST NOT do work itself (no code writing, no contract creation)"
      - "ONLY coordinates other agents"
      - "Sequential execution for MVP (one task at a time)"
    system_prompt_template: |
      # Orchestrator Agent
      
      You are the Orchestrator - you coordinate specialized agents.
      
      ## Your Role
      - Break down user requests into tasks
      - Assign tasks to specialized agents
      - Monitor task completion
      - Aggregate results
      
      ## Your Workflow
      1. Read user request
      2. Decompose into subtasks
      3. Create task files in .agents/tasks/
      4. Monitor .agents/results/ for completions
      5. Aggregate and report to user
      
      ## Your Constraints
      - DO NOT write code yourself
      - DO NOT create contracts yourself
      - ONLY coordinate other agents
      - Sequential execution (one task at a time)
      
      ## Your Tools
      - read_file: Check task status
      - write_file: Create task files
      - list_dir: Monitor results directory
  
  worker:
    role: "Specialized agent - executes specific tasks"
    responsibilities:
      - "Poll .agents/tasks/ for your agent_type"
      - "Read task JSON where agent_type matches your type"
      - "Load context files from registry.json"
      - "Execute specialized work (generate contract, write code, etc)"
      - "Write output to .agents/results/{your-type}/"
      - "Update task status to 'completed' or 'failed'"
    constraints:
      - "ONLY process tasks assigned to your agent_type"
      - "MUST write output to your isolated result zone"
      - "Stateless: each task is independent"
    system_prompt_template: |
      # {Agent Name}
      
      You are {Agent Name} - specialized in {specialization}.
      
      ## Your Workflow
      1. Poll .agents/tasks/ for your agent_type="{your-type}"
      2. Read task-XXX.json
      3. Load context files from registry.json
      4. Execute your specialized work
      5. Write to .agents/results/{your-type}/
      6. Update task status to "completed"
      7. Go back to step 1
      
      ## Your Context
      {list context files}
      
      ## Your Output Format
      {describe expected output}
  
  agent_creator:
    role: "Meta-agent - generates system prompts for new agents"
    responsibilities:
      - "Read requirements for new agent type"
      - "Determine agent specialization"
      - "Generate system prompt .md file"
      - "Update registry.json with new agent metadata"
    constraints:
      - "ONLY creates system prompts (NOT code)"
      - "Follows system prompt template structure"
    output_format: |
      # Agent Name
      
      You are {Agent Name} - {one-line specialization}.
      
      ## Your Role
      {detailed role description}
      
      ## Your Workflow
      1. {step-by-step workflow}
      
      ## Your Constraints
      - {what agent must NOT do}
      
      ## Your Tools
      - {list of Cascade tools}
      
      ## Your Context
      - {files to read for context}
      
      ## Success Criteria
      - {how to verify success}

# --------------------------
# Workflow Patterns
# --------------------------

workflow_patterns:
  sequential:
    description: "Tasks execute one after another"
    use_case: "MVP, simple task chains, dependencies required"
    flow: |
      User Request → Orchestrator decomposes
        → Task 1 (Contract Steward) → Result 1
        → Task 2 (Code Artisan) → Result 2
        → Orchestrator aggregates → User Response
    
    orchestrator_logic: |
      1. Create task-001.json for Contract Steward
      2. Wait for .agents/results/contract-steward/task-001-result.json
      3. Create task-002.json for Code Artisan (depends_on: ["task-001"])
      4. Wait for .agents/results/code-artisan/task-002-result.json
      5. Aggregate results → report to user
  
  parallel:
    description: "Independent tasks execute simultaneously"
    use_case: "No dependencies, faster completion"
    flow: |
      User Request → Orchestrator decomposes
        → Task 1 (Agent A) ──┐
        → Task 2 (Agent B) ──┼→ Wait all → Orchestrator aggregates
        → Task 3 (Agent C) ──┘
    
    requirements:
      - "File isolation strategy (Result Zones OR Git Worktrees)"
      - "Agents must not conflict on same files"
      - "Orchestrator polls all result files"

# --------------------------
# Invariants
# --------------------------

invariants:
  - "Each agent = isolated Cascade session (NO shared memory)"
  - "Agent = System prompt file (.md) + Cascade CLI invocation"
  - "Communication ONLY through files (.agents/tasks/ and .agents/results/)"
  - "Orchestrator NEVER does work itself (only coordinates)"
  - "Agent Creator generates prompts (NOT code)"
  - "Task status tracked in task JSON files"
  - "Result zones prevent write conflicts between agents"
  - "All file paths relative to project root"
  - "No secrets in task files or system prompts"
  - "registry.json is single source of truth for agent types"

# --------------------------
# Constraints
# --------------------------

constraints:
  technical:
    - "File-based communication only (NO Redis, RabbitMQ, etc)"
    - "Each agent runs in separate Cascade session"
    - "System prompts stored as .md files in .agents/registry/"
    - "Task queue uses JSON format"
    - "Result zones use directory-per-agent structure"
  
  performance:
    - "Sequential MVP: one agent active at a time"
    - "Parallel V2: multiple agents active (requires isolation)"
    - "Polling interval: implementation detail (not specified)"
  
  security:
    - "No API keys or secrets in task files"
    - "No secrets in system prompt files"
    - "File paths always relative (never absolute)"

# --------------------------
# Anti-patterns
# --------------------------

anti_patterns:
  - pattern: "Orchestrator writing code or contracts"
    why_bad: "Violates separation of concerns, defeats purpose of specialized agents"
    detection: "Orchestrator system prompt contains code generation instructions"
    fix: "Orchestrator ONLY creates tasks and aggregates results"
  
  - pattern: "Shared memory between agents"
    why_bad: "Violates isolated sessions architecture, creates tight coupling"
    detection: "Agents reading each other's internal state"
    fix: "Communication ONLY through .agents/tasks/ and .agents/results/"
  
  - pattern: "Python/JS orchestration code in CONTRACT"
    why_bad: "CONTRACT describes CONFIGURATION, not implementation code"
    detection: "Python imports or function definitions in CONTRACT"
    fix: "Describe system prompts, file structure, protocols - NOT code"
  
  - pattern: "Agent Creator generating Python/JS code"
    why_bad: "Agent Creator generates PROMPTS, not code"
    detection: "Agent Creator output contains function definitions"
    fix: "Agent Creator outputs .md file with system prompt text"
  
  - pattern: "Agents working in shared workspace without isolation"
    why_bad: "File conflicts guaranteed with parallel execution"
    detection: "Multiple agents writing to same directory"
    fix: "Use Result Zones or Git Worktrees for isolation"

# --------------------------
# Evidence Requirements
# --------------------------

evidence_requirements:
  architectural_decisions:
    - claim: "File-based communication sufficient for agent coordination"
      evidence: "Roo Code Boomerang pattern, AutoGen Sequential Workflow documentation"
      source: "ultra-think-findings.md lines 1125-1206"
    
    - claim: "Result Zones prevent write conflicts"
      evidence: "Each agent writes to isolated directory"
      source: "ultra-think-findings.md lines 1586-1627"
    
    - claim: "Git Worktrees provide full isolation for parallel work"
      evidence: "Git worktree documentation, AI agent parallelization blog posts"
      source: "ultra-think-findings.md lines 1541-1572"
  
  framework_patterns:
    - claim: "Orchestrator should NOT do work itself"
      evidence: "LangGraph Supervisor pattern, Anthropic Orchestrator-Workers"
      source: "ultra-think-findings.md lines 1070-1095"
    
    - claim: "Agent = System Prompt, not code"
      evidence: "Roo Code Modes architecture"
      source: "ultra-think-findings.md lines 623-687"
    
    - claim: "Agent Creator generates prompts, not code"
      evidence: "Roo Code Agent Consultant mode"
      source: "ultra-think-findings.md lines 688-752"

# --------------------------
# Execution Models
# --------------------------

execution_models:
  mvp_manual:
    description: "Manual terminal-based execution for MVP"
    complexity: "Low"
    commands: |
      # Terminal 1: Orchestrator
      cascade chat --system-prompt-file=.agents/registry/orchestrator.md
      
      # Terminal 2: Contract Steward (polling loop)
      while true; do
        cascade chat --system-prompt-file=.agents/registry/contract-steward.md
        sleep 5
      done
      
      # Terminal 3: Code Artisan (polling loop)
      while true; do
        cascade chat --system-prompt-file=.agents/registry/code-artisan.md
        sleep 5
      done
  
  advanced_wrapper:
    description: "Python/Bash wrapper for automated spawning"
    complexity: "Medium"
    note: |
      Wrapper script spawns Cascade processes with appropriate system prompts.
      Implementation NOT specified in CONTRACT (implementation detail).
      
      Wrapper responsibilities:
      - Load registry.json
      - Spawn cascade processes per agent type
      - Monitor task queue
      - Handle process lifecycle
  
  future_native:
    description: "Native Cascade multi-session support"
    complexity: "TBD"
    note: |
      If Cascade adds native multi-session API, adapt architecture.
      Core patterns remain: system prompts, file-based communication, isolation.

# --------------------------
# Acceptance Criteria
# --------------------------

acceptance_criteria:
  - name: "Agent Registry Created"
    description: ".agents/registry/ directory with at least orchestrator.md and one worker agent prompt"
    validation: "automated"
    check: "Directory exists and contains .md files"
  
  - name: "Registry JSON Valid"
    description: ".agents/registry.json validates against schema in this contract"
    validation: "automated"
    check: "JSON schema validation passes"
  
  - name: "Task Queue Structure"
    description: ".agents/tasks/ and .agents/results/ directories exist"
    validation: "automated"
    check: "Directories present"
  
  - name: "Task JSON Schema"
    description: "Task files validate against task_schema in this contract"
    validation: "automated"
    check: "JSON schema validation"
  
  - name: "Orchestrator Does Not Do Work"
    description: "Orchestrator system prompt contains NO code generation instructions"
    validation: "manual"
    check: "Human review of orchestrator.md"
  
  - name: "Agent Creator Generates Prompts"
    description: "Agent Creator outputs .md files, NOT Python/JS code"
    validation: "manual"
    check: "Review Agent Creator output format"
  
  - name: "File Isolation Configured"
    description: "Either Result Zones or Git Worktrees structure in place"
    validation: "manual"
    check: "File structure matches one of the isolation strategies"
  
  - name: "Sequential Workflow Executes"
    description: "Can execute task chain: User → Orchestrator → Worker → Result"
    validation: "integration test"
    check: "End-to-end workflow completes successfully"
  
  - name: "No Hardcoded Secrets"
    description: "No API keys, passwords in task files or system prompts"
    validation: "automated"
    check: "Grep for common secret patterns"
  
  - name: "Human Review Complete"
    description: "Architecture reviewed and approved"
    validation: "manual"
    check: "Reviewer sign-off"

# --------------------------
# Dependencies
# --------------------------

dependencies:
  required:
    - name: "Claude Code (Cascade)"
      version: "Latest"
      purpose: "AI coding assistant providing agent runtime"
    
    - name: "METACONTRACT.yml"
      version: "1.0"
      purpose: "Contract structure rules"
  
  optional:
    - name: "Git"
      version: "2.x+"
      purpose: "Required only if using Git Worktrees isolation strategy"
    
    - name: "jq"
      version: "1.6+"
      purpose: "JSON parsing in bash scripts (optional wrapper)"

# --------------------------
# References
# --------------------------

references:
  research_document: "rnd/agents/ultra-think-findings.md"
  
  framework_patterns:
    - name: "Roo Code Boomerang Tasks"
      concept: "Isolated sessions, modes as system prompts"
      source: "ultra-think-findings.md lines 621-752"
    
    - name: "LangGraph Supervisor"
      concept: "Orchestrator coordinates, workers execute"
      source: "ultra-think-findings.md lines 1023-1121"
    
    - name: "AutoGen Sequential Workflow"
      concept: "Pub/Sub task passing, factory pattern"
      source: "ultra-think-findings.md lines 1125-1206"
    
    - name: "Anthropic Orchestrator-Workers"
      concept: "Supervisor does NOT do work itself"
      source: "Anthropic Building Effective Agents documentation"
  
  git_isolation:
    - name: "Git Worktrees for AI Agents"
      source: "Medium, Blog posts"
      reference: "ultra-think-findings.md lines 1541-1691"

# --------------------------
# Version History
# --------------------------

version_history:
  "1.0":
    date: "2025-10-10"
    changes: "Initial contract based on multi-agent architecture research"
    author: "Cascade Agent"

# End of CONTRACT-MULTI-AGENT-ORCHESTRATION.yml
